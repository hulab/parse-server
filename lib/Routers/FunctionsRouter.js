"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.FunctionsRouter = void 0;

var _PromiseRouter = _interopRequireDefault(require("../PromiseRouter"));

var _middlewares = require("../middlewares");

var _StatusHandler = require("../StatusHandler");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = require("../logger");

var _hulabXraySdk = require("hulab-xray-sdk");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// FunctionsRouter.js
var Parse = require('parse/node').Parse,
    triggers = require('../triggers');

function parseObject(obj) {
  if (Array.isArray(obj)) {
    return obj.map(item => {
      return parseObject(item);
    });
  } else if (obj && obj.__type == 'Date') {
    return Object.assign(new Date(obj.iso), obj);
  } else if (obj && obj.__type == 'File') {
    return Parse.File.fromJSON(obj);
  } else if (obj && typeof obj === 'object') {
    return parseParams(obj);
  } else {
    return obj;
  }
}

function parseParams(params) {
  return _lodash.default.mapValues(params, parseObject);
}

class FunctionsRouter extends _PromiseRouter.default {
  mountRoutes() {
    this.route('POST', '/functions/:functionName', _middlewares.promiseEnsureIdempotency, FunctionsRouter.handleCloudFunction);
    this.route('POST', '/jobs/:jobName', _middlewares.promiseEnsureIdempotency, _middlewares.promiseEnforceMasterKeyAccess, function (req) {
      return FunctionsRouter.handleCloudJob(req);
    });
    this.route('POST', '/jobs', _middlewares.promiseEnforceMasterKeyAccess, function (req) {
      return FunctionsRouter.handleCloudJob(req);
    });
  }

  static handleCloudJob(req) {
    const jobName = req.params.jobName || req.body.jobName;
    const applicationId = req.config.applicationId;
    const jobHandler = (0, _StatusHandler.jobStatusHandler)(req.config);
    const jobFunction = triggers.getJob(jobName, applicationId);

    if (!jobFunction) {
      throw new Parse.Error(Parse.Error.SCRIPT_FAILED, 'Invalid job.');
    }

    let params = Object.assign({}, req.body, req.query);
    params = parseParams(params);
    const request = {
      params: params,
      log: req.config.loggerController,
      headers: req.config.headers,
      ip: req.config.ip,
      jobName,
      message: jobHandler.setMessage.bind(jobHandler)
    };
    return jobHandler.setRunning(jobName, params).then(jobStatus => {
      request.jobId = jobStatus.objectId; // run the function async

      process.nextTick(() => {
        Promise.resolve().then(() => {
          return jobFunction(request);
        }).then(result => {
          jobHandler.setSucceeded(result);
        }, error => {
          jobHandler.setFailed(error);
        });
      });
      return {
        headers: {
          'X-Parse-Job-Status-Id': jobStatus.objectId
        },
        response: {}
      };
    });
  }

  static createResponseObject(resolve, reject) {
    return {
      success: function (result) {
        resolve({
          response: {
            result: Parse._encode(result)
          }
        });
      },
      error: function (message) {
        // parse error, process away
        if (message instanceof Parse.Error) {
          return reject(message);
        }

        let code = Parse.Error.SCRIPT_FAILED; // If it's an error, mark it as a script failed

        if (typeof message === 'string') {
          return reject(new Parse.Error(code, message));
        }

        if (message instanceof Error) {
          message = message.message;
        }

        if (message instanceof Object && Object.prototype.hasOwnProperty.call(message, "code") && Object.prototype.hasOwnProperty.call(message, "message")) {
          code = message.code;
          message = message.message;
        }

        if (message instanceof Object) {
          try {
            message = JSON.stringify(message);
          } catch (_) {//
          }
        }

        reject(new Parse.Error(code, message));
      }
    };
  }

  static handleCloudFunction(req) {
    const functionName = req.params.functionName;
    const applicationId = req.config.applicationId;
    const theFunction = triggers.getFunction(functionName, applicationId);

    if (!theFunction) {
      throw new Parse.Error(Parse.Error.SCRIPT_FAILED, `Invalid function: "${functionName}"`);
    }

    let params = Object.assign({}, req.body, req.query);
    params = parseParams(params);
    const request = {
      params: params,
      master: req.auth && req.auth.isMaster,
      user: req.auth && req.auth.user,
      installationId: req.info.installationId,
      log: req.config.loggerController,
      headers: req.config.headers,
      ip: req.config.ip,
      functionName,
      context: req.info.context
    };

    try {
      const xray_segment = (0, _hulabXraySdk.getSegment)();

      if (xray_segment) {
        xray_segment.setUser(request.user ? request.user.id : undefined);
        xray_segment.addAnnotation("input", _logger.logger.truncateLogMessage(JSON.stringify(params)));
      }
    } catch (_) {//
    }

    return new Promise(function (resolve, reject) {
      const userString = req.auth && req.auth.user ? req.auth.user.id : undefined;

      const cleanInput = _logger.logger.truncateLogMessage(JSON.stringify(params));

      const {
        success,
        error
      } = FunctionsRouter.createResponseObject(result => {
        try {
          const cleanResult = _logger.logger.truncateLogMessage(JSON.stringify(result.response.result));

          _logger.logger.info(`Ran cloud function ${functionName} for user ${userString} with:\n  Input: ${cleanInput}\n  Result: ${cleanResult}`, {
            functionName,
            params,
            user: userString
          });

          resolve(result);
        } catch (e) {
          reject(e);
        }
      }, error => {
        try {
          const xray_segment = (0, _hulabXraySdk.getSegment)();

          if (xray_segment) {
            xray_segment.close(error);
          }

          _logger.logger.error(`Failed running cloud function ${functionName} for user ${userString} with:\n  Input: ${cleanInput}\n  Error: ` + JSON.stringify(error), {
            functionName,
            error,
            params,
            user: userString
          });

          reject(error);
        } catch (e) {
          reject(e);
        }
      });
      return Promise.resolve().then(() => {
        return triggers.maybeRunValidator(request, functionName);
      }).then(() => {
        return theFunction(request);
      }).then(success, error);
    });
  }

}

exports.FunctionsRouter = FunctionsRouter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0Z1bmN0aW9uc1JvdXRlci5qcyJdLCJuYW1lcyI6WyJQYXJzZSIsInJlcXVpcmUiLCJ0cmlnZ2VycyIsInBhcnNlT2JqZWN0Iiwib2JqIiwiQXJyYXkiLCJpc0FycmF5IiwibWFwIiwiaXRlbSIsIl9fdHlwZSIsIk9iamVjdCIsImFzc2lnbiIsIkRhdGUiLCJpc28iLCJGaWxlIiwiZnJvbUpTT04iLCJwYXJzZVBhcmFtcyIsInBhcmFtcyIsIl8iLCJtYXBWYWx1ZXMiLCJGdW5jdGlvbnNSb3V0ZXIiLCJQcm9taXNlUm91dGVyIiwibW91bnRSb3V0ZXMiLCJyb3V0ZSIsInByb21pc2VFbnN1cmVJZGVtcG90ZW5jeSIsImhhbmRsZUNsb3VkRnVuY3Rpb24iLCJwcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcyIsInJlcSIsImhhbmRsZUNsb3VkSm9iIiwiam9iTmFtZSIsImJvZHkiLCJhcHBsaWNhdGlvbklkIiwiY29uZmlnIiwiam9iSGFuZGxlciIsImpvYkZ1bmN0aW9uIiwiZ2V0Sm9iIiwiRXJyb3IiLCJTQ1JJUFRfRkFJTEVEIiwicXVlcnkiLCJyZXF1ZXN0IiwibG9nIiwibG9nZ2VyQ29udHJvbGxlciIsImhlYWRlcnMiLCJpcCIsIm1lc3NhZ2UiLCJzZXRNZXNzYWdlIiwiYmluZCIsInNldFJ1bm5pbmciLCJ0aGVuIiwiam9iU3RhdHVzIiwiam9iSWQiLCJvYmplY3RJZCIsInByb2Nlc3MiLCJuZXh0VGljayIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVzdWx0Iiwic2V0U3VjY2VlZGVkIiwiZXJyb3IiLCJzZXRGYWlsZWQiLCJyZXNwb25zZSIsImNyZWF0ZVJlc3BvbnNlT2JqZWN0IiwicmVqZWN0Iiwic3VjY2VzcyIsIl9lbmNvZGUiLCJjb2RlIiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwiSlNPTiIsInN0cmluZ2lmeSIsImZ1bmN0aW9uTmFtZSIsInRoZUZ1bmN0aW9uIiwiZ2V0RnVuY3Rpb24iLCJtYXN0ZXIiLCJhdXRoIiwiaXNNYXN0ZXIiLCJ1c2VyIiwiaW5zdGFsbGF0aW9uSWQiLCJpbmZvIiwiY29udGV4dCIsInhyYXlfc2VnbWVudCIsInNldFVzZXIiLCJpZCIsInVuZGVmaW5lZCIsImFkZEFubm90YXRpb24iLCJsb2dnZXIiLCJ0cnVuY2F0ZUxvZ01lc3NhZ2UiLCJ1c2VyU3RyaW5nIiwiY2xlYW5JbnB1dCIsImNsZWFuUmVzdWx0IiwiZSIsImNsb3NlIiwibWF5YmVSdW5WYWxpZGF0b3IiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFLQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQVZBO0FBRUEsSUFBSUEsS0FBSyxHQUFHQyxPQUFPLENBQUMsWUFBRCxDQUFQLENBQXNCRCxLQUFsQztBQUFBLElBQ0VFLFFBQVEsR0FBR0QsT0FBTyxDQUFDLGFBQUQsQ0FEcEI7O0FBVUEsU0FBU0UsV0FBVCxDQUFxQkMsR0FBckIsRUFBMEI7QUFDeEIsTUFBSUMsS0FBSyxDQUFDQyxPQUFOLENBQWNGLEdBQWQsQ0FBSixFQUF3QjtBQUN0QixXQUFPQSxHQUFHLENBQUNHLEdBQUosQ0FBUUMsSUFBSSxJQUFJO0FBQ3JCLGFBQU9MLFdBQVcsQ0FBQ0ssSUFBRCxDQUFsQjtBQUNELEtBRk0sQ0FBUDtBQUdELEdBSkQsTUFJTyxJQUFJSixHQUFHLElBQUlBLEdBQUcsQ0FBQ0ssTUFBSixJQUFjLE1BQXpCLEVBQWlDO0FBQ3RDLFdBQU9DLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLElBQUlDLElBQUosQ0FBU1IsR0FBRyxDQUFDUyxHQUFiLENBQWQsRUFBaUNULEdBQWpDLENBQVA7QUFDRCxHQUZNLE1BRUEsSUFBSUEsR0FBRyxJQUFJQSxHQUFHLENBQUNLLE1BQUosSUFBYyxNQUF6QixFQUFpQztBQUN0QyxXQUFPVCxLQUFLLENBQUNjLElBQU4sQ0FBV0MsUUFBWCxDQUFvQlgsR0FBcEIsQ0FBUDtBQUNELEdBRk0sTUFFQSxJQUFJQSxHQUFHLElBQUksT0FBT0EsR0FBUCxLQUFlLFFBQTFC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LHlCQUFPNUIsS0FBUCxDQUNHLGlDQUFnQ2EsWUFBYSxhQUFZaUIsVUFBVyxvQkFBbUJDLFVBQVcsYUFBbkcsR0FDRXBCLElBQUksQ0FBQ0MsU0FBTCxDQUFlWixLQUFmLENBRkosRUFHRTtBQUNFYSxZQUFBQSxZQURGO0FBRUViLFlBQUFBLEtBRkY7QUFHRXpDLFlBQUFBLE1BSEY7QUFJRTRELFlBQUFBLElBQUksRUFBRVc7QUFKUixXQUhGOztBQVVBMUIsVUFBQUEsTUFBTSxDQUFDSixLQUFELENBQU47QUFDRCxTQWhCRCxDQWdCRSxPQUFPaUMsQ0FBUCxFQUFVO0FBQ1Y3QixVQUFBQSxNQUFNLENBQUM2QixDQUFELENBQU47QUFDRDtBQUNGLE9BckN3QixDQUEzQjtBQXVDQSxhQUFPckMsT0FBTyxDQUFDQyxPQUFSLEdBQ0pQLElBREksQ0FDQyxNQUFNO0FBQ1YsZUFBTzlDLFFBQVEsQ0FBQzJGLGlCQUFULENBQTJCdEQsT0FBM0IsRUFBb0NnQyxZQUFwQyxDQUFQO0FBQ0QsT0FISSxFQUlKdkIsSUFKSSxDQUlDLE1BQU07QUFDVixlQUFPd0IsV0FBVyxDQUFDakMsT0FBRCxDQUFsQjtBQUNELE9BTkksRUFPSlMsSUFQSSxDQU9DZSxPQVBELEVBT1VMLEtBUFYsQ0FBUDtBQVFELEtBbERNLENBQVA7QUFtREQ7O0FBaE1nRCIsInNvdXJjZXNDb250ZW50IjpbIi8vIEZ1bmN0aW9uc1JvdXRlci5qc1xuXG52YXIgUGFyc2UgPSByZXF1aXJlKCdwYXJzZS9ub2RlJykuUGFyc2UsXG4gIHRyaWdnZXJzID0gcmVxdWlyZSgnLi4vdHJpZ2dlcnMnKTtcblxuaW1wb3J0IFByb21pc2VSb3V0ZXIgZnJvbSAnLi4vUHJvbWlzZVJvdXRlcic7XG5pbXBvcnQgeyBwcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcywgcHJvbWlzZUVuc3VyZUlkZW1wb3RlbmN5IH0gZnJvbSAnLi4vbWlkZGxld2FyZXMnO1xuaW1wb3J0IHsgam9iU3RhdHVzSGFuZGxlciB9IGZyb20gJy4uL1N0YXR1c0hhbmRsZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQge2dldFNlZ21lbnR9IGZyb20gJ2h1bGFiLXhyYXktc2RrJztcblxuZnVuY3Rpb24gcGFyc2VPYmplY3Qob2JqKSB7XG4gIGlmIChBcnJheS5pc0FycmF5KG9iaikpIHtcbiAgICByZXR1cm4gb2JqLm1hcChpdGVtID0+IHtcbiAgICAgIHJldHVybiBwYXJzZU9iamVjdChpdGVtKTtcbiAgICB9KTtcbiAgfSBlbHNlIGlmIChvYmogJiYgb2JqLl9fdHlwZSA9PSAnRGF0ZScpIHtcbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXcgRGF0ZShvYmouaXNvKSwgb2JqKTtcbiAgfSBlbHNlIGlmIChvYmogJiYgb2JqLl9fdHlwZSA9PSAnRmlsZScpIHtcbiAgICByZXR1cm4gUGFyc2UuRmlsZS5mcm9tSlNPTihvYmopO1xuICB9IGVsc2UgaWYgKG9iaiAmJiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0Jykge1xuICAgIHJldHVybiBwYXJzZVBhcmFtcyhvYmopO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBvYmo7XG4gIH1cbn1cblxuZnVuY3Rpb24gcGFyc2VQYXJhbXMocGFyYW1zKSB7XG4gIHJldHVybiBfLm1hcFZhbHVlcyhwYXJhbXMsIHBhcnNlT2JqZWN0KTtcbn1cblxuZXhwb3J0IGNsYXNzIEZ1bmN0aW9uc1JvdXRlciBleHRlbmRzIFByb21pc2VSb3V0ZXIge1xuICBtb3VudFJvdXRlcygpIHtcbiAgICB0aGlzLnJvdXRlKFxuICAgICAgJ1BPU1QnLFxuICAgICAgJy9mdW5jdGlvbnMvOmZ1bmN0aW9uTmFtZScsXG4gICAgICBwcm9taXNlRW5zdXJlSWRlbXBvdGVuY3ksXG4gICAgICBGdW5jdGlvbnNSb3V0ZXIuaGFuZGxlQ2xvdWRGdW5jdGlvblxuICAgICk7XG4gICAgdGhpcy5yb3V0ZShcbiAgICAgICdQT1NUJyxcbiAgICAgICcvam9icy86am9iTmFtZScsXG4gICAgICBwcm9taXNlRW5zdXJlSWRlbXBvdGVuY3ksXG4gICAgICBwcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcyxcbiAgICAgIGZ1bmN0aW9uIChyZXEpIHtcbiAgICAgICAgcmV0dXJuIEZ1bmN0aW9uc1JvdXRlci5oYW5kbGVDbG91ZEpvYihyZXEpO1xuICAgICAgfVxuICAgICk7XG4gICAgdGhpcy5yb3V0ZSgnUE9TVCcsICcvam9icycsIHByb21pc2VFbmZvcmNlTWFzdGVyS2V5QWNjZXNzLCBmdW5jdGlvbiAocmVxKSB7XG4gICAgICByZXR1cm4gRnVuY3Rpb25zUm91dGVyLmhhbmRsZUNsb3VkSm9iKHJlcSk7XG4gICAgfSk7XG4gIH1cblxuICBzdGF0aWMgaGFuZGxlQ2xvdWRKb2IocmVxKSB7XG4gICAgY29uc3Qgam9iTmFtZSA9IHJlcS5wYXJhbXMuam9iTmFtZSB8fCByZXEuYm9keS5qb2JOYW1lO1xuICAgIGNvbnN0IGFwcGxpY2F0aW9uSWQgPSByZXEuY29uZmlnLmFwcGxpY2F0aW9uSWQ7XG4gICAgY29uc3Qgam9iSGFuZGxlciA9IGpvYlN0YXR1c0hhbmRsZXIocmVxLmNvbmZpZyk7XG4gICAgY29uc3Qgam9iRnVuY3Rpb24gPSB0cmlnZ2Vycy5nZXRKb2Ioam9iTmFtZSwgYXBwbGljYXRpb25JZCk7XG4gICAgaWYgKCFqb2JGdW5jdGlvbikge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLlNDUklQVF9GQUlMRUQsICdJbnZhbGlkIGpvYi4nKTtcbiAgICB9XG4gICAgbGV0IHBhcmFtcyA9IE9iamVjdC5hc3NpZ24oe30sIHJlcS5ib2R5LCByZXEucXVlcnkpO1xuICAgIHBhcmFtcyA9IHBhcnNlUGFyYW1zKHBhcmFtcyk7XG4gICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgIHBhcmFtczogcGFyYW1zLFxuICAgICAgbG9nOiByZXEuY29uZmlnLmxvZ2dlckNvbnRyb2xsZXIsXG4gICAgICBoZWFkZXJzOiByZXEuY29uZmlnLmhlYWRlcnMsXG4gICAgICBpcDogcmVxLmNvbmZpZy5pcCxcbiAgICAgIGpvYk5hbWUsXG4gICAgICBtZXNzYWdlOiBqb2JIYW5kbGVyLnNldE1lc3NhZ2UuYmluZChqb2JIYW5kbGVyKSxcbiAgICB9O1xuXG4gICAgcmV0dXJuIGpvYkhhbmRsZXIuc2V0UnVubmluZyhqb2JOYW1lLCBwYXJhbXMpLnRoZW4oam9iU3RhdHVzID0+IHtcbiAgICAgIHJlcXVlc3Quam9iSWQgPSBqb2JTdGF0dXMub2JqZWN0SWQ7XG4gICAgICAvLyBydW4gdGhlIGZ1bmN0aW9uIGFzeW5jXG4gICAgICBwcm9jZXNzLm5leHRUaWNrKCgpID0+IHtcbiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gam9iRnVuY3Rpb24ocmVxdWVzdCk7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAudGhlbihcbiAgICAgICAgICAgIHJlc3VsdCA9PiB7XG4gICAgICAgICAgICAgIGpvYkhhbmRsZXIuc2V0U3VjY2VlZGVkKHJlc3VsdCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZXJyb3IgPT4ge1xuICAgICAgICAgICAgICBqb2JIYW5kbGVyLnNldEZhaWxlZChlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgKTtcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdYLVBhcnNlLUpvYi1TdGF0dXMtSWQnOiBqb2JTdGF0dXMub2JqZWN0SWQsXG4gICAgICAgIH0sXG4gICAgICAgIHJlc3BvbnNlOiB7fSxcbiAgICAgIH07XG4gICAgfSk7XG4gIH1cblxuICBzdGF0aWMgY3JlYXRlUmVzcG9uc2VPYmplY3QocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIChyZXN1bHQpIHtcbiAgICAgICAgcmVzb2x2ZSh7XG4gICAgICAgICAgcmVzcG9uc2U6IHtcbiAgICAgICAgICAgIHJlc3VsdDogUGFyc2UuX2VuY29kZShyZXN1bHQpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIGVycm9yOiBmdW5jdGlvbiAobWVzc2FnZSkge1xuICAgICAgICAvLyBwYXJzZSBlcnJvciwgcHJvY2VzcyBhd2F5XG4gICAgICAgIGlmIChtZXNzYWdlIGluc3RhbmNlb2YgUGFyc2UuRXJyb3IpIHtcbiAgICAgICAgICByZXR1cm4gcmVqZWN0KG1lc3NhZ2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGNvZGUgPSBQYXJzZS5FcnJvci5TQ1JJUFRfRkFJTEVEO1xuICAgICAgICAvLyBJZiBpdCdzIGFuIGVycm9yLCBtYXJrIGl0IGFzIGEgc2NyaXB0IGZhaWxlZFxuICAgICAgICBpZiAodHlwZW9mIG1lc3NhZ2UgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgcmV0dXJuIHJlamVjdChuZXcgUGFyc2UuRXJyb3IoY29kZSwgbWVzc2FnZSkpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtZXNzYWdlIGluc3RhbmNlb2YgRXJyb3IpIHtcbiAgICAgICAgICBtZXNzYWdlID0gbWVzc2FnZS5tZXNzYWdlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtZXNzYWdlIGluc3RhbmNlb2YgT2JqZWN0XG4gICAgICAgICAgJiYgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsIFwiY29kZVwiKVxuICAgICAgICAgICYmIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChtZXNzYWdlLCBcIm1lc3NhZ2VcIilcbiAgICAgICAgKSB7XG4gICAgICAgICAgY29kZSA9IG1lc3NhZ2UuY29kZTtcbiAgICAgICAgICBtZXNzYWdlID0gbWVzc2FnZS5tZXNzYWdlO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtZXNzYWdlIGluc3RhbmNlb2YgT2JqZWN0KSB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIG1lc3NhZ2UgPSBKU09OLnN0cmluZ2lmeShtZXNzYWdlKTtcbiAgICAgICAgICB9IGNhdGNoIChfKSB7XG4gICAgICAgICAgICAvL1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZWplY3QobmV3IFBhcnNlLkVycm9yKGNvZGUsIG1lc3NhZ2UpKTtcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuICBzdGF0aWMgaGFuZGxlQ2xvdWRGdW5jdGlvbihyZXEpIHtcbiAgICBjb25zdCBmdW5jdGlvbk5hbWUgPSByZXEucGFyYW1zLmZ1bmN0aW9uTmFtZTtcbiAgICBjb25zdCBhcHBsaWNhdGlvbklkID0gcmVxLmNvbmZpZy5hcHBsaWNhdGlvbklkO1xuICAgIGNvbnN0IHRoZUZ1bmN0aW9uID0gdHJpZ2dlcnMuZ2V0RnVuY3Rpb24oZnVuY3Rpb25OYW1lLCBhcHBsaWNhdGlvbklkKTtcblxuICAgIGlmICghdGhlRnVuY3Rpb24pIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5TQ1JJUFRfRkFJTEVELCBgSW52YWxpZCBmdW5jdGlvbjogXCIke2Z1bmN0aW9uTmFtZX1cImApO1xuICAgIH1cbiAgICBsZXQgcGFyYW1zID0gT2JqZWN0LmFzc2lnbih7fSwgcmVxLmJvZHksIHJlcS5xdWVyeSk7XG4gICAgcGFyYW1zID0gcGFyc2VQYXJhbXMocGFyYW1zKTtcbiAgICBjb25zdCByZXF1ZXN0ID0ge1xuICAgICAgcGFyYW1zOiBwYXJhbXMsXG4gICAgICBtYXN0ZXI6IHJlcS5hdXRoICYmIHJlcS5hdXRoLmlzTWFzdGVyLFxuICAgICAgdXNlcjogcmVxLmF1dGggJiYgcmVxLmF1dGgudXNlcixcbiAgICAgIGluc3RhbGxhdGlvbklkOiByZXEuaW5mby5pbnN0YWxsYXRpb25JZCxcbiAgICAgIGxvZzogcmVxLmNvbmZpZy5sb2dnZXJDb250cm9sbGVyLFxuICAgICAgaGVhZGVyczogcmVxLmNvbmZpZy5oZWFkZXJzLFxuICAgICAgaXA6IHJlcS5jb25maWcuaXAsXG4gICAgICBmdW5jdGlvbk5hbWUsXG4gICAgICBjb250ZXh0OiByZXEuaW5mby5jb250ZXh0LFxuICAgIH07XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgeHJheV9zZWdtZW50ID0gZ2V0U2VnbWVudCgpO1xuXG4gICAgICBpZiAoeHJheV9zZWdtZW50KSB7XG4gICAgICAgIHhyYXlfc2VnbWVudC5zZXRVc2VyKHJlcXVlc3QudXNlciA/IHJlcXVlc3QudXNlci5pZCA6IHVuZGVmaW5lZCk7XG4gICAgICAgIHhyYXlfc2VnbWVudC5hZGRBbm5vdGF0aW9uKFwiaW5wdXRcIiwgbG9nZ2VyLnRydW5jYXRlTG9nTWVzc2FnZShKU09OLnN0cmluZ2lmeShwYXJhbXMpKSk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoXykge1xuICAgICAgLy9cbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgY29uc3QgdXNlclN0cmluZyA9IHJlcS5hdXRoICYmIHJlcS5hdXRoLnVzZXIgPyByZXEuYXV0aC51c2VyLmlkIDogdW5kZWZpbmVkO1xuICAgICAgY29uc3QgY2xlYW5JbnB1dCA9IGxvZ2dlci50cnVuY2F0ZUxvZ01lc3NhZ2UoSlNPTi5zdHJpbmdpZnkocGFyYW1zKSk7XG4gICAgICBjb25zdCB7IHN1Y2Nlc3MsIGVycm9yIH0gPSBGdW5jdGlvbnNSb3V0ZXIuY3JlYXRlUmVzcG9uc2VPYmplY3QoXG4gICAgICAgIHJlc3VsdCA9PiB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGNsZWFuUmVzdWx0ID0gbG9nZ2VyLnRydW5jYXRlTG9nTWVzc2FnZShKU09OLnN0cmluZ2lmeShyZXN1bHQucmVzcG9uc2UucmVzdWx0KSk7XG4gICAgICAgICAgICBsb2dnZXIuaW5mbyhcbiAgICAgICAgICAgICAgYFJhbiBjbG91ZCBmdW5jdGlvbiAke2Z1bmN0aW9uTmFtZX0gZm9yIHVzZXIgJHt1c2VyU3RyaW5nfSB3aXRoOlxcbiAgSW5wdXQ6ICR7Y2xlYW5JbnB1dH1cXG4gIFJlc3VsdDogJHtjbGVhblJlc3VsdH1gLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZnVuY3Rpb25OYW1lLFxuICAgICAgICAgICAgICAgIHBhcmFtcyxcbiAgICAgICAgICAgICAgICB1c2VyOiB1c2VyU3RyaW5nLFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgeHJheV9zZWdtZW50ID0gZ2V0U2VnbWVudCgpO1xuICAgICAgICAgICAgaWYgKHhyYXlfc2VnbWVudCkge1xuICAgICAgICAgICAgICB4cmF5X3NlZ21lbnQuY2xvc2UoZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgbG9nZ2VyLmVycm9yKFxuICAgICAgICAgICAgICBgRmFpbGVkIHJ1bm5pbmcgY2xvdWQgZnVuY3Rpb24gJHtmdW5jdGlvbk5hbWV9IGZvciB1c2VyICR7dXNlclN0cmluZ30gd2l0aDpcXG4gIElucHV0OiAke2NsZWFuSW5wdXR9XFxuICBFcnJvcjogYCArXG4gICAgICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoZXJyb3IpLFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZnVuY3Rpb25OYW1lLFxuICAgICAgICAgICAgICAgIGVycm9yLFxuICAgICAgICAgICAgICAgIHBhcmFtcyxcbiAgICAgICAgICAgICAgICB1c2VyOiB1c2VyU3RyaW5nLFxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpXG4gICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICByZXR1cm4gdHJpZ2dlcnMubWF5YmVSdW5WYWxpZGF0b3IocmVxdWVzdCwgZnVuY3Rpb25OYW1lKTtcbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIHJldHVybiB0aGVGdW5jdGlvbihyZXF1ZXN0KTtcbiAgICAgICAgfSlcbiAgICAgICAgLnRoZW4oc3VjY2VzcywgZXJyb3IpO1xuICAgIH0pO1xuICB9XG59XG4iXX0=