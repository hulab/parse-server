"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.FunctionsRouter = void 0;

var _PromiseRouter = _interopRequireDefault(require("../PromiseRouter"));

var _middlewares = require("../middlewares");

var _StatusHandler = require("../StatusHandler");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = require("../logger");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// FunctionsRouter.js
var Parse = require('parse/node').Parse,
    triggers = require('../triggers');

function parseObject(obj) {
  if (Array.isArray(obj)) {
    return obj.map(item => {
      return parseObject(item);
    });
  } else if (obj && obj.__type == 'Date') {
    return Object.assign(new Date(obj.iso), obj);
  } else if (obj && obj.__type == 'File') {
    return Parse.File.fromJSON(obj);
  } else if (obj && typeof obj === 'object') {
    return parseParams(obj);
  } else {
    return obj;
  }
}

function parseParams(params) {
  return _lodash.default.mapValues(params, parseObject);
}

class FunctionsRouter extends _PromiseRouter.default {
  mountRoutes() {
    this.route('POST', '/functions/:functionName', FunctionsRouter.handleCloudFunction);
    this.route('POST', '/jobs/:jobName', _middlewares.promiseEnforceMasterKeyAccess, function (req) {
      return FunctionsRouter.handleCloudJob(req);
    });
    this.route('POST', '/jobs', _middlewares.promiseEnforceMasterKeyAccess, function (req) {
      return FunctionsRouter.handleCloudJob(req);
    });
  }

  static handleCloudJob(req) {
    const jobName = req.params.jobName || req.body.jobName;
    const applicationId = req.config.applicationId;
    const jobHandler = (0, _StatusHandler.jobStatusHandler)(req.config);
    const jobFunction = triggers.getJob(jobName, applicationId);

    if (!jobFunction) {
      throw new Parse.Error(Parse.Error.SCRIPT_FAILED, 'Invalid job.');
    }

    let params = Object.assign({}, req.body, req.query);
    params = parseParams(params);
    const request = {
      params: params,
      log: req.config.loggerController,
      headers: req.config.headers,
      ip: req.config.ip,
      jobName,
      message: jobHandler.setMessage.bind(jobHandler)
    };
    return jobHandler.setRunning(jobName, params).then(jobStatus => {
      request.jobId = jobStatus.objectId; // run the function async

      process.nextTick(() => {
        Promise.resolve().then(() => {
          return jobFunction(request);
        }).then(result => {
          jobHandler.setSucceeded(result);
        }, error => {
          jobHandler.setFailed(error);
        });
      });
      return {
        headers: {
          'X-Parse-Job-Status-Id': jobStatus.objectId
        },
        response: {}
      };
    });
  }

  static createResponseObject(resolve, reject, message) {
    return {
      success: function (result) {
        resolve({
          response: {
            result: Parse._encode(result)
          }
        });
      },
      error: function (message) {
        // parse error, process away
        if (message instanceof Parse.Error) {
          return reject(message);
        }

        let code = Parse.Error.SCRIPT_FAILED; // If it's an error, mark it as a script failed

        if (typeof message === 'string') {
          return reject(new Parse.Error(code, message));
        }

        if (message instanceof Error) {
          message = message.message;
        }

        if (message instanceof Object && Object.prototype.hasOwnProperty.call(message, "code") && Object.prototype.hasOwnProperty.call(message, "message")) {
          code = message.code;
          message = message.message;
        }

        if (message instanceof Object) {
          try {
            message = JSON.stringify(message);
          } catch (_) {//
          }
        }

        reject(new Parse.Error(code, message));
      },
      message: message
    };
  }

  static handleCloudFunction(req) {
    const functionName = req.params.functionName;
    const applicationId = req.config.applicationId;
    const theFunction = triggers.getFunction(functionName, applicationId);
    const theValidator = triggers.getValidator(req.params.functionName, applicationId);

    if (!theFunction) {
      throw new Parse.Error(Parse.Error.SCRIPT_FAILED, `Invalid function: "${functionName}"`);
    }

    let params = Object.assign({}, req.body, req.query);
    params = parseParams(params);
    const request = {
      params: params,
      master: req.auth && req.auth.isMaster,
      user: req.auth && req.auth.user,
      installationId: req.info.installationId,
      log: req.config.loggerController,
      headers: req.config.headers,
      ip: req.config.ip,
      functionName
    };

    if (theValidator && typeof theValidator === 'function') {
      var result = theValidator(request);

      if (!result) {
        throw new Parse.Error(Parse.Error.VALIDATION_ERROR, 'Validation failed.');
      }
    }

    return new Promise(function (resolve, reject) {
      const userString = req.auth && req.auth.user ? req.auth.user.id : undefined;

      const cleanInput = _logger.logger.truncateLogMessage(JSON.stringify(params));

      const {
        success,
        error,
        message
      } = FunctionsRouter.createResponseObject(result => {
        try {
          const cleanResult = _logger.logger.truncateLogMessage(JSON.stringify(result.response.result));

          _logger.logger.info(`Ran cloud function ${functionName} for user ${userString} with:\n  Input: ${cleanInput}\n  Result: ${cleanResult}`, {
            functionName,
            params,
            user: userString
          });

          resolve(result);
        } catch (e) {
          reject(e);
        }
      }, error => {
        try {
          _logger.logger.error(`Failed running cloud function ${functionName} for user ${userString} with:\n  Input: ${cleanInput}\n  Error: ` + JSON.stringify(error), {
            functionName,
            error,
            params,
            user: userString
          });

          reject(error);
        } catch (e) {
          reject(e);
        }
      });
      return Promise.resolve().then(() => {
        return theFunction(request, {
          message
        });
      }).then(success, error);
    });
  }

}

exports.FunctionsRouter = FunctionsRouter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0Z1bmN0aW9uc1JvdXRlci5qcyJdLCJuYW1lcyI6WyJQYXJzZSIsInJlcXVpcmUiLCJ0cmlnZ2VycyIsInBhcnNlT2JqZWN0Iiwib2JqIiwiQXJyYXkiLCJpc0FycmF5IiwibWFwIiwiaXRlbSIsIl9fdHlwZSIsIk9iamVjdCIsImFzc2lnbiIsIkRhdGUiLCJpc28iLCJGaWxlIiwiZnJvbUpTT04iLCJwYXJzZVBhcmFtcyIsInBhcmFtcyIsIl8iLCJtYXBWYWx1ZXMiLCJGdW5jdGlvbnNSb3V0ZXIiLCJQcm9taXNlUm91dGVyIiwibW91bnRSb3V0ZXMiLCJyb3V0ZSIsImhhbmRsZUNsb3VkRnVuY3Rpb24iLCJwcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcyIsInJlcSIsImhhbmRsZUNsb3VkSm9iIiwiam9iTmFtZSIsImJvZHkiLCJhcHBsaWNhdGlvbklkIiwiY29uZmlnIiwiam9iSGFuZGxlciIsImpvYkZ1bmN0aW9uIiwiZ2V0Sm9iIiwiRXJyb3IiLCJTQ1JJUFRfRkFJTEVEIiwicXVlcnkiLCJyZXF1ZXN0IiwibG9nIiwibG9nZ2VyQ29udHJvbGxlciIsImhlYWRlcnMiLCJpcCIsIm1lc3NhZ2UiLCJzZXRNZXNzYWdlIiwiYmluZCIsInNldFJ1bm5pbmciLCJ0aGVuIiwiam9iU3RhdHVzIiwiam9iSWQiLCJvYmplY3RJZCIsInByb2Nlc3MiLCJuZXh0VGljayIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVzdWx0Iiwic2V0U3VjY2VlZGVkIiwiZXJyb3IiLCJzZXRGYWlsZWQiLCJyZXNwb25zZSIsImNyZWF0ZVJlc3BvbnNlT2JqZWN0IiwicmVqZWN0Iiwic3VjY2VzcyIsIl9lbmNvZGUiLCJjb2RlIiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwiSlNPTiIsInN0cmluZ2lmeSIsImZ1bmN0aW9uTmFtZSIsInRoZUZ1bmN0aW9uIiwiZ2V0RnVuY3Rpb24iLCJ0aGVWYWxpZGF0b3IiLCJnZXRWYWxpZGF0b3IiLCJtYXN0ZXIiLCJhdXRoIiwiaXNNYXN0ZXIiLCJ1c2VyIiwiaW5zdGFsbGF0aW9uSWQiLCJpbmZvIiwiVkFMSURBVElPTl9FUlJPUiIsInVzZXJTdHJpbmciLCJpZCIsInVuZGVmaW5lZCIsImNsZWFuSW5wdXQiLCJsb2dnZXIiLCJ0cnVuY2F0ZUxvZ01lc3NhZ2UiLCJjbGVhblJlc3VsdCIsImUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFLQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7OztBQVRBO0FBRUEsSUFBSUEsS0FBSyxHQUFHQyxPQUFPLENBQUMsWUFBRCxDQUFQLENBQXNCRCxLQUFsQztBQUFBLElBQ0VFLFFBQVEsR0FBR0QsT0FBTyxDQUFDLGFBQUQsQ0FEcEI7O0FBU0EsU0FBU0UsV0FBVCxDQUFxQkMsR0FBckIsRUFBMEI7QUFDeEIsTUFBSUMsS0FBSyxDQUFDQyxPQUFOLENBQWNGLEdBQWQsQ0FBSixFQUF3QjtBQUN0QixXQUFPQSxHQUFHLENBQUNHLEdBQUosQ0FBUUMsSUFBSSxJQUFJO0FBQ3JCLGFBQU9MLFdBQVcsQ0FBQ0ssSUFBRCxDQUFsQjtBQUNELEtBRk0sQ0FBUDtBQUdELEdBSkQsTUFJTyxJQUFJSixHQUFHLElBQUlBLEdBQUcsQ0FBQ0ssTUFBSixJQUFjLE1BQXpCLEVBQWlDO0FBQ3RDLFdBQU9DLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLElBQUlDLElBQUosQ0FBU1IsR0FBRyxDQUFDUyxHQUFiLENBQWQsRUFBaUNULEdBQWpDLENBQVA7QUFDRCxHQUZNLE1BRUEsSUFBSUEsR0FBRyxJQUFJQSxHQUFHLENBQUNLLE1BQUosSUFBYyxNQUF6QixFQUFpQztBQUN0QyxXQUFPVCxLQUFLLENBQUNjLElBQU4sQ0FBV0MsUUFBWCxDQUFvQlgsR0FBcEIsQ0FBUDtBQUNELEdBRk0sTUFFQSxJQUFJQSxHQUFHLElBQUksT0FBT0EsR0FBUCxLQUFlLFFBQTFCLEVBQW9DO0FBQ3pDLFdBQU9ZLFdBQVcsQ0FBQ1osR0FBRCxDQUFsQjtBQUNELEdBRk0sTUFFQTtBQUNMLFdBQU9BLEdBQVA7QUFDRDtBQUNGOztBQUVELFNBQVNZLFdBQVQsQ0FBcUJDLE1BQXJCLEVBQTZCO0FBQzNCLFNBQU9DLGdCQUFFQyxTQUFGLENBQVlGLE1BQVosRUFBb0JkLFdBQXBCLENBQVA7QUFDRDs7QUFFTSxNQUFNaUIsZUFBTixTQUE4QkMsc0JBQTlCLENBQTRDO0FBQ2pEQyxFQUFBQSxXQUFXLEdBQUc7QUFDWixTQUFLQyxLQUFMLENBQ0UsTUFERixFQUVFLDBCQUZGLEVBR0VILGVBQWUsQ0FBQ0ksbUJBSGxCO0FBS0EsU0FBS0QsS0FBTCxDQUNFLE1BREYsRUFFRSxnQkFGRixFQUdFRSwwQ0FIRixFQUlFLFVBQVNDLEdBQVQsRUFBYztBQUNaLGFBQU9OLGVBQWUsQ0FBQ08sY0FBaEIsQ0FBK0JELEdBQS9CLENBQVA7QUFDRCxLQU5IO0FBUUEsU0FBS0gsS0FBTCxDQUFXLE1BQVgsRUFBbUIsT0FBbkIsRUFBNEJFLDBDQUE1QixFQUEyRCxVQUFTQyxHQUFULEVBQWM7QUFDdkUsYUFBT04sZUFBZSxDQUFDTyxjQUFoQixDQUErQkQsR0FBL0IsQ0FBUDtBQUNELEtBRkQ7QUFHRDs7QUFFRCxTQUFPQyxjQUFQLENBQXNCRCxHQUF0QixFQUEyQjtBQUN6QixVQUFNRSxPQUFPLEdBQUdGLEdBQUcsQ0FBQ1QsTUFBSixDQUFXVyxPQUFYLElBQXNCRixHQUFHLENBQUNHLElBQUosQ0FBU0QsT0FBL0M7QUFDQSxVQUFNRSxhQUFhLEdBQUdKLEdBQUcsQ0FBQ0ssTUFBSixDQUFXRCxhQUFqQztBQUNBLFVBQU1FLFVBQVUsR0FBRyxxQ0FBaUJOLEdBQUcsQ0FBQ0ssTUFBckIsQ0FBbkI7QUFDQSxVQUFNRSxXQUFXLEdBQUcvQixRQUFRLENBQUNnQyxNQUFULENBQWdCTixPQUFoQixFQUF5QkUsYUFBekIsQ0FBcEI7O0FBQ0EsUUFBSSxDQUFDRyxXQUFMLEVBQWtCO0FBQ2hCLFlBQU0sSUFBSWpDLEtBQUssQ0FBQ21DLEtBQVYsQ0FBZ0JuQyxLQUFLLENBQUNtQyxLQUFOLENBQVlDLGFBQTVCLEVBQTJDLGNBQTNDLENBQU47QUFDRDs7QUFDRCxRQUFJbkIsTUFBTSxHQUFHUCxNQUFNLENBQUNDLE1BQVAsQ0FBYyxFQUFkLEVBQWtCZSxHQUFHLENBQUNHLElBQXRCLEVBQTRCSCxHQUFHLENBQUNXLEtBQWhDLENBQWI7QUFDQXBCLElBQUFBLE1BQU0sR0FBR0QsV0FBVyxDQUFDQyxNQUFELENBQXBCO0FBQ0EsVUFBTXFCLE9BQU8sR0FBRztBQUNkckIsTUFBQUEsTUFBTSxFQUFFQSxNQURNO0FBRWRzQixNQUFBQSxHQUFHLEVBQUViLEdBQUcsQ0FBQ0ssTUFBSixDQUFXUyxnQkFGRjtBQUdkQyxNQUFBQSxPQUFPLEVBQUVmLEdBQUcsQ0FBQ0ssTUFBSixDQUFXVSxPQUhOO0FBSWRDLE1BQUFBLEVBQUUsRUFBRWhCLEdBQUcsQ0FBQ0ssTUFBSixDQUFXVyxFQUpEO0FBS2RkLE1BQUFBLE9BTGM7QUFNZGUsTUFBQUEsT0FBTyxFQUFFWCxVQUFVLENBQUNZLFVBQVgsQ0FBc0JDLElBQXRCLENBQTJCYixVQUEzQjtBQU5LLEtBQWhCO0FBU0EsV0FBT0EsVUFBVSxDQUFDYyxVQUFYLENBQXNCbEIsT0FBdEIsRUFBK0JYLE1BQS9CLEVBQXVDOEIsSUFBdkMsQ0FBNENDLFNBQVMsSUFBSTtBQUM5RFYsTUFBQUEsT0FBTyxDQUFDVyxLQUFSLEdBQWdCRCxTQUFTLENBQUNFLFFBQTFCLENBRDhELENBRTlEOztBQUNBQyxNQUFBQSxPQUFPLENBQUNDLFFBQVIsQ0FBaUIsTUFBTTtBQUNyQkMsUUFBQUEsT0FBTyxDQUFDQyxPQUFSLEdBQ0dQLElBREgsQ0FDUSxNQUFNO0FBQ1YsaUJBQU9kLFdBQVcsQ0FBQ0ssT0FBRCxDQUFsQjtBQUNELFNBSEgsRUFJR1MsSUFKSCxDQUtJUSxNQUFNLElBQUk7QUFDUnZCLFVBQUFBLFVBQVUsQ0FBQ3dCLFlBQVgsQ0FBd0JELE1BQXhCO0FBQ0QsU0FQTCxFQVFJRSxLQUFLLElBQUk7QUFDUHpCLFVBQUFBLFVBQVUsQ0FBQzBCLFNBQVgsQ0FBcUJELEtBQXJCO0FBQ0QsU0FWTDtBQVlELE9BYkQ7QUFjQSxhQUFPO0FBQ0xoQixRQUFBQSxPQUFPLEVBQUU7QUFDUCxtQ0FBeUJPLFNBQVMsQ0FBQ0U7QUFENUIsU0FESjtBQUlMUyxRQUFBQSxRQUFRLEVBQUU7QUFKTCxPQUFQO0FBTUQsS0F2Qk0sQ0FBUDtBQXdCRDs7QUFFRCxTQUFPQyxvQkFBUCxDQUE0Qk4sT0FBNUIsRUFBcUNPLE1BQXJDLEVBQTZDbEIsT0FBN0MsRUFBc0Q7QUFDcEQsV0FBTztBQUNMbUIsTUFBQUEsT0FBTyxFQUFFLFVBQVNQLE1BQVQsRUFBaUI7QUFDeEJELFFBQUFBLE9BQU8sQ0FBQztBQUNOSyxVQUFBQSxRQUFRLEVBQUU7QUFDUkosWUFBQUEsTUFBTSxFQUFFdkQsS0FBSyxDQUFDK0QsT0FBTixDQUFjUixNQUFkO0FBREE7QUFESixTQUFELENBQVA7QUFLRCxPQVBJO0FBUUxFLE1BQUFBLEtBQUssRUFBRSxVQUFTZCxPQUFULEVBQWtCO0FBQ3ZCO0FBQ0EsWUFBSUEsT0FBTyxZQUFZM0MsS0FBSyxDQUFDbUMsS0FBN0IsRUFBb0M7QUFDbEMsaUJBQU8wQixNQUFNLENBQUNsQixPQUFELENBQWI7QUFDRDs7QUFFRCxZQUFJcUIsSUFBSSxHQUFHaEUsS0FBSyxDQUFDbUMsS0FBTixDQUFZQyxhQUF2QixDQU51QixDQU92Qjs7QUFDQSxZQUFJLE9BQU9PLE9BQVAsS0FBbUIsUUFBdkIsRUFBaUM7QUFDL0IsaUJBQU9rQixNQUFNLENBQUMsSUFBSTdELEtBQUssQ0FBQ21DLEtBQVYsQ0FBZ0I2QixJQUFoQixFQUFzQnJCLE9BQXRCLENBQUQsQ0FBYjtBQUNEOztBQUNELFlBQUlBLE9BQU8sWUFBWVIsS0FBdkIsRUFBOEI7QUFDNUJRLFVBQUFBLE9BQU8sR0FBR0EsT0FBTyxDQUFDQSxPQUFsQjtBQUNEOztBQUNELFlBQUlBLE9BQU8sWUFBWWpDLE1BQW5CLElBQ0NBLE1BQU0sQ0FBQ3VELFNBQVAsQ0FBaUJDLGNBQWpCLENBQWdDQyxJQUFoQyxDQUFxQ3hCLE9BQXJDLEVBQThDLE1BQTlDLENBREQsSUFFQ2pDLE1BQU0sQ0FBQ3VELFNBQVAsQ0FBaUJDLGNBQWpCLENBQWdDQyxJQUFoQyxDQUFxQ3hCLE9BQXJDLEVBQThDLFNBQTlDLENBRkwsRUFHRTtBQUNBcUIsVUFBQUEsSUFBSSxHQUFHckIsT0FBTyxDQUFDcUIsSUFBZjtBQUNBckIsVUFBQUEsT0FBTyxHQUFHQSxPQUFPLENBQUNBLE9BQWxCO0FBQ0Q7O0FBQ0QsWUFBSUEsT0FBTyxZQUFZakMsTUFBdkIsRUFBK0I7QUFDN0IsY0FBSTtBQUNGaUMsWUFBQUEsT0FBTyxHQUFHeUIsSUFBSSxDQUFDQyxTQUFMLENBQWUxQixPQUFmLENBQVY7QUFDRCxXQUZELENBRUUsT0FBT3pCLENBQVAsRUFBVSxDQUNWO0FBQ0Q7QUFDRjs7QUFDRDJDLFFBQUFBLE1BQU0sQ0FBQyxJQUFJN0QsS0FBSyxDQUFDbUMsS0FBVixDQUFnQjZCLElBQWhCLEVBQXNCckIsT0FBdEIsQ0FBRCxDQUFOO0FBQ0QsT0FyQ0k7QUFzQ0xBLE1BQUFBLE9BQU8sRUFBRUE7QUF0Q0osS0FBUDtBQXdDRDs7QUFFRCxTQUFPbkIsbUJBQVAsQ0FBMkJFLEdBQTNCLEVBQWdDO0FBQzlCLFVBQU00QyxZQUFZLEdBQUc1QyxHQUFHLENBQUNULE1BQUosQ0FBV3FELFlBQWhDO0FBQ0EsVUFBTXhDLGFBQWEsR0FBR0osR0FBRyxDQUFDSyxNQUFKLENBQVdELGFBQWpDO0FBQ0EsVUFBTXlDLFdBQVcsR0FBR3JFLFFBQVEsQ0FBQ3NFLFdBQVQsQ0FBcUJGLFlBQXJCLEVBQW1DeEMsYUFBbkMsQ0FBcEI7QUFDQSxVQUFNMkMsWUFBWSxHQUFHdkUsUUFBUSxDQUFDd0UsWUFBVCxDQUNuQmhELEdBQUcsQ0FBQ1QsTUFBSixDQUFXcUQsWUFEUSxFQUVuQnhDLGFBRm1CLENBQXJCOztBQUlBLFFBQUksQ0FBQ3lDLFdBQUwsRUFBa0I7QUFDaEIsWUFBTSxJQUFJdkUsS0FBSyxDQUFDbUMsS0FBVixDQUNKbkMsS0FBSyxDQUFDbUMsS0FBTixDQUFZQyxhQURSLEVBRUgsc0JBQXFCa0MsWUFBYSxHQUYvQixDQUFOO0FBSUQ7O0FBQ0QsUUFBSXJELE1BQU0sR0FBR1AsTUFBTSxDQUFDQyxNQUFQLENBQWMsRUFBZCxFQUFrQmUsR0FBRyxDQUFDRyxJQUF0QixFQUE0QkgsR0FBRyxDQUFDVyxLQUFoQyxDQUFiO0FBQ0FwQixJQUFBQSxNQUFNLEdBQUdELFdBQVcsQ0FBQ0MsTUFBRCxDQUFwQjtBQUNBLFVBQU1xQixPQUFPLEdBQUc7QUFDZHJCLE1BQUFBLE1BQU0sRUFBRUEsTUFETTtBQUVkMEQsTUFBQUEsTUFBTSxFQUFFakQsR0FBRyxDQUFDa0QsSUFBSixJQUFZbEQsR0FBRyxDQUFDa0QsSUFBSixDQUFTQyxRQUZmO0FBR2RDLE1BQUFBLElBQUksRUFBRXBELEdBQUcsQ0FBQ2tELElBQUosSUFBWWxELEdBQUcsQ0FBQ2tELElBQUosQ0FBU0UsSUFIYjtBQUlkQyxNQUFBQSxjQUFjLEVBQUVyRCxHQUFHLENBQUNzRCxJQUFKLENBQVNELGNBSlg7QUFLZHhDLE1BQUFBLEdBQUcsRUFBRWIsR0FBRyxDQUFDSyxNQUFKLENBQVdTLGdCQUxGO0FBTWRDLE1BQUFBLE9BQU8sRUFBRWYsR0FBRyxDQUFDSyxNQUFKLENBQVdVLE9BTk47QUFPZEMsTUFBQUEsRUFBRSxFQUFFaEIsR0FBRyxDQUFDSyxNQUFKLENBQVdXLEVBUEQ7QUFRZDRCLE1BQUFBO0FBUmMsS0FBaEI7O0FBV0EsUUFBSUcsWUFBWSxJQUFJLE9BQU9BLFlBQVAsS0FBd0IsVUFBNUMsRUFBd0Q7QUFDdEQsVUFBSWxCLE1BQU0sR0FBR2tCLFlBQVksQ0FBQ25DLE9BQUQsQ0FBekI7O0FBQ0EsVUFBSSxDQUFDaUIsTUFBTCxFQUFhO0FBQ1gsY0FBTSxJQUFJdkQsS0FBSyxDQUFDbUMsS0FBVixDQUNKbkMsS0FBSyxDQUFDbUMsS0FBTixDQUFZOEMsZ0JBRFIsRUFFSixvQkFGSSxDQUFOO0FBSUQ7QUFDRjs7QUFFRCxXQUFPLElBQUk1QixPQUFKLENBQVksVUFBU0MsT0FBVCxFQUFrQk8sTUFBbEIsRUFBMEI7QUFDM0MsWUFBTXFCLFVBQVUsR0FDZHhELEdBQUcsQ0FBQ2tELElBQUosSUFBWWxELEdBQUcsQ0FBQ2tELElBQUosQ0FBU0UsSUFBckIsR0FBNEJwRCxHQUFHLENBQUNrRCxJQUFKLENBQVNFLElBQVQsQ0FBY0ssRUFBMUMsR0FBK0NDLFNBRGpEOztBQUVBLFlBQU1DLFVBQVUsR0FBR0MsZUFBT0Msa0JBQVAsQ0FBMEJuQixJQUFJLENBQUNDLFNBQUwsQ0FBZXBELE1BQWYsQ0FBMUIsQ0FBbkI7O0FBQ0EsWUFBTTtBQUFFNkMsUUFBQUEsT0FBRjtBQUFXTCxRQUFBQSxLQUFYO0FBQWtCZCxRQUFBQTtBQUFsQixVQUE4QnZCLGVBQWUsQ0FBQ3dDLG9CQUFoQixDQUNsQ0wsTUFBTSxJQUFJO0FBQ1IsWUFBSTtBQUNGLGdCQUFNaUMsV0FBVyxHQUFHRixlQUFPQyxrQkFBUCxDQUNsQm5CLElBQUksQ0FBQ0MsU0FBTCxDQUFlZCxNQUFNLENBQUNJLFFBQVAsQ0FBZ0JKLE1BQS9CLENBRGtCLENBQXBCOztBQUdBK0IseUJBQU9OLElBQVAsQ0FDRyxzQkFBcUJWLFlBQWEsYUFBWVksVUFBVyxvQkFBbUJHLFVBQVcsZUFBY0csV0FBWSxFQURwSCxFQUVFO0FBQ0VsQixZQUFBQSxZQURGO0FBRUVyRCxZQUFBQSxNQUZGO0FBR0U2RCxZQUFBQSxJQUFJLEVBQUVJO0FBSFIsV0FGRjs7QUFRQTVCLFVBQUFBLE9BQU8sQ0FBQ0MsTUFBRCxDQUFQO0FBQ0QsU0FiRCxDQWFFLE9BQU9rQyxDQUFQLEVBQVU7QUFDVjVCLFVBQUFBLE1BQU0sQ0FBQzRCLENBQUQsQ0FBTjtBQUNEO0FBQ0YsT0FsQmlDLEVBbUJsQ2hDLEtBQUssSUFBSTtBQUNQLFlBQUk7QUFDRjZCLHlCQUFPN0IsS0FBUCxDQUNHLGlDQUFnQ2EsWUFBYSxhQUFZWSxVQUFXLG9CQUFtQkcsVUFBVyxhQUFuRyxHQUNFakIsSUFBSSxDQUFDQyxTQUFMLENBQWVaLEtBQWYsQ0FGSixFQUdFO0FBQ0VhLFlBQUFBLFlBREY7QUFFRWIsWUFBQUEsS0FGRjtBQUdFeEMsWUFBQUEsTUFIRjtBQUlFNkQsWUFBQUEsSUFBSSxFQUFFSTtBQUpSLFdBSEY7O0FBVUFyQixVQUFBQSxNQUFNLENBQUNKLEtBQUQsQ0FBTjtBQUNELFNBWkQsQ0FZRSxPQUFPZ0MsQ0FBUCxFQUFVO0FBQ1Y1QixVQUFBQSxNQUFNLENBQUM0QixDQUFELENBQU47QUFDRDtBQUNGLE9BbkNpQyxDQUFwQztBQXFDQSxhQUFPcEMsT0FBTyxDQUFDQyxPQUFSLEdBQ0pQLElBREksQ0FDQyxNQUFNO0FBQ1YsZUFBT3dCLFdBQVcsQ0FBQ2pDLE9BQUQsRUFBVTtBQUFFSyxVQUFBQTtBQUFGLFNBQVYsQ0FBbEI7QUFDRCxPQUhJLEVBSUpJLElBSkksQ0FJQ2UsT0FKRCxFQUlVTCxLQUpWLENBQVA7QUFLRCxLQTlDTSxDQUFQO0FBK0NEOztBQWhNZ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBGdW5jdGlvbnNSb3V0ZXIuanNcblxudmFyIFBhcnNlID0gcmVxdWlyZSgncGFyc2Uvbm9kZScpLlBhcnNlLFxuICB0cmlnZ2VycyA9IHJlcXVpcmUoJy4uL3RyaWdnZXJzJyk7XG5cbmltcG9ydCBQcm9taXNlUm91dGVyIGZyb20gJy4uL1Byb21pc2VSb3V0ZXInO1xuaW1wb3J0IHsgcHJvbWlzZUVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MgfSBmcm9tICcuLi9taWRkbGV3YXJlcyc7XG5pbXBvcnQgeyBqb2JTdGF0dXNIYW5kbGVyIH0gZnJvbSAnLi4vU3RhdHVzSGFuZGxlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi4vbG9nZ2VyJztcblxuZnVuY3Rpb24gcGFyc2VPYmplY3Qob2JqKSB7XG4gIGlmIChBcnJheS5pc0FycmF5KG9iaikpIHtcbiAgICByZXR1cm4gb2JqLm1hcChpdGVtID0+IHtcbiAgICAgIHJldHVybiBwYXJzZU9iamVjdChpdGVtKTtcbiAgICB9KTtcbiAgfSBlbHNlIGlmIChvYmogJiYgb2JqLl9fdHlwZSA9PSAnRGF0ZScpIHtcbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbihuZXcgRGF0ZShvYmouaXNvKSwgb2JqKTtcbiAgfSBlbHNlIGlmIChvYmogJiYgb2JqLl9fdHlwZSA9PSAnRmlsZScpIHtcbiAgICByZXR1cm4gUGFyc2UuRmlsZS5mcm9tSlNPTihvYmopO1xuICB9IGVsc2UgaWYgKG9iaiAmJiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0Jykge1xuICAgIHJldHVybiBwYXJzZVBhcmFtcyhvYmopO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBvYmo7XG4gIH1cbn1cblxuZnVuY3Rpb24gcGFyc2VQYXJhbXMocGFyYW1zKSB7XG4gIHJldHVybiBfLm1hcFZhbHVlcyhwYXJhbXMsIHBhcnNlT2JqZWN0KTtcbn1cblxuZXhwb3J0IGNsYXNzIEZ1bmN0aW9uc1JvdXRlciBleHRlbmRzIFByb21pc2VSb3V0ZXIge1xuICBtb3VudFJvdXRlcygpIHtcbiAgICB0aGlzLnJvdXRlKFxuICAgICAgJ1BPU1QnLFxuICAgICAgJy9mdW5jdGlvbnMvOmZ1bmN0aW9uTmFtZScsXG4gICAgICBGdW5jdGlvbnNSb3V0ZXIuaGFuZGxlQ2xvdWRGdW5jdGlvblxuICAgICk7XG4gICAgdGhpcy5yb3V0ZShcbiAgICAgICdQT1NUJyxcbiAgICAgICcvam9icy86am9iTmFtZScsXG4gICAgICBwcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcyxcbiAgICAgIGZ1bmN0aW9uKHJlcSkge1xuICAgICAgICByZXR1cm4gRnVuY3Rpb25zUm91dGVyLmhhbmRsZUNsb3VkSm9iKHJlcSk7XG4gICAgICB9XG4gICAgKTtcbiAgICB0aGlzLnJvdXRlKCdQT1NUJywgJy9qb2JzJywgcHJvbWlzZUVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MsIGZ1bmN0aW9uKHJlcSkge1xuICAgICAgcmV0dXJuIEZ1bmN0aW9uc1JvdXRlci5oYW5kbGVDbG91ZEpvYihyZXEpO1xuICAgIH0pO1xuICB9XG5cbiAgc3RhdGljIGhhbmRsZUNsb3VkSm9iKHJlcSkge1xuICAgIGNvbnN0IGpvYk5hbWUgPSByZXEucGFyYW1zLmpvYk5hbWUgfHwgcmVxLmJvZHkuam9iTmFtZTtcbiAgICBjb25zdCBhcHBsaWNhdGlvbklkID0gcmVxLmNvbmZpZy5hcHBsaWNhdGlvbklkO1xuICAgIGNvbnN0IGpvYkhhbmRsZXIgPSBqb2JTdGF0dXNIYW5kbGVyKHJlcS5jb25maWcpO1xuICAgIGNvbnN0IGpvYkZ1bmN0aW9uID0gdHJpZ2dlcnMuZ2V0Sm9iKGpvYk5hbWUsIGFwcGxpY2F0aW9uSWQpO1xuICAgIGlmICgham9iRnVuY3Rpb24pIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5TQ1JJUFRfRkFJTEVELCAnSW52YWxpZCBqb2IuJyk7XG4gICAgfVxuICAgIGxldCBwYXJhbXMgPSBPYmplY3QuYXNzaWduKHt9LCByZXEuYm9keSwgcmVxLnF1ZXJ5KTtcbiAgICBwYXJhbXMgPSBwYXJzZVBhcmFtcyhwYXJhbXMpO1xuICAgIGNvbnN0IHJlcXVlc3QgPSB7XG4gICAgICBwYXJhbXM6IHBhcmFtcyxcbiAgICAgIGxvZzogcmVxLmNvbmZpZy5sb2dnZXJDb250cm9sbGVyLFxuICAgICAgaGVhZGVyczogcmVxLmNvbmZpZy5oZWFkZXJzLFxuICAgICAgaXA6IHJlcS5jb25maWcuaXAsXG4gICAgICBqb2JOYW1lLFxuICAgICAgbWVzc2FnZTogam9iSGFuZGxlci5zZXRNZXNzYWdlLmJpbmQoam9iSGFuZGxlciksXG4gICAgfTtcblxuICAgIHJldHVybiBqb2JIYW5kbGVyLnNldFJ1bm5pbmcoam9iTmFtZSwgcGFyYW1zKS50aGVuKGpvYlN0YXR1cyA9PiB7XG4gICAgICByZXF1ZXN0LmpvYklkID0gam9iU3RhdHVzLm9iamVjdElkO1xuICAgICAgLy8gcnVuIHRoZSBmdW5jdGlvbiBhc3luY1xuICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiB7XG4gICAgICAgIFByb21pc2UucmVzb2x2ZSgpXG4gICAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGpvYkZ1bmN0aW9uKHJlcXVlc3QpO1xuICAgICAgICAgIH0pXG4gICAgICAgICAgLnRoZW4oXG4gICAgICAgICAgICByZXN1bHQgPT4ge1xuICAgICAgICAgICAgICBqb2JIYW5kbGVyLnNldFN1Y2NlZWRlZChyZXN1bHQpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICAgICAgam9iSGFuZGxlci5zZXRGYWlsZWQoZXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnWC1QYXJzZS1Kb2ItU3RhdHVzLUlkJzogam9iU3RhdHVzLm9iamVjdElkLFxuICAgICAgICB9LFxuICAgICAgICByZXNwb25zZToge30sXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgc3RhdGljIGNyZWF0ZVJlc3BvbnNlT2JqZWN0KHJlc29sdmUsIHJlamVjdCwgbWVzc2FnZSkge1xuICAgIHJldHVybiB7XG4gICAgICBzdWNjZXNzOiBmdW5jdGlvbihyZXN1bHQpIHtcbiAgICAgICAgcmVzb2x2ZSh7XG4gICAgICAgICAgcmVzcG9uc2U6IHtcbiAgICAgICAgICAgIHJlc3VsdDogUGFyc2UuX2VuY29kZShyZXN1bHQpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIGVycm9yOiBmdW5jdGlvbihtZXNzYWdlKSB7XG4gICAgICAgIC8vIHBhcnNlIGVycm9yLCBwcm9jZXNzIGF3YXlcbiAgICAgICAgaWYgKG1lc3NhZ2UgaW5zdGFuY2VvZiBQYXJzZS5FcnJvcikge1xuICAgICAgICAgIHJldHVybiByZWplY3QobWVzc2FnZSk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgY29kZSA9IFBhcnNlLkVycm9yLlNDUklQVF9GQUlMRUQ7XG4gICAgICAgIC8vIElmIGl0J3MgYW4gZXJyb3IsIG1hcmsgaXQgYXMgYSBzY3JpcHQgZmFpbGVkXG4gICAgICAgIGlmICh0eXBlb2YgbWVzc2FnZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICByZXR1cm4gcmVqZWN0KG5ldyBQYXJzZS5FcnJvcihjb2RlLCBtZXNzYWdlKSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1lc3NhZ2UgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlLm1lc3NhZ2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1lc3NhZ2UgaW5zdGFuY2VvZiBPYmplY3RcbiAgICAgICAgICAmJiBPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwobWVzc2FnZSwgXCJjb2RlXCIpXG4gICAgICAgICAgJiYgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG1lc3NhZ2UsIFwibWVzc2FnZVwiKVxuICAgICAgICApIHtcbiAgICAgICAgICBjb2RlID0gbWVzc2FnZS5jb2RlO1xuICAgICAgICAgIG1lc3NhZ2UgPSBtZXNzYWdlLm1lc3NhZ2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1lc3NhZ2UgaW5zdGFuY2VvZiBPYmplY3QpIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgbWVzc2FnZSA9IEpTT04uc3RyaW5naWZ5KG1lc3NhZ2UpO1xuICAgICAgICAgIH0gY2F0Y2ggKF8pIHtcbiAgICAgICAgICAgIC8vXG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJlamVjdChuZXcgUGFyc2UuRXJyb3IoY29kZSwgbWVzc2FnZSkpO1xuICAgICAgfSxcbiAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXG4gICAgfTtcbiAgfVxuXG4gIHN0YXRpYyBoYW5kbGVDbG91ZEZ1bmN0aW9uKHJlcSkge1xuICAgIGNvbnN0IGZ1bmN0aW9uTmFtZSA9IHJlcS5wYXJhbXMuZnVuY3Rpb25OYW1lO1xuICAgIGNvbnN0IGFwcGxpY2F0aW9uSWQgPSByZXEuY29uZmlnLmFwcGxpY2F0aW9uSWQ7XG4gICAgY29uc3QgdGhlRnVuY3Rpb24gPSB0cmlnZ2Vycy5nZXRGdW5jdGlvbihmdW5jdGlvbk5hbWUsIGFwcGxpY2F0aW9uSWQpO1xuICAgIGNvbnN0IHRoZVZhbGlkYXRvciA9IHRyaWdnZXJzLmdldFZhbGlkYXRvcihcbiAgICAgIHJlcS5wYXJhbXMuZnVuY3Rpb25OYW1lLFxuICAgICAgYXBwbGljYXRpb25JZFxuICAgICk7XG4gICAgaWYgKCF0aGVGdW5jdGlvbikge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICBQYXJzZS5FcnJvci5TQ1JJUFRfRkFJTEVELFxuICAgICAgICBgSW52YWxpZCBmdW5jdGlvbjogXCIke2Z1bmN0aW9uTmFtZX1cImBcbiAgICAgICk7XG4gICAgfVxuICAgIGxldCBwYXJhbXMgPSBPYmplY3QuYXNzaWduKHt9LCByZXEuYm9keSwgcmVxLnF1ZXJ5KTtcbiAgICBwYXJhbXMgPSBwYXJzZVBhcmFtcyhwYXJhbXMpO1xuICAgIGNvbnN0IHJlcXVlc3QgPSB7XG4gICAgICBwYXJhbXM6IHBhcmFtcyxcbiAgICAgIG1hc3RlcjogcmVxLmF1dGggJiYgcmVxLmF1dGguaXNNYXN0ZXIsXG4gICAgICB1c2VyOiByZXEuYXV0aCAmJiByZXEuYXV0aC51c2VyLFxuICAgICAgaW5zdGFsbGF0aW9uSWQ6IHJlcS5pbmZvLmluc3RhbGxhdGlvbklkLFxuICAgICAgbG9nOiByZXEuY29uZmlnLmxvZ2dlckNvbnRyb2xsZXIsXG4gICAgICBoZWFkZXJzOiByZXEuY29uZmlnLmhlYWRlcnMsXG4gICAgICBpcDogcmVxLmNvbmZpZy5pcCxcbiAgICAgIGZ1bmN0aW9uTmFtZSxcbiAgICB9O1xuXG4gICAgaWYgKHRoZVZhbGlkYXRvciAmJiB0eXBlb2YgdGhlVmFsaWRhdG9yID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICB2YXIgcmVzdWx0ID0gdGhlVmFsaWRhdG9yKHJlcXVlc3QpO1xuICAgICAgaWYgKCFyZXN1bHQpIHtcbiAgICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICAgIFBhcnNlLkVycm9yLlZBTElEQVRJT05fRVJST1IsXG4gICAgICAgICAgJ1ZhbGlkYXRpb24gZmFpbGVkLidcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICBjb25zdCB1c2VyU3RyaW5nID1cbiAgICAgICAgcmVxLmF1dGggJiYgcmVxLmF1dGgudXNlciA/IHJlcS5hdXRoLnVzZXIuaWQgOiB1bmRlZmluZWQ7XG4gICAgICBjb25zdCBjbGVhbklucHV0ID0gbG9nZ2VyLnRydW5jYXRlTG9nTWVzc2FnZShKU09OLnN0cmluZ2lmeShwYXJhbXMpKTtcbiAgICAgIGNvbnN0IHsgc3VjY2VzcywgZXJyb3IsIG1lc3NhZ2UgfSA9IEZ1bmN0aW9uc1JvdXRlci5jcmVhdGVSZXNwb25zZU9iamVjdChcbiAgICAgICAgcmVzdWx0ID0+IHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgY2xlYW5SZXN1bHQgPSBsb2dnZXIudHJ1bmNhdGVMb2dNZXNzYWdlKFxuICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeShyZXN1bHQucmVzcG9uc2UucmVzdWx0KVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGxvZ2dlci5pbmZvKFxuICAgICAgICAgICAgICBgUmFuIGNsb3VkIGZ1bmN0aW9uICR7ZnVuY3Rpb25OYW1lfSBmb3IgdXNlciAke3VzZXJTdHJpbmd9IHdpdGg6XFxuICBJbnB1dDogJHtjbGVhbklucHV0fVxcbiAgUmVzdWx0OiAke2NsZWFuUmVzdWx0fWAsXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBmdW5jdGlvbk5hbWUsXG4gICAgICAgICAgICAgICAgcGFyYW1zLFxuICAgICAgICAgICAgICAgIHVzZXI6IHVzZXJTdHJpbmcsXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3IgPT4ge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBsb2dnZXIuZXJyb3IoXG4gICAgICAgICAgICAgIGBGYWlsZWQgcnVubmluZyBjbG91ZCBmdW5jdGlvbiAke2Z1bmN0aW9uTmFtZX0gZm9yIHVzZXIgJHt1c2VyU3RyaW5nfSB3aXRoOlxcbiAgSW5wdXQ6ICR7Y2xlYW5JbnB1dH1cXG4gIEVycm9yOiBgICtcbiAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeShlcnJvciksXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBmdW5jdGlvbk5hbWUsXG4gICAgICAgICAgICAgICAgZXJyb3IsXG4gICAgICAgICAgICAgICAgcGFyYW1zLFxuICAgICAgICAgICAgICAgIHVzZXI6IHVzZXJTdHJpbmcsXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHJlamVjdChlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKClcbiAgICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIHJldHVybiB0aGVGdW5jdGlvbihyZXF1ZXN0LCB7IG1lc3NhZ2UgfSk7XG4gICAgICAgIH0pXG4gICAgICAgIC50aGVuKHN1Y2Nlc3MsIGVycm9yKTtcbiAgICB9KTtcbiAgfVxufVxuIl19