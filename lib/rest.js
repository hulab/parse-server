"use strict";

// This file contains helpers for running operations in REST format.
// The goal is that handlers that explicitly handle an express route
// should just be shallow wrappers around things in this file, but
// these functions should not explicitly depend on the request
// object.
// This means that one of these handlers can support multiple
// routes. That's useful for the routes that do really similar
// things.
const AWSXRay = require('aws-xray-sdk');

var Parse = require('parse/node').Parse;

var RestQuery = require('./RestQuery');

var RestWrite = require('./RestWrite');

var triggers = require('./triggers');

function checkTriggers(className, config, types) {
  return types.some(triggerType => {
    return triggers.getTrigger(className, triggers.Types[triggerType], config.applicationId);
  });
}

function checkLiveQuery(className, config) {
  return config.liveQueryController && config.liveQueryController.hasLiveQuery(className);
} // Returns a promise for an object with optional keys 'results' and 'count'.


function find(config, auth, className, restWhere, restOptions, clientSDK) {
  enforceRoleSecurity('find', className, auth);
  return triggers.maybeRunQueryTrigger(triggers.Types.beforeFind, className, restWhere, restOptions, config, auth).then(result => {
    restWhere = result.restWhere || restWhere;
    restOptions = result.restOptions || restOptions;
    const query = new RestQuery(config, auth, className, restWhere, restOptions, clientSDK);
    return query.execute();
  });
} // get is just like find but only queries an objectId.


const get = (config, auth, className, objectId, restOptions, clientSDK) => {
  var restWhere = {
    objectId
  };
  enforceRoleSecurity('get', className, auth);
  return triggers.maybeRunQueryTrigger(triggers.Types.beforeFind, className, restWhere, restOptions, config, auth, true).then(result => {
    restWhere = result.restWhere || restWhere;
    restOptions = result.restOptions || restOptions;
    const query = new RestQuery(config, auth, className, restWhere, restOptions, clientSDK);
    return query.execute();
  });
}; // Returns a promise that doesn't resolve to any useful value.


function del(config, auth, className, objectId) {
  if (typeof objectId !== 'string') {
    throw new Parse.Error(Parse.Error.INVALID_JSON, 'bad objectId');
  }

  if (className === '_User' && auth.isUnauthenticated()) {
    throw new Parse.Error(Parse.Error.SESSION_MISSING, 'Insufficient auth to delete user');
  }

  enforceRoleSecurity('delete', className, auth);
  let inflatedObject;
  let schemaController;
  return Promise.resolve().then(() => {
    const hasTriggers = checkTriggers(className, config, ['beforeDelete', 'afterDelete']);
    const hasLiveQuery = checkLiveQuery(className, config);

    if (hasTriggers || hasLiveQuery || className == '_Session') {
      return new RestQuery(config, auth, className, {
        objectId
      }).execute({
        op: 'delete'
      }).then(response => {
        if (response && response.results && response.results.length) {
          const firstResult = response.results[0];
          firstResult.className = className;

          if (className === '_Session' && !auth.isMaster) {
            if (!auth.user || firstResult.user.objectId !== auth.user.id) {
              throw new Parse.Error(Parse.Error.INVALID_SESSION_TOKEN, 'Invalid session token');
            }
          }

          var cacheAdapter = config.cacheController;
          cacheAdapter.user.del(firstResult.sessionToken);
          inflatedObject = Parse.Object.fromJSON(firstResult);
          return triggers.maybeRunTrigger(triggers.Types.beforeDelete, auth, inflatedObject, null, config);
        }

        throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'Object not found for delete.');
      });
    }

    return Promise.resolve({});
  }).then(() => {
    if (!auth.isMaster) {
      return auth.getUserRoles();
    } else {
      return;
    }
  }).then(() => config.database.loadSchema()).then(s => {
    schemaController = s;
    const options = {};

    if (!auth.isMaster) {
      options.acl = ['*'];

      if (auth.user) {
        options.acl.push(auth.user.id);
        options.acl = options.acl.concat(auth.userRoles);
      }
    }

    return config.database.destroy(className, {
      objectId: objectId
    }, options, schemaController);
  }).then(() => {
    // Notify LiveQuery server if possible
    const perms = schemaController.getClassLevelPermissions(className);
    config.liveQueryController.onAfterDelete(className, inflatedObject, null, perms);
    return triggers.maybeRunTrigger(triggers.Types.afterDelete, auth, inflatedObject, null, config);
  }).catch(error => {
    handleSessionMissingError(error, className, auth);
  });
} // Returns a promise for a {response, status, location} object.


function create(config, auth, className, restObject, clientSDK) {
  enforceRoleSecurity('create', className, auth);
  var write = new RestWrite(config, auth, className, null, restObject, null, clientSDK);
  return write.execute();
} // Returns a promise that contains the fields of the update that the
// REST API is supposed to return.
// Usually, this is just updatedAt.


function update(config, auth, className, restWhere, restObject, clientSDK) {
  enforceRoleSecurity('update', className, auth);
  return Promise.resolve().then(() => {
    const hasTriggers = checkTriggers(className, config, ['beforeSave', 'afterSave']);
    const hasLiveQuery = checkLiveQuery(className, config);

    if (hasTriggers || hasLiveQuery) {
      // Do not use find, as it runs the before finds
      return new RestQuery(config, auth, className, restWhere).execute({
        op: 'update'
      });
    }

    return Promise.resolve({});
  }).then(({
    results
  }) => {
    var originalRestObject;

    if (results && results.length) {
      originalRestObject = results[0];
    }

    return new RestWrite(config, auth, className, restWhere, restObject, originalRestObject, clientSDK).execute();
  }).catch(error => {
    handleSessionMissingError(error, className, auth);
  });
}

function handleSessionMissingError(error, className, auth) {
  // If we're trying to update a user without / with bad session token
  if (className === '_User' && error.code === Parse.Error.OBJECT_NOT_FOUND && !auth.isMaster) {
    throw new Parse.Error(Parse.Error.SESSION_MISSING, 'Insufficient auth.');
  }

  throw error;
}

const classesWithMasterOnlyAccess = ['_JobStatus', '_PushStatus', '_Hooks', '_GlobalConfig', '_JobSchedule']; // Disallowing access to the _Role collection except by master key

function enforceRoleSecurity(method, className, auth) {
  if (className === '_Installation' && !auth.isMaster) {
    if (method === 'delete' || method === 'find') {
      const error = `Clients aren't allowed to perform the ${method} operation on the installation collection.`;
      throw new Parse.Error(Parse.Error.OPERATION_FORBIDDEN, error);
    }
  } //all volatileClasses are masterKey only


  if (classesWithMasterOnlyAccess.indexOf(className) >= 0 && !auth.isMaster) {
    const error = `Clients aren't allowed to perform the ${method} operation on the ${className} collection.`;
    throw new Parse.Error(Parse.Error.OPERATION_FORBIDDEN, error);
  } // readOnly masterKey is not allowed


  if (auth.isReadOnly && (method === 'delete' || method === 'create' || method === 'update')) {
    const error = `read-only masterKey isn't allowed to perform the ${method} operation.`;
    throw new Parse.Error(Parse.Error.OPERATION_FORBIDDEN, error);
  }
}

function tracePromise(operation, promise = Promise.resolve()) {
  const parent = AWSXRay.getSegment();

  if (!parent) {
    return promise;
  }

  return new Promise((resolve, reject) => {
    AWSXRay.captureAsyncFunc('Parse-Server', subsegment => {
      subsegment && subsegment.addAnnotation('Controller', 'rest');
      subsegment && subsegment.addAnnotation('Operation', operation);
      promise.then(function (result) {
        resolve(result);
        subsegment && subsegment.close();
      }, function (error) {
        reject(error);
        subsegment && subsegment.close(error);
      });
    });
  });
}

module.exports = {
  create: tracePromise('create', create),
  del: tracePromise('del', del),
  find: tracePromise('find', find),
  get: tracePromise('get', get),
  update: tracePromise('update', update)
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXN0LmpzIl0sIm5hbWVzIjpbIkFXU1hSYXkiLCJyZXF1aXJlIiwiUGFyc2UiLCJSZXN0UXVlcnkiLCJSZXN0V3JpdGUiLCJ0cmlnZ2VycyIsImNoZWNrVHJpZ2dlcnMiLCJjbGFzc05hbWUiLCJjb25maWciLCJ0eXBlcyIsInNvbWUiLCJ0cmlnZ2VyVHlwZSIsImdldFRyaWdnZXIiLCJUeXBlcyIsImFwcGxpY2F0aW9uSWQiLCJjaGVja0xpdmVRdWVyeSIsImxpdmVRdWVyeUNvbnRyb2xsZXIiLCJoYXNMaXZlUXVlcnkiLCJmaW5kIiwiYXV0aCIsInJlc3RXaGVyZSIsInJlc3RPcHRpb25zIiwiY2xpZW50U0RLIiwiZW5mb3JjZVJvbGVTZWN1cml0eSIsIm1heWJlUnVuUXVlcnlUcmlnZ2VyIiwiYmVmb3JlRmluZCIsInRoZW4iLCJyZXN1bHQiLCJxdWVyeSIsImV4ZWN1dGUiLCJnZXQiLCJvYmplY3RJZCIsImRlbCIsIkVycm9yIiwiSU5WQUxJRF9KU09OIiwiaXNVbmF1dGhlbnRpY2F0ZWQiLCJTRVNTSU9OX01JU1NJTkciLCJpbmZsYXRlZE9iamVjdCIsInNjaGVtYUNvbnRyb2xsZXIiLCJQcm9taXNlIiwicmVzb2x2ZSIsImhhc1RyaWdnZXJzIiwib3AiLCJyZXNwb25zZSIsInJlc3VsdHMiLCJsZW5ndGgiLCJmaXJzdFJlc3VsdCIsImlzTWFzdGVyIiwidXNlciIsImlkIiwiSU5WQUxJRF9TRVNTSU9OX1RPS0VOIiwiY2FjaGVBZGFwdGVyIiwiY2FjaGVDb250cm9sbGVyIiwic2Vzc2lvblRva2VuIiwiT2JqZWN0IiwiZnJvbUpTT04iLCJtYXliZVJ1blRyaWdnZXIiLCJiZWZvcmVEZWxldGUiLCJPQkpFQ1RfTk9UX0ZPVU5EIiwiZ2V0VXNlclJvbGVzIiwiZGF0YWJhc2UiLCJsb2FkU2NoZW1hIiwicyIsIm9wdGlvbnMiLCJhY2wiLCJwdXNoIiwiY29uY2F0IiwidXNlclJvbGVzIiwiZGVzdHJveSIsInBlcm1zIiwiZ2V0Q2xhc3NMZXZlbFBlcm1pc3Npb25zIiwib25BZnRlckRlbGV0ZSIsImFmdGVyRGVsZXRlIiwiY2F0Y2giLCJlcnJvciIsImhhbmRsZVNlc3Npb25NaXNzaW5nRXJyb3IiLCJjcmVhdGUiLCJyZXN0T2JqZWN0Iiwid3JpdGUiLCJ1cGRhdGUiLCJvcmlnaW5hbFJlc3RPYmplY3QiLCJjb2RlIiwiY2xhc3Nlc1dpdGhNYXN0ZXJPbmx5QWNjZXNzIiwibWV0aG9kIiwiT1BFUkFUSU9OX0ZPUkJJRERFTiIsImluZGV4T2YiLCJpc1JlYWRPbmx5IiwidHJhY2VQcm9taXNlIiwib3BlcmF0aW9uIiwicHJvbWlzZSIsInBhcmVudCIsImdldFNlZ21lbnQiLCJyZWplY3QiLCJjYXB0dXJlQXN5bmNGdW5jIiwic3Vic2VnbWVudCIsImFkZEFubm90YXRpb24iLCJjbG9zZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLE1BQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLGNBQUQsQ0FBdkI7O0FBRUEsSUFBSUMsS0FBSyxHQUFHRCxPQUFPLENBQUMsWUFBRCxDQUFQLENBQXNCQyxLQUFsQzs7QUFFQSxJQUFJQyxTQUFTLEdBQUdGLE9BQU8sQ0FBQyxhQUFELENBQXZCOztBQUNBLElBQUlHLFNBQVMsR0FBR0gsT0FBTyxDQUFDLGFBQUQsQ0FBdkI7O0FBQ0EsSUFBSUksUUFBUSxHQUFHSixPQUFPLENBQUMsWUFBRCxDQUF0Qjs7QUFFQSxTQUFTSyxhQUFULENBQXVCQyxTQUF2QixFQUFrQ0MsTUFBbEMsRUFBMENDLEtBQTFDLEVBQWlEO0FBQy9DLFNBQU9BLEtBQUssQ0FBQ0MsSUFBTixDQUFXQyxXQUFXLElBQUk7QUFDL0IsV0FBT04sUUFBUSxDQUFDTyxVQUFULENBQ0xMLFNBREssRUFFTEYsUUFBUSxDQUFDUSxLQUFULENBQWVGLFdBQWYsQ0FGSyxFQUdMSCxNQUFNLENBQUNNLGFBSEYsQ0FBUDtBQUtELEdBTk0sQ0FBUDtBQU9E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QUk7QUFDckRBLE1BQUFBLFVBQVUsSUFBSUEsVUFBVSxDQUFDQyxhQUFYLENBQXlCLFlBQXpCLEVBQXVDLE1BQXZDLENBQWQ7QUFDQUQsTUFBQUEsVUFBVSxJQUFJQSxVQUFVLENBQUNDLGFBQVgsQ0FBeUIsV0FBekIsRUFBc0NQLFNBQXRDLENBQWQ7QUFDQUMsTUFBQUEsT0FBTyxDQUFDL0QsSUFBUixDQUNFLFVBQVNDLE1BQVQsRUFBaUI7QUFDZmEsUUFBQUEsT0FBTyxDQUFDYixNQUFELENBQVA7QUFDQW1FLFFBQUFBLFVBQVUsSUFBSUEsVUFBVSxDQUFDRSxLQUFYLEVBQWQ7QUFDRCxPQUpILEVBS0UsVUFBU3RCLEtBQVQsRUFBZ0I7QUFDZGtCLFFBQUFBLE1BQU0sQ0FBQ2xCLEtBQUQsQ0FBTjtBQUNBb0IsUUFBQUEsVUFBVSxJQUFJQSxVQUFVLENBQUNFLEtBQVgsQ0FBaUJ0QixLQUFqQixDQUFkO0FBQ0QsT0FSSDtBQVVELEtBYkQ7QUFjRCxHQWZNLENBQVA7QUFnQkQ7O0FBRUR1QixNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFDZnRCLEVBQUFBLE1BQU0sRUFBRVcsWUFBWSxDQUFDLFFBQUQsRUFBV1gsTUFBWCxDQURMO0FBRWY1QyxFQUFBQSxHQUFHLEVBQUV1RCxZQUFZLENBQUMsS0FBRCxFQUFRdkQsR0FBUixDQUZGO0FBR2ZkLEVBQUFBLElBQUksRUFBRXFFLFlBQVksQ0FBQyxNQUFELEVBQVNyRSxJQUFULENBSEg7QUFJZlksRUFBQUEsR0FBRyxFQUFFeUQsWUFBWSxDQUFDLEtBQUQsRUFBUXpELEdBQVIsQ0FKRjtBQUtmaUQsRUFBQUEsTUFBTSxFQUFFUSxZQUFZLENBQUMsUUFBRCxFQUFXUixNQUFYO0FBTEwsQ0FBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBUaGlzIGZpbGUgY29udGFpbnMgaGVscGVycyBmb3IgcnVubmluZyBvcGVyYXRpb25zIGluIFJFU1QgZm9ybWF0LlxuLy8gVGhlIGdvYWwgaXMgdGhhdCBoYW5kbGVycyB0aGF0IGV4cGxpY2l0bHkgaGFuZGxlIGFuIGV4cHJlc3Mgcm91dGVcbi8vIHNob3VsZCBqdXN0IGJlIHNoYWxsb3cgd3JhcHBlcnMgYXJvdW5kIHRoaW5ncyBpbiB0aGlzIGZpbGUsIGJ1dFxuLy8gdGhlc2UgZnVuY3Rpb25zIHNob3VsZCBub3QgZXhwbGljaXRseSBkZXBlbmQgb24gdGhlIHJlcXVlc3Rcbi8vIG9iamVjdC5cbi8vIFRoaXMgbWVhbnMgdGhhdCBvbmUgb2YgdGhlc2UgaGFuZGxlcnMgY2FuIHN1cHBvcnQgbXVsdGlwbGVcbi8vIHJvdXRlcy4gVGhhdCdzIHVzZWZ1bCBmb3IgdGhlIHJvdXRlcyB0aGF0IGRvIHJlYWxseSBzaW1pbGFyXG4vLyB0aGluZ3MuXG5jb25zdCBBV1NYUmF5ID0gcmVxdWlyZSgnYXdzLXhyYXktc2RrJyk7XG5cbnZhciBQYXJzZSA9IHJlcXVpcmUoJ3BhcnNlL25vZGUnKS5QYXJzZTtcblxudmFyIFJlc3RRdWVyeSA9IHJlcXVpcmUoJy4vUmVzdFF1ZXJ5Jyk7XG52YXIgUmVzdFdyaXRlID0gcmVxdWlyZSgnLi9SZXN0V3JpdGUnKTtcbnZhciB0cmlnZ2VycyA9IHJlcXVpcmUoJy4vdHJpZ2dlcnMnKTtcblxuZnVuY3Rpb24gY2hlY2tUcmlnZ2VycyhjbGFzc05hbWUsIGNvbmZpZywgdHlwZXMpIHtcbiAgcmV0dXJuIHR5cGVzLnNvbWUodHJpZ2dlclR5cGUgPT4ge1xuICAgIHJldHVybiB0cmlnZ2Vycy5nZXRUcmlnZ2VyKFxuICAgICAgY2xhc3NOYW1lLFxuICAgICAgdHJpZ2dlcnMuVHlwZXNbdHJpZ2dlclR5cGVdLFxuICAgICAgY29uZmlnLmFwcGxpY2F0aW9uSWRcbiAgICApO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY2hlY2tMaXZlUXVlcnkoY2xhc3NOYW1lLCBjb25maWcpIHtcbiAgcmV0dXJuIChcbiAgICBjb25maWcubGl2ZVF1ZXJ5Q29udHJvbGxlciAmJlxuICAgIGNvbmZpZy5saXZlUXVlcnlDb250cm9sbGVyLmhhc0xpdmVRdWVyeShjbGFzc05hbWUpXG4gICk7XG59XG5cbi8vIFJldHVybnMgYSBwcm9taXNlIGZvciBhbiBvYmplY3Qgd2l0aCBvcHRpb25hbCBrZXlzICdyZXN1bHRzJyBhbmQgJ2NvdW50Jy5cbmZ1bmN0aW9uIGZpbmQoY29uZmlnLCBhdXRoLCBjbGFzc05hbWUsIHJlc3RXaGVyZSwgcmVzdE9wdGlvbnMsIGNsaWVudFNESykge1xuICBlbmZvcmNlUm9sZVNlY3VyaXR5KCdmaW5kJywgY2xhc3NOYW1lLCBhdXRoKTtcbiAgcmV0dXJuIHRyaWdnZXJzXG4gICAgLm1heWJlUnVuUXVlcnlUcmlnZ2VyKFxuICAgICAgdHJpZ2dlcnMuVHlwZXMuYmVmb3JlRmluZCxcbiAgICAgIGNsYXNzTmFtZSxcbiAgICAgIHJlc3RXaGVyZSxcbiAgICAgIHJlc3RPcHRpb25zLFxuICAgICAgY29uZmlnLFxuICAgICAgYXV0aFxuICAgIClcbiAgICAudGhlbihyZXN1bHQgPT4ge1xuICAgICAgcmVzdFdoZXJlID0gcmVzdWx0LnJlc3RXaGVyZSB8fCByZXN0V2hlcmU7XG4gICAgICByZXN0T3B0aW9ucyA9IHJlc3VsdC5yZXN0T3B0aW9ucyB8fCByZXN0T3B0aW9ucztcbiAgICAgIGNvbnN0IHF1ZXJ5ID0gbmV3IFJlc3RRdWVyeShcbiAgICAgICAgY29uZmlnLFxuICAgICAgICBhdXRoLFxuICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgIHJlc3RXaGVyZSxcbiAgICAgICAgcmVzdE9wdGlvbnMsXG4gICAgICAgIGNsaWVudFNES1xuICAgICAgKTtcbiAgICAgIHJldHVybiBxdWVyeS5leGVjdXRlKCk7XG4gICAgfSk7XG59XG5cbi8vIGdldCBpcyBqdXN0IGxpa2UgZmluZCBidXQgb25seSBxdWVyaWVzIGFuIG9iamVjdElkLlxuY29uc3QgZ2V0ID0gKGNvbmZpZywgYXV0aCwgY2xhc3NOYW1lLCBvYmplY3RJZCwgcmVzdE9wdGlvbnMsIGNsaWVudFNESykgPT4ge1xuICB2YXIgcmVzdFdoZXJlID0geyBvYmplY3RJZCB9O1xuICBlbmZvcmNlUm9sZVNlY3VyaXR5KCdnZXQnLCBjbGFzc05hbWUsIGF1dGgpO1xuICByZXR1cm4gdHJpZ2dlcnNcbiAgICAubWF5YmVSdW5RdWVyeVRyaWdnZXIoXG4gICAgICB0cmlnZ2Vycy5UeXBlcy5iZWZvcmVGaW5kLFxuICAgICAgY2xhc3NOYW1lLFxuICAgICAgcmVzdFdoZXJlLFxuICAgICAgcmVzdE9wdGlvbnMsXG4gICAgICBjb25maWcsXG4gICAgICBhdXRoLFxuICAgICAgdHJ1ZVxuICAgIClcbiAgICAudGhlbihyZXN1bHQgPT4ge1xuICAgICAgcmVzdFdoZXJlID0gcmVzdWx0LnJlc3RXaGVyZSB8fCByZXN0V2hlcmU7XG4gICAgICByZXN0T3B0aW9ucyA9IHJlc3VsdC5yZXN0T3B0aW9ucyB8fCByZXN0T3B0aW9ucztcbiAgICAgIGNvbnN0IHF1ZXJ5ID0gbmV3IFJlc3RRdWVyeShcbiAgICAgICAgY29uZmlnLFxuICAgICAgICBhdXRoLFxuICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgIHJlc3RXaGVyZSxcbiAgICAgICAgcmVzdE9wdGlvbnMsXG4gICAgICAgIGNsaWVudFNES1xuICAgICAgKTtcbiAgICAgIHJldHVybiBxdWVyeS5leGVjdXRlKCk7XG4gICAgfSk7XG59O1xuXG4vLyBSZXR1cm5zIGEgcHJvbWlzZSB0aGF0IGRvZXNuJ3QgcmVzb2x2ZSB0byBhbnkgdXNlZnVsIHZhbHVlLlxuZnVuY3Rpb24gZGVsKGNvbmZpZywgYXV0aCwgY2xhc3NOYW1lLCBvYmplY3RJZCkge1xuICBpZiAodHlwZW9mIG9iamVjdElkICE9PSAnc3RyaW5nJykge1xuICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5JTlZBTElEX0pTT04sICdiYWQgb2JqZWN0SWQnKTtcbiAgfVxuXG4gIGlmIChjbGFzc05hbWUgPT09ICdfVXNlcicgJiYgYXV0aC5pc1VuYXV0aGVudGljYXRlZCgpKSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgUGFyc2UuRXJyb3IuU0VTU0lPTl9NSVNTSU5HLFxuICAgICAgJ0luc3VmZmljaWVudCBhdXRoIHRvIGRlbGV0ZSB1c2VyJ1xuICAgICk7XG4gIH1cblxuICBlbmZvcmNlUm9sZVNlY3VyaXR5KCdkZWxldGUnLCBjbGFzc05hbWUsIGF1dGgpO1xuXG4gIGxldCBpbmZsYXRlZE9iamVjdDtcbiAgbGV0IHNjaGVtYUNvbnRyb2xsZXI7XG5cbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpXG4gICAgLnRoZW4oKCkgPT4ge1xuICAgICAgY29uc3QgaGFzVHJpZ2dlcnMgPSBjaGVja1RyaWdnZXJzKGNsYXNzTmFtZSwgY29uZmlnLCBbXG4gICAgICAgICdiZWZvcmVEZWxldGUnLFxuICAgICAgICAnYWZ0ZXJEZWxldGUnLFxuICAgICAgXSk7XG4gICAgICBjb25zdCBoYXNMaXZlUXVlcnkgPSBjaGVja0xpdmVRdWVyeShjbGFzc05hbWUsIGNvbmZpZyk7XG4gICAgICBpZiAoaGFzVHJpZ2dlcnMgfHwgaGFzTGl2ZVF1ZXJ5IHx8IGNsYXNzTmFtZSA9PSAnX1Nlc3Npb24nKSB7XG4gICAgICAgIHJldHVybiBuZXcgUmVzdFF1ZXJ5KGNvbmZpZywgYXV0aCwgY2xhc3NOYW1lLCB7IG9iamVjdElkIH0pXG4gICAgICAgICAgLmV4ZWN1dGUoeyBvcDogJ2RlbGV0ZScgfSlcbiAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7XG4gICAgICAgICAgICBpZiAocmVzcG9uc2UgJiYgcmVzcG9uc2UucmVzdWx0cyAmJiByZXNwb25zZS5yZXN1bHRzLmxlbmd0aCkge1xuICAgICAgICAgICAgICBjb25zdCBmaXJzdFJlc3VsdCA9IHJlc3BvbnNlLnJlc3VsdHNbMF07XG4gICAgICAgICAgICAgIGZpcnN0UmVzdWx0LmNsYXNzTmFtZSA9IGNsYXNzTmFtZTtcbiAgICAgICAgICAgICAgaWYgKGNsYXNzTmFtZSA9PT0gJ19TZXNzaW9uJyAmJiAhYXV0aC5pc01hc3Rlcikge1xuICAgICAgICAgICAgICAgIGlmICghYXV0aC51c2VyIHx8IGZpcnN0UmVzdWx0LnVzZXIub2JqZWN0SWQgIT09IGF1dGgudXNlci5pZCkge1xuICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICAgICAgICAgICAgICBQYXJzZS5FcnJvci5JTlZBTElEX1NFU1NJT05fVE9LRU4sXG4gICAgICAgICAgICAgICAgICAgICdJbnZhbGlkIHNlc3Npb24gdG9rZW4nXG4gICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB2YXIgY2FjaGVBZGFwdGVyID0gY29uZmlnLmNhY2hlQ29udHJvbGxlcjtcbiAgICAgICAgICAgICAgY2FjaGVBZGFwdGVyLnVzZXIuZGVsKGZpcnN0UmVzdWx0LnNlc3Npb25Ub2tlbik7XG4gICAgICAgICAgICAgIGluZmxhdGVkT2JqZWN0ID0gUGFyc2UuT2JqZWN0LmZyb21KU09OKGZpcnN0UmVzdWx0KTtcbiAgICAgICAgICAgICAgcmV0dXJuIHRyaWdnZXJzLm1heWJlUnVuVHJpZ2dlcihcbiAgICAgICAgICAgICAgICB0cmlnZ2Vycy5UeXBlcy5iZWZvcmVEZWxldGUsXG4gICAgICAgICAgICAgICAgYXV0aCxcbiAgICAgICAgICAgICAgICBpbmZsYXRlZE9iamVjdCxcbiAgICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgICAgIGNvbmZpZ1xuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgICAgICAgICBQYXJzZS5FcnJvci5PQkpFQ1RfTk9UX0ZPVU5ELFxuICAgICAgICAgICAgICAnT2JqZWN0IG5vdCBmb3VuZCBmb3IgZGVsZXRlLidcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHt9KTtcbiAgICB9KVxuICAgIC50aGVuKCgpID0+IHtcbiAgICAgIGlmICghYXV0aC5pc01hc3Rlcikge1xuICAgICAgICByZXR1cm4gYXV0aC5nZXRVc2VyUm9sZXMoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9KVxuICAgIC50aGVuKCgpID0+IGNvbmZpZy5kYXRhYmFzZS5sb2FkU2NoZW1hKCkpXG4gICAgLnRoZW4ocyA9PiB7XG4gICAgICBzY2hlbWFDb250cm9sbGVyID0gcztcbiAgICAgIGNvbnN0IG9wdGlvbnMgPSB7fTtcbiAgICAgIGlmICghYXV0aC5pc01hc3Rlcikge1xuICAgICAgICBvcHRpb25zLmFjbCA9IFsnKiddO1xuICAgICAgICBpZiAoYXV0aC51c2VyKSB7XG4gICAgICAgICAgb3B0aW9ucy5hY2wucHVzaChhdXRoLnVzZXIuaWQpO1xuICAgICAgICAgIG9wdGlvbnMuYWNsID0gb3B0aW9ucy5hY2wuY29uY2F0KGF1dGgudXNlclJvbGVzKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gY29uZmlnLmRhdGFiYXNlLmRlc3Ryb3koXG4gICAgICAgIGNsYXNzTmFtZSxcbiAgICAgICAge1xuICAgICAgICAgIG9iamVjdElkOiBvYmplY3RJZCxcbiAgICAgICAgfSxcbiAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgc2NoZW1hQ29udHJvbGxlclxuICAgICAgKTtcbiAgICB9KVxuICAgIC50aGVuKCgpID0+IHtcbiAgICAgIC8vIE5vdGlmeSBMaXZlUXVlcnkgc2VydmVyIGlmIHBvc3NpYmxlXG4gICAgICBjb25zdCBwZXJtcyA9IHNjaGVtYUNvbnRyb2xsZXIuZ2V0Q2xhc3NMZXZlbFBlcm1pc3Npb25zKGNsYXNzTmFtZSk7XG4gICAgICBjb25maWcubGl2ZVF1ZXJ5Q29udHJvbGxlci5vbkFmdGVyRGVsZXRlKFxuICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgIGluZmxhdGVkT2JqZWN0LFxuICAgICAgICBudWxsLFxuICAgICAgICBwZXJtc1xuICAgICAgKTtcbiAgICAgIHJldHVybiB0cmlnZ2Vycy5tYXliZVJ1blRyaWdnZXIoXG4gICAgICAgIHRyaWdnZXJzLlR5cGVzLmFmdGVyRGVsZXRlLFxuICAgICAgICBhdXRoLFxuICAgICAgICBpbmZsYXRlZE9iamVjdCxcbiAgICAgICAgbnVsbCxcbiAgICAgICAgY29uZmlnXG4gICAgICApO1xuICAgIH0pXG4gICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgIGhhbmRsZVNlc3Npb25NaXNzaW5nRXJyb3IoZXJyb3IsIGNsYXNzTmFtZSwgYXV0aCk7XG4gICAgfSk7XG59XG5cbi8vIFJldHVybnMgYSBwcm9taXNlIGZvciBhIHtyZXNwb25zZSwgc3RhdHVzLCBsb2NhdGlvbn0gb2JqZWN0LlxuZnVuY3Rpb24gY3JlYXRlKGNvbmZpZywgYXV0aCwgY2xhc3NOYW1lLCByZXN0T2JqZWN0LCBjbGllbnRTREspIHtcbiAgZW5mb3JjZVJvbGVTZWN1cml0eSgnY3JlYXRlJywgY2xhc3NOYW1lLCBhdXRoKTtcbiAgdmFyIHdyaXRlID0gbmV3IFJlc3RXcml0ZShcbiAgICBjb25maWcsXG4gICAgYXV0aCxcbiAgICBjbGFzc05hbWUsXG4gICAgbnVsbCxcbiAgICByZXN0T2JqZWN0LFxuICAgIG51bGwsXG4gICAgY2xpZW50U0RLXG4gICk7XG4gIHJldHVybiB3cml0ZS5leGVjdXRlKCk7XG59XG5cbi8vIFJldHVybnMgYSBwcm9taXNlIHRoYXQgY29udGFpbnMgdGhlIGZpZWxkcyBvZiB0aGUgdXBkYXRlIHRoYXQgdGhlXG4vLyBSRVNUIEFQSSBpcyBzdXBwb3NlZCB0byByZXR1cm4uXG4vLyBVc3VhbGx5LCB0aGlzIGlzIGp1c3QgdXBkYXRlZEF0LlxuZnVuY3Rpb24gdXBkYXRlKGNvbmZpZywgYXV0aCwgY2xhc3NOYW1lLCByZXN0V2hlcmUsIHJlc3RPYmplY3QsIGNsaWVudFNESykge1xuICBlbmZvcmNlUm9sZVNlY3VyaXR5KCd1cGRhdGUnLCBjbGFzc05hbWUsIGF1dGgpO1xuXG4gIHJldHVybiBQcm9taXNlLnJlc29sdmUoKVxuICAgIC50aGVuKCgpID0+IHtcbiAgICAgIGNvbnN0IGhhc1RyaWdnZXJzID0gY2hlY2tUcmlnZ2VycyhjbGFzc05hbWUsIGNvbmZpZywgW1xuICAgICAgICAnYmVmb3JlU2F2ZScsXG4gICAgICAgICdhZnRlclNhdmUnLFxuICAgICAgXSk7XG4gICAgICBjb25zdCBoYXNMaXZlUXVlcnkgPSBjaGVja0xpdmVRdWVyeShjbGFzc05hbWUsIGNvbmZpZyk7XG4gICAgICBpZiAoaGFzVHJpZ2dlcnMgfHwgaGFzTGl2ZVF1ZXJ5KSB7XG4gICAgICAgIC8vIERvIG5vdCB1c2UgZmluZCwgYXMgaXQgcnVucyB0aGUgYmVmb3JlIGZpbmRzXG4gICAgICAgIHJldHVybiBuZXcgUmVzdFF1ZXJ5KGNvbmZpZywgYXV0aCwgY2xhc3NOYW1lLCByZXN0V2hlcmUpLmV4ZWN1dGUoe1xuICAgICAgICAgIG9wOiAndXBkYXRlJyxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHt9KTtcbiAgICB9KVxuICAgIC50aGVuKCh7IHJlc3VsdHMgfSkgPT4ge1xuICAgICAgdmFyIG9yaWdpbmFsUmVzdE9iamVjdDtcbiAgICAgIGlmIChyZXN1bHRzICYmIHJlc3VsdHMubGVuZ3RoKSB7XG4gICAgICAgIG9yaWdpbmFsUmVzdE9iamVjdCA9IHJlc3VsdHNbMF07XG4gICAgICB9XG4gICAgICByZXR1cm4gbmV3IFJlc3RXcml0ZShcbiAgICAgICAgY29uZmlnLFxuICAgICAgICBhdXRoLFxuICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgIHJlc3RXaGVyZSxcbiAgICAgICAgcmVzdE9iamVjdCxcbiAgICAgICAgb3JpZ2luYWxSZXN0T2JqZWN0LFxuICAgICAgICBjbGllbnRTREtcbiAgICAgICkuZXhlY3V0ZSgpO1xuICAgIH0pXG4gICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgIGhhbmRsZVNlc3Npb25NaXNzaW5nRXJyb3IoZXJyb3IsIGNsYXNzTmFtZSwgYXV0aCk7XG4gICAgfSk7XG59XG5cbmZ1bmN0aW9uIGhhbmRsZVNlc3Npb25NaXNzaW5nRXJyb3IoZXJyb3IsIGNsYXNzTmFtZSwgYXV0aCkge1xuICAvLyBJZiB3ZSdyZSB0cnlpbmcgdG8gdXBkYXRlIGEgdXNlciB3aXRob3V0IC8gd2l0aCBiYWQgc2Vzc2lvbiB0b2tlblxuICBpZiAoXG4gICAgY2xhc3NOYW1lID09PSAnX1VzZXInICYmXG4gICAgZXJyb3IuY29kZSA9PT0gUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCAmJlxuICAgICFhdXRoLmlzTWFzdGVyXG4gICkge1xuICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5TRVNTSU9OX01JU1NJTkcsICdJbnN1ZmZpY2llbnQgYXV0aC4nKTtcbiAgfVxuICB0aHJvdyBlcnJvcjtcbn1cblxuY29uc3QgY2xhc3Nlc1dpdGhNYXN0ZXJPbmx5QWNjZXNzID0gW1xuICAnX0pvYlN0YXR1cycsXG4gICdfUHVzaFN0YXR1cycsXG4gICdfSG9va3MnLFxuICAnX0dsb2JhbENvbmZpZycsXG4gICdfSm9iU2NoZWR1bGUnLFxuXTtcbi8vIERpc2FsbG93aW5nIGFjY2VzcyB0byB0aGUgX1JvbGUgY29sbGVjdGlvbiBleGNlcHQgYnkgbWFzdGVyIGtleVxuZnVuY3Rpb24gZW5mb3JjZVJvbGVTZWN1cml0eShtZXRob2QsIGNsYXNzTmFtZSwgYXV0aCkge1xuICBpZiAoY2xhc3NOYW1lID09PSAnX0luc3RhbGxhdGlvbicgJiYgIWF1dGguaXNNYXN0ZXIpIHtcbiAgICBpZiAobWV0aG9kID09PSAnZGVsZXRlJyB8fCBtZXRob2QgPT09ICdmaW5kJykge1xuICAgICAgY29uc3QgZXJyb3IgPSBgQ2xpZW50cyBhcmVuJ3QgYWxsb3dlZCB0byBwZXJmb3JtIHRoZSAke21ldGhvZH0gb3BlcmF0aW9uIG9uIHRoZSBpbnN0YWxsYXRpb24gY29sbGVjdGlvbi5gO1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLk9QRVJBVElPTl9GT1JCSURERU4sIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICAvL2FsbCB2b2xhdGlsZUNsYXNzZXMgYXJlIG1hc3RlcktleSBvbmx5XG4gIGlmIChjbGFzc2VzV2l0aE1hc3Rlck9ubHlBY2Nlc3MuaW5kZXhPZihjbGFzc05hbWUpID49IDAgJiYgIWF1dGguaXNNYXN0ZXIpIHtcbiAgICBjb25zdCBlcnJvciA9IGBDbGllbnRzIGFyZW4ndCBhbGxvd2VkIHRvIHBlcmZvcm0gdGhlICR7bWV0aG9kfSBvcGVyYXRpb24gb24gdGhlICR7Y2xhc3NOYW1lfSBjb2xsZWN0aW9uLmA7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLk9QRVJBVElPTl9GT1JCSURERU4sIGVycm9yKTtcbiAgfVxuXG4gIC8vIHJlYWRPbmx5IG1hc3RlcktleSBpcyBub3QgYWxsb3dlZFxuICBpZiAoXG4gICAgYXV0aC5pc1JlYWRPbmx5ICYmXG4gICAgKG1ldGhvZCA9PT0gJ2RlbGV0ZScgfHwgbWV0aG9kID09PSAnY3JlYXRlJyB8fCBtZXRob2QgPT09ICd1cGRhdGUnKVxuICApIHtcbiAgICBjb25zdCBlcnJvciA9IGByZWFkLW9ubHkgbWFzdGVyS2V5IGlzbid0IGFsbG93ZWQgdG8gcGVyZm9ybSB0aGUgJHttZXRob2R9IG9wZXJhdGlvbi5gO1xuICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5PUEVSQVRJT05fRk9SQklEREVOLCBlcnJvcik7XG4gIH1cbn1cblxuZnVuY3Rpb24gdHJhY2VQcm9taXNlKG9wZXJhdGlvbiwgcHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZSgpKSB7XG4gIGNvbnN0IHBhcmVudCA9IEFXU1hSYXkuZ2V0U2VnbWVudCgpO1xuICBpZiAoIXBhcmVudCkge1xuICAgIHJldHVybiBwcm9taXNlO1xuICB9XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgQVdTWFJheS5jYXB0dXJlQXN5bmNGdW5jKCdQYXJzZS1TZXJ2ZXInLCBzdWJzZWdtZW50ID0+IHtcbiAgICAgIHN1YnNlZ21lbnQgJiYgc3Vic2VnbWVudC5hZGRBbm5vdGF0aW9uKCdDb250cm9sbGVyJywgJ3Jlc3QnKTtcbiAgICAgIHN1YnNlZ21lbnQgJiYgc3Vic2VnbWVudC5hZGRBbm5vdGF0aW9uKCdPcGVyYXRpb24nLCBvcGVyYXRpb24pO1xuICAgICAgcHJvbWlzZS50aGVuKFxuICAgICAgICBmdW5jdGlvbihyZXN1bHQpIHtcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgc3Vic2VnbWVudCAmJiBzdWJzZWdtZW50LmNsb3NlKCk7XG4gICAgICAgIH0sXG4gICAgICAgIGZ1bmN0aW9uKGVycm9yKSB7XG4gICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICBzdWJzZWdtZW50ICYmIHN1YnNlZ21lbnQuY2xvc2UoZXJyb3IpO1xuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIGNyZWF0ZTogdHJhY2VQcm9taXNlKCdjcmVhdGUnLCBjcmVhdGUpLFxuICBkZWw6IHRyYWNlUHJvbWlzZSgnZGVsJywgZGVsKSxcbiAgZmluZDogdHJhY2VQcm9taXNlKCdmaW5kJywgZmluZCksXG4gIGdldDogdHJhY2VQcm9taXNlKCdnZXQnLCBnZXQpLFxuICB1cGRhdGU6IHRyYWNlUHJvbWlzZSgndXBkYXRlJywgdXBkYXRlKSxcbn07XG4iXX0=