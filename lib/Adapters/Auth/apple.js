"use strict";

const Parse = require('parse/node').Parse;

const httpsRequest = require('./httpsRequest');

const NodeRSA = require('node-rsa');

const jwt = require('jsonwebtoken');

const TOKEN_ISSUER = 'https://appleid.apple.com';

const getApplePublicKey = async () => {
  const data = await httpsRequest.get('https://appleid.apple.com/auth/keys');
  const key = data.keys[0];
  const pubKey = new NodeRSA();
  pubKey.importKey({
    n: Buffer.from(key.n, 'base64'),
    e: Buffer.from(key.e, 'base64')
  }, 'components-public');
  return pubKey.exportKey(['public']);
};

const verifyIdToken = async (token, clientID) => {
  if (!token) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'id token is invalid for this user.');
  }

  const applePublicKey = await getApplePublicKey();
  const jwtClaims = jwt.verify(token, applePublicKey, {
    algorithms: 'RS256'
  });

  if (jwtClaims.iss !== TOKEN_ISSUER) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, `id token not issued by correct OpenID provider - expected: ${TOKEN_ISSUER} | from: ${jwtClaims.iss}`);
  }

  if (clientID !== undefined && jwtClaims.aud !== clientID) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, `jwt aud parameter does not include this client - is: ${jwtClaims.aud} | expected: ${clientID}`);
  }

  return jwtClaims;
}; // Returns a promise that fulfills if this id token is valid


function validateAuthData(authData, options = {}) {
  return verifyIdToken(authData.id, options.client_id);
} // Returns a promise that fulfills if this app id is valid.


function validateAppId() {
  return Promise.resolve();
}

module.exports = {
  validateAppId,
  validateAuthData
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9BZGFwdGVycy9BdXRoL2FwcGxlLmpzIl0sIm5hbWVzIjpbIlBhcnNlIiwicmVxdWlyZSIsImh0dHBzUmVxdWVzdCIsIk5vZGVSU0EiLCJqd3QiLCJUT0tFTl9JU1NVRVIiLCJnZXRBcHBsZVB1YmxpY0tleSIsImRhdGEiLCJnZXQiLCJrZXkiLCJrZXlzIiwicHViS2V5IiwiaW1wb3J0S2V5IiwibiIsIkJ1ZmZlciIsImZyb20iLCJlIiwiZXhwb3J0S2V5IiwidmVyaWZ5SWRUb2tlbiIsInRva2VuIiwiY2xpZW50SUQiLCJFcnJvciIsIk9CSkVDVF9OT1RfRk9VTkQiLCJhcHBsZVB1YmxpY0tleSIsImp3dENsYWltcyIsInZlcmlmeSIsImFsZ29yaXRobXMiLCJpc3MiLCJ1bmRlZmluZWQiLCJhdWQiLCJ2YWxpZGF0ZUF1dGhEYXRhIiwiYXV0aERhdGEiLCJvcHRpb25zIiwiaWQiLCJjbGllbnRfaWQiLCJ2YWxpZGF0ZUFwcElkIiwiUHJvbWlzZSIsInJlc29sdmUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOztBQUFBLE1BQU1BLEtBQUssR0FBR0MsT0FBTyxDQUFDLFlBQUQsQ0FBUCxDQUFzQkQsS0FBcEM7O0FBQ0EsTUFBTUUsWUFBWSxHQUFHRCxPQUFPLENBQUMsZ0JBQUQsQ0FBNUI7O0FBQ0EsTUFBTUUsT0FBTyxHQUFHRixPQUFPLENBQUMsVUFBRCxDQUF2Qjs7QUFDQSxNQUFNRyxHQUFHLEdBQUdILE9BQU8sQ0FBQyxjQUFELENBQW5COztBQUVBLE1BQU1JLFlBQVksR0FBRywyQkFBckI7O0FBRUEsTUFBTUMsaUJBQWlCLEdBQUcsWUFBWTtBQUNwQyxRQUFNQyxJQUFJLEdBQUcsTUFBTUwsWUFBWSxDQUFDTSxHQUFiLENBQWlCLHFDQUFqQixDQUFuQjtBQUNBLFFBQU1DLEdBQUcsR0FBR0YsSUFBSSxDQUFDRyxJQUFMLENBQVUsQ0FBVixDQUFaO0FBRUEsUUFBTUMsTUFBTSxHQUFHLElBQUlSLE9BQUosRUFBZjtBQUNBUSxFQUFBQSxNQUFNLENBQUNDLFNBQVAsQ0FDRTtBQUFFQyxJQUFBQSxDQUFDLEVBQUVDLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZTixHQUFHLENBQUNJLENBQWhCLEVBQW1CLFFBQW5CLENBQUw7QUFBbUNHLElBQUFBLENBQUMsRUFBRUYsTUFBTSxDQUFDQyxJQUFQLENBQVlOLEdBQUcsQ0FBQ08sQ0FBaEIsRUFBbUIsUUFBbkI7QUFBdEMsR0FERixFQUVFLG1CQUZGO0FBSUEsU0FBT0wsTUFBTSxDQUFDTSxTQUFQLENBQWlCLENBQUMsUUFBRCxDQUFqQixDQUFQO0FBQ0QsQ0FWRDs7QUFZQSxNQUFNQyxhQUFhLEdBQUcsT0FBT0MsS0FBUCxFQUFjQyxRQUFkLEtBQTJCO0FBQy9DLE1BQUksQ0FBQ0QsS0FBTCxFQUFZO0FBQ1YsVUFBTSxJQUFJbkIsS0FBSyxDQUFDcUIsS0FBVixDQUNKckIsS0FBSyxDQUFDcUIsS0FBTixDQUFZQyxnQkFEUixFQUVKLG9DQUZJLENBQU47QUFJRDs7QUFDRCxRQUFNQyxjQUFjLEdBQUcsTUFBTWpCLGlCQUFpQixFQUE5QztBQUNBLFFBQU1rQixTQUFTLEdBQUdwQixHQUFHLENBQUNxQixNQUFKLENBQVdOLEtBQVgsRUFBa0JJLGNBQWxCLEVBQWtDO0FBQUVHLElBQUFBLFVBQVUsRUFBRTtBQUFkLEdBQWxDLENBQWxCOztBQUVBLE1BQUlGLFNBQVMsQ0FBQ0csR0FBVixLQUFrQnRCLFlBQXRCLEVBQW9DO0FBQ2xDLFVBQU0sSUFBSUwsS0FBSyxDQUFDcUIsS0FBVixDQUNKckIsS0FBSyxDQUFDcUIsS0FBTixDQUFZQyxnQkFEUixFQUVILDhEQUE2RGpCLFlBQWEsWUFBV21CLFNBQVMsQ0FBQ0csR0FBSSxFQUZoRyxDQUFOO0FBSUQ7O0FBQ0QsTUFBSVAsUUFBUSxLQUFLUSxTQUFiLElBQTBCSixTQUFTLENBQUNLLEdBQVYsS0FBa0JULFFBQWhELEVBQTBEO0FBQ3hELFVBQU0sSUFBSXBCLEtBQUssQ0FBQ3FCLEtBQVYsQ0FDSnJCLEtBQUssQ0FBQ3FCLEtBQU4sQ0FBWUMsZ0JBRFIsRUFFSCx3REFBdURFLFNBQVMsQ0FBQ0ssR0FBSSxnQkFBZVQsUUFBUyxFQUYxRixDQUFOO0FBSUQ7O0FBQ0QsU0FBT0ksU0FBUDtBQUNELENBdkJELEMsQ0F5QkE7OztBQUNBLFNBQVNNLGdCQUFULENBQTBCQyxRQUExQixFQUFvQ0MsT0FBTyxHQUFHLEVBQTlDLEVBQWtEO0FBQ2hELFNBQU9kLGFBQWEsQ0FBQ2EsUUFBUSxDQUFDRSxFQUFWLEVBQWNELE9BQU8sQ0FBQ0UsU0FBdEIsQ0FBcEI7QUFDRCxDLENBRUQ7OztBQUNBLFNBQVNDLGFBQVQsR0FBeUI7QUFDdkIsU0FBT0MsT0FBTyxDQUFDQyxPQUFSLEVBQVA7QUFDRDs7QUFFREMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCO0FBQ2ZKLEVBQUFBLGFBRGU7QUFFZkwsRUFBQUE7QUFGZSxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IFBhcnNlID0gcmVxdWlyZSgncGFyc2Uvbm9kZScpLlBhcnNlO1xuY29uc3QgaHR0cHNSZXF1ZXN0ID0gcmVxdWlyZSgnLi9odHRwc1JlcXVlc3QnKTtcbmNvbnN0IE5vZGVSU0EgPSByZXF1aXJlKCdub2RlLXJzYScpO1xuY29uc3Qgand0ID0gcmVxdWlyZSgnanNvbndlYnRva2VuJyk7XG5cbmNvbnN0IFRPS0VOX0lTU1VFUiA9ICdodHRwczovL2FwcGxlaWQuYXBwbGUuY29tJztcblxuY29uc3QgZ2V0QXBwbGVQdWJsaWNLZXkgPSBhc3luYyAoKSA9PiB7XG4gIGNvbnN0IGRhdGEgPSBhd2FpdCBodHRwc1JlcXVlc3QuZ2V0KCdodHRwczovL2FwcGxlaWQuYXBwbGUuY29tL2F1dGgva2V5cycpO1xuICBjb25zdCBrZXkgPSBkYXRhLmtleXNbMF07XG5cbiAgY29uc3QgcHViS2V5ID0gbmV3IE5vZGVSU0EoKTtcbiAgcHViS2V5LmltcG9ydEtleShcbiAgICB7IG46IEJ1ZmZlci5mcm9tKGtleS5uLCAnYmFzZTY0JyksIGU6IEJ1ZmZlci5mcm9tKGtleS5lLCAnYmFzZTY0JykgfSxcbiAgICAnY29tcG9uZW50cy1wdWJsaWMnXG4gICk7XG4gIHJldHVybiBwdWJLZXkuZXhwb3J0S2V5KFsncHVibGljJ10pO1xufTtcblxuY29uc3QgdmVyaWZ5SWRUb2tlbiA9IGFzeW5jICh0b2tlbiwgY2xpZW50SUQpID0+IHtcbiAgaWYgKCF0b2tlbikge1xuICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihcbiAgICAgIFBhcnNlLkVycm9yLk9CSkVDVF9OT1RfRk9VTkQsXG4gICAgICAnaWQgdG9rZW4gaXMgaW52YWxpZCBmb3IgdGhpcyB1c2VyLidcbiAgICApO1xuICB9XG4gIGNvbnN0IGFwcGxlUHVibGljS2V5ID0gYXdhaXQgZ2V0QXBwbGVQdWJsaWNLZXkoKTtcbiAgY29uc3Qgand0Q2xhaW1zID0gand0LnZlcmlmeSh0b2tlbiwgYXBwbGVQdWJsaWNLZXksIHsgYWxnb3JpdGhtczogJ1JTMjU2JyB9KTtcblxuICBpZiAoand0Q2xhaW1zLmlzcyAhPT0gVE9LRU5fSVNTVUVSKSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCxcbiAgICAgIGBpZCB0b2tlbiBub3QgaXNzdWVkIGJ5IGNvcnJlY3QgT3BlbklEIHByb3ZpZGVyIC0gZXhwZWN0ZWQ6ICR7VE9LRU5fSVNTVUVSfSB8IGZyb206ICR7and0Q2xhaW1zLmlzc31gXG4gICAgKTtcbiAgfVxuICBpZiAoY2xpZW50SUQgIT09IHVuZGVmaW5lZCAmJiBqd3RDbGFpbXMuYXVkICE9PSBjbGllbnRJRCkge1xuICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihcbiAgICAgIFBhcnNlLkVycm9yLk9CSkVDVF9OT1RfRk9VTkQsXG4gICAgICBgand0IGF1ZCBwYXJhbWV0ZXIgZG9lcyBub3QgaW5jbHVkZSB0aGlzIGNsaWVudCAtIGlzOiAke2p3dENsYWltcy5hdWR9IHwgZXhwZWN0ZWQ6ICR7Y2xpZW50SUR9YFxuICAgICk7XG4gIH1cbiAgcmV0dXJuIGp3dENsYWltcztcbn07XG5cbi8vIFJldHVybnMgYSBwcm9taXNlIHRoYXQgZnVsZmlsbHMgaWYgdGhpcyBpZCB0b2tlbiBpcyB2YWxpZFxuZnVuY3Rpb24gdmFsaWRhdGVBdXRoRGF0YShhdXRoRGF0YSwgb3B0aW9ucyA9IHt9KSB7XG4gIHJldHVybiB2ZXJpZnlJZFRva2VuKGF1dGhEYXRhLmlkLCBvcHRpb25zLmNsaWVudF9pZCk7XG59XG5cbi8vIFJldHVybnMgYSBwcm9taXNlIHRoYXQgZnVsZmlsbHMgaWYgdGhpcyBhcHAgaWQgaXMgdmFsaWQuXG5mdW5jdGlvbiB2YWxpZGF0ZUFwcElkKCkge1xuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICB2YWxpZGF0ZUFwcElkLFxuICB2YWxpZGF0ZUF1dGhEYXRhLFxufTtcbiJdfQ==