"use strict";

var _AdapterLoader = _interopRequireDefault(require("../AdapterLoader"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const apple = require('./apple');

const facebook = require('./facebook');

const facebookaccountkit = require('./facebookaccountkit');

const instagram = require('./instagram');

const linkedin = require('./linkedin');

const meetup = require('./meetup');

const google = require('./google');

const github = require('./github');

const twitter = require('./twitter');

const spotify = require('./spotify');

const digits = require('./twitter'); // digits tokens are validated by twitter


const janrainengage = require('./janrainengage');

const janraincapture = require('./janraincapture');

const line = require('./line');

const vkontakte = require('./vkontakte');

const qq = require('./qq');

const wechat = require('./wechat');

const weibo = require('./weibo');

const oauth2 = require('./oauth2');

const phantauth = require('./phantauth');

const anonymous = {
  validateAuthData: () => {
    return Promise.resolve();
  },
  validateAppId: () => {
    return Promise.resolve();
  },
  equalAuthData: (authData, newAuthData) => {
    return (authData && authData.id) == (newAuthData && newAuthData.id);
  }
};
const providers = {
  apple,
  facebook,
  facebookaccountkit,
  instagram,
  linkedin,
  meetup,
  google,
  github,
  twitter,
  spotify,
  anonymous,
  digits,
  janrainengage,
  janraincapture,
  line,
  vkontakte,
  qq,
  wechat,
  weibo,
  phantauth
};

function authDataValidator(adapter, appIds, options) {
  return function (authData) {
    return adapter.validateAuthData(authData, options).then(() => {
      if (appIds) {
        return adapter.validateAppId(appIds, authData, options);
      }

      return Promise.resolve();
    });
  };
}

function loadAuthAdapter(provider, authOptions) {
  let defaultAdapter = providers[provider];
  const providerOptions = authOptions[provider];

  if (providerOptions && Object.prototype.hasOwnProperty.call(providerOptions, 'oauth2') && providerOptions['oauth2'] === true) {
    defaultAdapter = oauth2;
  }

  if (!defaultAdapter && !providerOptions) {
    return;
  }

  const adapter = Object.assign({}, defaultAdapter);
  const appIds = providerOptions ? providerOptions.appIds : undefined; // Try the configuration methods

  if (providerOptions) {
    const optionalAdapter = (0, _AdapterLoader.default)(providerOptions, undefined, providerOptions);

    if (optionalAdapter) {
      ['validateAuthData', 'validateAppId', 'equalAuthData'].forEach(key => {
        if (optionalAdapter[key]) {
          adapter[key] = optionalAdapter[key];
        }
      });
    }
  } // TODO: create a new module from validateAdapter() in
  // src/Controllers/AdaptableController.js so we can use it here for adapter
  // validation based on the src/Adapters/Auth/AuthAdapter.js expected class
  // signature.


  if (!adapter.validateAuthData || !adapter.validateAppId) {
    return;
  }

  return {
    adapter,
    appIds,
    providerOptions
  };
}

module.exports = function (authOptions = {}, enableAnonymousUsers = true) {
  let _enableAnonymousUsers = enableAnonymousUsers;

  const setEnableAnonymousUsers = function (enable) {
    _enableAnonymousUsers = enable;
  }; // To handle the test cases on configuration


  const getValidatorForProvider = function (provider) {
    if (provider === 'anonymous' && !_enableAnonymousUsers) {
      return;
    }

    const {
      adapter,
      appIds,
      providerOptions
    } = loadAuthAdapter(provider, authOptions);
    return authDataValidator(adapter, appIds, providerOptions);
  };

  const getEqualityForProvider = function (provider) {
    if (provider === 'anonymous' && !_enableAnonymousUsers) {
      return;
    }

    const {
      adapter
    } = loadAuthAdapter(provider, authOptions);
    return adapter.equalAuthData;
  };

  return Object.freeze({
    getValidatorForProvider,
    setEnableAnonymousUsers,
    getEqualityForProvider
  });
};

module.exports.loadAuthAdapter = loadAuthAdapter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9BZGFwdGVycy9BdXRoL2luZGV4LmpzIl0sIm5hbWVzIjpbImFwcGxlIiwicmVxdWlyZSIsImZhY2Vib29rIiwiZmFjZWJvb2thY2NvdW50a2l0IiwiaW5zdGFncmFtIiwibGlua2VkaW4iLCJtZWV0dXAiLCJnb29nbGUiLCJnaXRodWIiLCJ0d2l0dGVyIiwic3BvdGlmeSIsImRpZ2l0cyIsImphbnJhaW5lbmdhZ2UiLCJqYW5yYWluY2FwdHVyZSIsImxpbmUiLCJ2a29udGFrdGUiLCJxcSIsIndlY2hhdCIsIndlaWJvIiwib2F1dGgyIiwicGhhbnRhdXRoIiwiYW5vbnltb3VzIiwidmFsaWRhdGVBdXRoRGF0YSIsIlByb21pc2UiLCJyZXNvbHZlIiwidmFsaWRhdGVBcHBJZCIsImVxdWFsQXV0aERhdGEiLCJhdXRoRGF0YSIsIm5ld0F1dGhEYXRhIiwiaWQiLCJwcm92aWRlcnMiLCJhdXRoRGF0YVZhbGlkYXRvciIsImFkYXB0ZXIiLCJhcHBJZHMiLCJvcHRpb25zIiwidGhlbiIsImxvYWRBdXRoQWRhcHRlciIsInByb3ZpZGVyIiwiYXV0aE9wdGlvbnMiLCJkZWZhdWx0QWRhcHRlciIsInByb3ZpZGVyT3B0aW9ucyIsIk9iamVjdCIsInByb3RvdHlwZSIsImhhc093blByb3BlcnR5IiwiY2FsbCIsImFzc2lnbiIsInVuZGVmaW5lZCIsIm9wdGlvbmFsQWRhcHRlciIsImZvckVhY2giLCJrZXkiLCJtb2R1bGUiLCJleHBvcnRzIiwiZW5hYmxlQW5vbnltb3VzVXNlcnMiLCJfZW5hYmxlQW5vbnltb3VzVXNlcnMiLCJzZXRFbmFibGVBbm9ueW1vdXNVc2VycyIsImVuYWJsZSIsImdldFZhbGlkYXRvckZvclByb3ZpZGVyIiwiZ2V0RXF1YWxpdHlGb3JQcm92aWRlciIsImZyZWV6ZSJdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7OztBQUVBLE1BQU1BLEtBQUssR0FBR0MsT0FBTyxDQUFDLFNBQUQsQ0FBckI7O0FBQ0EsTUFBTUMsUUFBUSxHQUFHRCxPQUFPLENBQUMsWUFBRCxDQUF4Qjs7QUFDQSxNQUFNRSxrQkFBa0IsR0FBR0YsT0FBTyxDQUFDLHNCQUFELENBQWxDOztBQUNBLE1BQU1HLFNBQVMsR0FBR0gsT0FBTyxDQUFDLGFBQUQsQ0FBekI7O0FBQ0EsTUFBTUksUUFBUSxHQUFHSixPQUFPLENBQUMsWUFBRCxDQUF4Qjs7QUFDQSxNQUFNSyxNQUFNLEdBQUdMLE9BQU8sQ0FBQyxVQUFELENBQXRCOztBQUNBLE1BQU1NLE1BQU0sR0FBR04sT0FBTyxDQUFDLFVBQUQsQ0FBdEI7O0FBQ0EsTUFBTU8sTUFBTSxHQUFHUCxPQUFPLENBQUMsVUFBRCxDQUF0Qjs7QUFDQSxNQUFNUSxPQUFPLEdBQUdSLE9BQU8sQ0FBQyxXQUFELENBQXZCOztBQUNBLE1BQU1TLE9BQU8sR0FBR1QsT0FBTyxDQUFDLFdBQUQsQ0FBdkI7O0FBQ0EsTUFBTVUsTUFBTSxHQUFHVixPQUFPLENBQUMsV0FBRCxDQUF0QixDLENBQXFDOzs7QUFDckMsTUFBTVcsYUFBYSxHQUFHWCxPQUFPLENBQUMsaUJBQUQsQ0FBN0I7O0FBQ0EsTUFBTVksY0FBYyxHQUFHWixPQUFPLENBQUMsa0JBQUQsQ0FBOUI7O0FBQ0EsTUFBTWEsSUFBSSxHQUFHYixPQUFPLENBQUMsUUFBRCxDQUFwQjs7QUFDQSxNQUFNYyxTQUFTLEdBQUdkLE9BQU8sQ0FBQyxhQUFELENBQXpCOztBQUNBLE1BQU1lLEVBQUUsR0FBR2YsT0FBTyxDQUFDLE1BQUQsQ0FBbEI7O0FBQ0EsTUFBTWdCLE1BQU0sR0FBR2hCLE9BQU8sQ0FBQyxVQUFELENBQXRCOztBQUNBLE1BQU1pQixLQUFLLEdBQUdqQixPQUFPLENBQUMsU0FBRCxDQUFyQjs7QUFDQSxNQUFNa0IsTUFBTSxHQUFHbEIsT0FBTyxDQUFDLFVBQUQsQ0FBdEI7O0FBQ0EsTUFBTW1CLFNBQVMsR0FBR25CLE9BQU8sQ0FBQyxhQUFELENBQXpCOztBQUVBLE1BQU1vQixTQUFTLEdBQUc7QUFDaEJDLEVBQUFBLGdCQUFnQixFQUFFLE1BQU07QUFDdEIsV0FBT0MsT0FBTyxDQUFDQyxPQUFSLEVBQVA7QUFDRCxHQUhlO0FBSWhCQyxFQUFBQSxhQUFhLEVBQUUsTUFBTTtBQUNuQixXQUFPRixPQUFPLENBQUNDLE9BQVIsRUFBUDtBQUNELEdBTmU7QUFPaEJFLEVBQUFBLGFBQWEsRUFBRSxDQUFDQyxRQUFELEVBQVdDLFdBQVgsS0FBMkI7QUFDeEMsV0FBTyxDQUFDRCxRQUFRLElBQUlBLFFBQVEsQ0FBQ0UsRUFBdEIsTUFBOEJELFdBQVcsSUFBSUEsV0FBVyxDQUFDQyxFQUF6RCxDQUFQO0FBQ0Q7QUFUZSxDQUFsQjtBQVlBLE1BQU1DLFNBQVMsR0FBRztBQUNoQjlCLEVBQUFBLEtBRGdCO0FBRWhCRSxFQUFBQSxRQUZnQjtBQUdoQkMsRUFBQUEsa0JBSGdCO0FBSWhCQyxFQUFBQSxTQUpnQjtBQUtoQkMsRUFBQUEsUUFMZ0I7QUFNaEJDLEVBQUFBLE1BTmdCO0FBT2hCQyxFQUFBQSxNQVBnQjtBQVFoQkMsRUFBQUEsTUFSZ0I7QUFTaEJDLEVBQUFBLE9BVGdCO0FBVWhCQyxFQUFBQSxPQVZnQjtBQVdoQlcsRUFBQUEsU0FYZ0I7QUFZaEJWLEVBQUFBLE1BWmdCO0FBYWhCQyxFQUFBQSxhQWJnQjtBQWNoQkMsRUFBQUEsY0FkZ0I7QUFlaEJDLEVBQUFBLElBZmdCO0FBZ0JoQkMsRUFBQUEsU0FoQmdCO0FBaUJoQkMsRUFBQUEsRUFqQmdCO0FBa0JoQkMsRUFBQUEsTUFsQmdCO0FBbUJoQkMsRUFBQUEsS0FuQmdCO0FBb0JoQkUsRUFBQUE7QUFwQmdCLENBQWxCOztBQXVCQSxTQUFTVyxpQkFBVCxDQUEyQkMsT0FBM0IsRUFBb0NDLE1BQXBDLEVBQTRDQyxPQUE1QyxFQUFxRDtBQUNuRCxTQUFPLFVBQVNQLFFBQVQsRUFBbUI7QUFDeEIsV0FBT0ssT0FBTyxDQUFDVixnQkFBUixDQUF5QkssUUFBekIsRUFBbUNPLE9BQW5DLEVBQTRDQyxJQUE1QyxDQUFpRCxNQUFNO0FBQzVELFVBQUlGLE1BQUosRUFBWTtBQUNWLGVBQU9ELE9BQU8sQ0FBQ1AsYUFBUixDQUFzQlEsTUFBdEIsRUFBOEJOLFFBQTlCLEVBQXdDTyxPQUF4QyxDQUFQO0FBQ0Q7O0FBQ0QsYUFBT1gsT0FBTyxDQUFDQyxPQUFSLEVBQVA7QUFDRCxLQUxNLENBQVA7QUFNRCxHQVBEO0FBUUQ7O0FBRUQsU0FBU1ksZUFBVCxDQUF5QkMsUUFBekIsRUFBbUNDLFdBQW5DLEVBQWdEO0FBQzlDLE1BQUlDLGNBQWMsR0FBR1QsU0FBUyxDQUFDTyxRQUFELENBQTlCO0FBQ0EsUUFBTUcsZUFBZSxHQUFHRixXQUFXLENBQUNELFFBQUQsQ0FBbkM7O0FBQ0EsTUFDRUcsZUFBZSxJQUNmQyxNQUFNLENBQUNDLFNBQVAsQ0FBaUJDLGNBQWpCLENBQWdDQyxJQUFoQyxDQUFxQ0osZUFBckMsRUFBc0QsUUFBdEQsQ0FEQSxJQUVBQSxlQUFlLENBQUMsUUFBRCxDQUFmLEtBQThCLElBSGhDLEVBSUU7QUFDQUQsSUFBQUEsY0FBYyxHQUFHcEIsTUFBakI7QUFDRDs7QUFFRCxNQUFJLENBQUNvQixjQUFELElBQW1CLENBQUNDLGVBQXhCLEVBQXlDO0FBQ3ZDO0FBQ0Q7O0FBRUQsUUFBTVIsT0FBTyxHQUFHUyxNQUFNLENBQUNJLE1BQVAsQ0FBYyxFQUFkLEVBQWtCTixjQUFsQixDQUFoQjtBQUNBLFFBQU1OLE1BQU0sR0FBR08sZUFBZSxHQUFHQSxlQUFlLENBQUNQLE1BQW5CLEdBQTRCYSxTQUExRCxDQWhCOEMsQ0FrQjlDOztBQUNBLE1BQUlOLGVBQUosRUFBcUI7QUFDbkIsVUFBTU8sZUFBZSxHQUFHLDRCQUN0QlAsZUFEc0IsRUFFdEJNLFNBRnNCLEVBR3RCTixlQUhzQixDQUF4Qjs7QUFLQSxRQUFJTyxlQUFKLEVBQXFCO0FBQ25CLE9BQUMsa0JBQUQsRUFBcUIsZUFBckIsRUFBc0MsZUFBdEMsRUFBdURDLE9BQXZELENBQStEQyxHQUFHLElBQUk7QUFDcEUsWUFBSUYsZUFBZSxDQUFDRSxHQUFELENBQW5CLEVBQTBCO0FBQ3hCakIsVUFBQUEsT0FBTyxDQUFDaUIsR0FBRCxDQUFQLEdBQWVGLGVBQWUsQ0FBQ0UsR0FBRCxDQUE5QjtBQUNEO0FBQ0YsT0FKRDtBQUtEO0FBQ0YsR0FoQzZDLENBa0M5QztBQUNBO0FBQ0E7QUFDQTs7O0FBQ0EsTUFBSSxDQUFDakIsT0FBTyxDQUFDVixnQkFBVCxJQUE2QixDQUFDVSxPQUFPLENBQUNQLGFBQTFDLEVBQXlEO0FBQ3ZEO0FBQ0Q7O0FBRUQsU0FBTztBQUFFTyxJQUFBQSxPQUFGO0FBQVdDLElBQUFBLE1BQVg7QUFBbUJPLElBQUFBO0FBQW5CLEdBQVA7QUFDRDs7QUFFRFUsTUFBTSxDQUFDQyxPQUFQLEdBQWlCLFVBQVNiLFdBQVcsR0FBRyxFQUF2QixFQUEyQmMsb0JBQW9CLEdBQUcsSUFBbEQsRUFBd0Q7QUFDdkUsTUFBSUMscUJBQXFCLEdBQUdELG9CQUE1Qjs7QUFDQSxRQUFNRSx1QkFBdUIsR0FBRyxVQUFTQyxNQUFULEVBQWlCO0FBQy9DRixJQUFBQSxxQkFBcUIsR0FBR0UsTUFBeEI7QUFDRCxHQUZELENBRnVFLENBS3ZFOzs7QUFDQSxRQUFNQyx1QkFBdUIsR0FBRyxVQUFTbkIsUUFBVCxFQUFtQjtBQUNqRCxRQUFJQSxRQUFRLEtBQUssV0FBYixJQUE0QixDQUFDZ0IscUJBQWpDLEVBQXdEO0FBQ3REO0FBQ0Q7O0FBRUQsVUFBTTtBQUFFckIsTUFBQUEsT0FBRjtBQUFXQyxNQUFBQSxNQUFYO0FBQW1CTyxNQUFBQTtBQUFuQixRQUF1Q0osZUFBZSxDQUMxREMsUUFEMEQsRUFFMURDLFdBRjBELENBQTVEO0FBS0EsV0FBT1AsaUJBQWlCLENBQUNDLE9BQUQsRUFBVUMsTUFBVixFQUFrQk8sZUFBbEIsQ0FBeEI7QUFDRCxHQVhEOztBQWFBLFFBQU1pQixzQkFBc0IsR0FBRyxVQUFTcEIsUUFBVCxFQUFtQjtBQUNoRCxRQUFJQSxRQUFRLEtBQUssV0FBYixJQUE0QixDQUFDZ0IscUJBQWpDLEVBQXdEO0FBQ3REO0FBQ0Q7O0FBRUQsVUFBTTtBQUFFckIsTUFBQUE7QUFBRixRQUFhSSxlQUFlLENBQ2hDQyxRQURnQyxFQUVoQ0MsV0FGZ0MsQ0FBbEM7QUFLQSxXQUFPTixPQUFPLENBQUNOLGFBQWY7QUFDRCxHQVhEOztBQWFBLFNBQU9lLE1BQU0sQ0FBQ2lCLE1BQVAsQ0FBYztBQUNuQkYsSUFBQUEsdUJBRG1CO0FBRW5CRixJQUFBQSx1QkFGbUI7QUFHbkJHLElBQUFBO0FBSG1CLEdBQWQsQ0FBUDtBQUtELENBckNEOztBQXVDQVAsTUFBTSxDQUFDQyxPQUFQLENBQWVmLGVBQWYsR0FBaUNBLGVBQWpDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvYWRBZGFwdGVyIGZyb20gJy4uL0FkYXB0ZXJMb2FkZXInO1xuXG5jb25zdCBhcHBsZSA9IHJlcXVpcmUoJy4vYXBwbGUnKTtcbmNvbnN0IGZhY2Vib29rID0gcmVxdWlyZSgnLi9mYWNlYm9vaycpO1xuY29uc3QgZmFjZWJvb2thY2NvdW50a2l0ID0gcmVxdWlyZSgnLi9mYWNlYm9va2FjY291bnRraXQnKTtcbmNvbnN0IGluc3RhZ3JhbSA9IHJlcXVpcmUoJy4vaW5zdGFncmFtJyk7XG5jb25zdCBsaW5rZWRpbiA9IHJlcXVpcmUoJy4vbGlua2VkaW4nKTtcbmNvbnN0IG1lZXR1cCA9IHJlcXVpcmUoJy4vbWVldHVwJyk7XG5jb25zdCBnb29nbGUgPSByZXF1aXJlKCcuL2dvb2dsZScpO1xuY29uc3QgZ2l0aHViID0gcmVxdWlyZSgnLi9naXRodWInKTtcbmNvbnN0IHR3aXR0ZXIgPSByZXF1aXJlKCcuL3R3aXR0ZXInKTtcbmNvbnN0IHNwb3RpZnkgPSByZXF1aXJlKCcuL3Nwb3RpZnknKTtcbmNvbnN0IGRpZ2l0cyA9IHJlcXVpcmUoJy4vdHdpdHRlcicpOyAvLyBkaWdpdHMgdG9rZW5zIGFyZSB2YWxpZGF0ZWQgYnkgdHdpdHRlclxuY29uc3QgamFucmFpbmVuZ2FnZSA9IHJlcXVpcmUoJy4vamFucmFpbmVuZ2FnZScpO1xuY29uc3QgamFucmFpbmNhcHR1cmUgPSByZXF1aXJlKCcuL2phbnJhaW5jYXB0dXJlJyk7XG5jb25zdCBsaW5lID0gcmVxdWlyZSgnLi9saW5lJyk7XG5jb25zdCB2a29udGFrdGUgPSByZXF1aXJlKCcuL3Zrb250YWt0ZScpO1xuY29uc3QgcXEgPSByZXF1aXJlKCcuL3FxJyk7XG5jb25zdCB3ZWNoYXQgPSByZXF1aXJlKCcuL3dlY2hhdCcpO1xuY29uc3Qgd2VpYm8gPSByZXF1aXJlKCcuL3dlaWJvJyk7XG5jb25zdCBvYXV0aDIgPSByZXF1aXJlKCcuL29hdXRoMicpO1xuY29uc3QgcGhhbnRhdXRoID0gcmVxdWlyZSgnLi9waGFudGF1dGgnKTtcblxuY29uc3QgYW5vbnltb3VzID0ge1xuICB2YWxpZGF0ZUF1dGhEYXRhOiAoKSA9PiB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9LFxuICB2YWxpZGF0ZUFwcElkOiAoKSA9PiB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xuICB9LFxuICBlcXVhbEF1dGhEYXRhOiAoYXV0aERhdGEsIG5ld0F1dGhEYXRhKSA9PiB7XG4gICAgcmV0dXJuIChhdXRoRGF0YSAmJiBhdXRoRGF0YS5pZCkgPT0gKG5ld0F1dGhEYXRhICYmIG5ld0F1dGhEYXRhLmlkKTtcbiAgfVxufTtcblxuY29uc3QgcHJvdmlkZXJzID0ge1xuICBhcHBsZSxcbiAgZmFjZWJvb2ssXG4gIGZhY2Vib29rYWNjb3VudGtpdCxcbiAgaW5zdGFncmFtLFxuICBsaW5rZWRpbixcbiAgbWVldHVwLFxuICBnb29nbGUsXG4gIGdpdGh1YixcbiAgdHdpdHRlcixcbiAgc3BvdGlmeSxcbiAgYW5vbnltb3VzLFxuICBkaWdpdHMsXG4gIGphbnJhaW5lbmdhZ2UsXG4gIGphbnJhaW5jYXB0dXJlLFxuICBsaW5lLFxuICB2a29udGFrdGUsXG4gIHFxLFxuICB3ZWNoYXQsXG4gIHdlaWJvLFxuICBwaGFudGF1dGgsXG59O1xuXG5mdW5jdGlvbiBhdXRoRGF0YVZhbGlkYXRvcihhZGFwdGVyLCBhcHBJZHMsIG9wdGlvbnMpIHtcbiAgcmV0dXJuIGZ1bmN0aW9uKGF1dGhEYXRhKSB7XG4gICAgcmV0dXJuIGFkYXB0ZXIudmFsaWRhdGVBdXRoRGF0YShhdXRoRGF0YSwgb3B0aW9ucykudGhlbigoKSA9PiB7XG4gICAgICBpZiAoYXBwSWRzKSB7XG4gICAgICAgIHJldHVybiBhZGFwdGVyLnZhbGlkYXRlQXBwSWQoYXBwSWRzLCBhdXRoRGF0YSwgb3B0aW9ucyk7XG4gICAgICB9XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG4gICAgfSk7XG4gIH07XG59XG5cbmZ1bmN0aW9uIGxvYWRBdXRoQWRhcHRlcihwcm92aWRlciwgYXV0aE9wdGlvbnMpIHtcbiAgbGV0IGRlZmF1bHRBZGFwdGVyID0gcHJvdmlkZXJzW3Byb3ZpZGVyXTtcbiAgY29uc3QgcHJvdmlkZXJPcHRpb25zID0gYXV0aE9wdGlvbnNbcHJvdmlkZXJdO1xuICBpZiAoXG4gICAgcHJvdmlkZXJPcHRpb25zICYmXG4gICAgT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKHByb3ZpZGVyT3B0aW9ucywgJ29hdXRoMicpICYmXG4gICAgcHJvdmlkZXJPcHRpb25zWydvYXV0aDInXSA9PT0gdHJ1ZVxuICApIHtcbiAgICBkZWZhdWx0QWRhcHRlciA9IG9hdXRoMjtcbiAgfVxuXG4gIGlmICghZGVmYXVsdEFkYXB0ZXIgJiYgIXByb3ZpZGVyT3B0aW9ucykge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IGFkYXB0ZXIgPSBPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0QWRhcHRlcik7XG4gIGNvbnN0IGFwcElkcyA9IHByb3ZpZGVyT3B0aW9ucyA/IHByb3ZpZGVyT3B0aW9ucy5hcHBJZHMgOiB1bmRlZmluZWQ7XG5cbiAgLy8gVHJ5IHRoZSBjb25maWd1cmF0aW9uIG1ldGhvZHNcbiAgaWYgKHByb3ZpZGVyT3B0aW9ucykge1xuICAgIGNvbnN0IG9wdGlvbmFsQWRhcHRlciA9IGxvYWRBZGFwdGVyKFxuICAgICAgcHJvdmlkZXJPcHRpb25zLFxuICAgICAgdW5kZWZpbmVkLFxuICAgICAgcHJvdmlkZXJPcHRpb25zXG4gICAgKTtcbiAgICBpZiAob3B0aW9uYWxBZGFwdGVyKSB7XG4gICAgICBbJ3ZhbGlkYXRlQXV0aERhdGEnLCAndmFsaWRhdGVBcHBJZCcsICdlcXVhbEF1dGhEYXRhJ10uZm9yRWFjaChrZXkgPT4ge1xuICAgICAgICBpZiAob3B0aW9uYWxBZGFwdGVyW2tleV0pIHtcbiAgICAgICAgICBhZGFwdGVyW2tleV0gPSBvcHRpb25hbEFkYXB0ZXJba2V5XTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLy8gVE9ETzogY3JlYXRlIGEgbmV3IG1vZHVsZSBmcm9tIHZhbGlkYXRlQWRhcHRlcigpIGluXG4gIC8vIHNyYy9Db250cm9sbGVycy9BZGFwdGFibGVDb250cm9sbGVyLmpzIHNvIHdlIGNhbiB1c2UgaXQgaGVyZSBmb3IgYWRhcHRlclxuICAvLyB2YWxpZGF0aW9uIGJhc2VkIG9uIHRoZSBzcmMvQWRhcHRlcnMvQXV0aC9BdXRoQWRhcHRlci5qcyBleHBlY3RlZCBjbGFzc1xuICAvLyBzaWduYXR1cmUuXG4gIGlmICghYWRhcHRlci52YWxpZGF0ZUF1dGhEYXRhIHx8ICFhZGFwdGVyLnZhbGlkYXRlQXBwSWQpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICByZXR1cm4geyBhZGFwdGVyLCBhcHBJZHMsIHByb3ZpZGVyT3B0aW9ucyB9O1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGZ1bmN0aW9uKGF1dGhPcHRpb25zID0ge30sIGVuYWJsZUFub255bW91c1VzZXJzID0gdHJ1ZSkge1xuICBsZXQgX2VuYWJsZUFub255bW91c1VzZXJzID0gZW5hYmxlQW5vbnltb3VzVXNlcnM7XG4gIGNvbnN0IHNldEVuYWJsZUFub255bW91c1VzZXJzID0gZnVuY3Rpb24oZW5hYmxlKSB7XG4gICAgX2VuYWJsZUFub255bW91c1VzZXJzID0gZW5hYmxlO1xuICB9O1xuICAvLyBUbyBoYW5kbGUgdGhlIHRlc3QgY2FzZXMgb24gY29uZmlndXJhdGlvblxuICBjb25zdCBnZXRWYWxpZGF0b3JGb3JQcm92aWRlciA9IGZ1bmN0aW9uKHByb3ZpZGVyKSB7XG4gICAgaWYgKHByb3ZpZGVyID09PSAnYW5vbnltb3VzJyAmJiAhX2VuYWJsZUFub255bW91c1VzZXJzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgeyBhZGFwdGVyLCBhcHBJZHMsIHByb3ZpZGVyT3B0aW9ucyB9ID0gbG9hZEF1dGhBZGFwdGVyKFxuICAgICAgcHJvdmlkZXIsXG4gICAgICBhdXRoT3B0aW9uc1xuICAgICk7XG5cbiAgICByZXR1cm4gYXV0aERhdGFWYWxpZGF0b3IoYWRhcHRlciwgYXBwSWRzLCBwcm92aWRlck9wdGlvbnMpO1xuICB9O1xuXG4gIGNvbnN0IGdldEVxdWFsaXR5Rm9yUHJvdmlkZXIgPSBmdW5jdGlvbihwcm92aWRlcikge1xuICAgIGlmIChwcm92aWRlciA9PT0gJ2Fub255bW91cycgJiYgIV9lbmFibGVBbm9ueW1vdXNVc2Vycykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHsgYWRhcHRlcn0gPSBsb2FkQXV0aEFkYXB0ZXIoXG4gICAgICBwcm92aWRlcixcbiAgICAgIGF1dGhPcHRpb25zXG4gICAgKTtcblxuICAgIHJldHVybiBhZGFwdGVyLmVxdWFsQXV0aERhdGE7XG4gIH1cblxuICByZXR1cm4gT2JqZWN0LmZyZWV6ZSh7XG4gICAgZ2V0VmFsaWRhdG9yRm9yUHJvdmlkZXIsXG4gICAgc2V0RW5hYmxlQW5vbnltb3VzVXNlcnMsXG4gICAgZ2V0RXF1YWxpdHlGb3JQcm92aWRlclxuICB9KTtcbn07XG5cbm1vZHVsZS5leHBvcnRzLmxvYWRBdXRoQWRhcHRlciA9IGxvYWRBdXRoQWRhcHRlcjtcbiJdfQ==