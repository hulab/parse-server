"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

const AWSXRay = require('aws-xray-sdk');

const mongodb = require('mongodb');

const Collection = mongodb.Collection;

class MongoCollection {
  constructor(mongoCollection) {
    this._mongoCollection = mongoCollection;
  } // Does a find with "smart indexing".
  // Currently this just means, if it needs a geoindex and there is
  // none, then build the geoindex.
  // This could be improved a lot but it's not clear if that's a good
  // idea. Or even if this behavior is a good idea.


  find(query, {
    skip,
    limit,
    sort,
    keys,
    maxTimeMS,
    readPreference
  } = {}) {
    // Support for Full Text Search - $text
    if (keys && keys.$score) {
      delete keys.$score;
      keys.score = {
        $meta: 'textScore'
      };
    }

    return this._executeWithTrace("find", this._rawFind(query, {
      skip,
      limit,
      sort,
      keys,
      maxTimeMS,
      readPreference
    })).catch(error => {
      // Check for "no geoindex" error
      if (error.code != 17007 && !error.message.match(/unable to find index for .geoNear/)) {
        throw error;
      } // Figure out what key needs an index


      const key = error.message.match(/field=([A-Za-z_0-9]+) /)[1];

      if (!key) {
        throw error;
      }

      var index = {};
      index[key] = '2d';
      return this._mongoCollection.createIndex(index) // Retry, but just once.
      .then(() => this._executeWithTrace("find", this._rawFind(query, {
        skip,
        limit,
        sort,
        keys,
        maxTimeMS,
        readPreference
      })));
    });
  }

  _rawFind(query, {
    skip,
    limit,
    sort,
    keys,
    maxTimeMS,
    readPreference
  } = {}) {
    let findOperation = this._mongoCollection.find(query, {
      skip,
      limit,
      sort,
      readPreference
    });

    if (keys) {
      findOperation = findOperation.project(keys);
    }

    if (maxTimeMS) {
      findOperation = findOperation.maxTimeMS(maxTimeMS);
    }

    return findOperation.toArray();
  }

  count(query, {
    skip,
    limit,
    sort,
    maxTimeMS,
    readPreference
  } = {}) {
    // If query is empty, then use estimatedDocumentCount instead.
    // This is due to countDocuments performing a scan,
    // which greatly increases execution time when being run on large collections.
    // See https://github.com/Automattic/mongoose/issues/6713 for more info regarding this problem.
    if (typeof query !== 'object' || !Object.keys(query).length) {
      return this._executeWithTrace("estimatedDocumentCount", this._mongoCollection.estimatedDocumentCount({
        maxTimeMS
      }));
    }

    const countOperation = this._executeWithTrace("countDocuments", this._mongoCollection.countDocuments(query, {
      skip,
      limit,
      sort,
      maxTimeMS,
      readPreference
    }));

    return countOperation;
  }

  distinct(field, query) {
    return this._executeWithTrace("distinct", this._mongoCollection.distinct(field, query));
  }

  aggregate(pipeline, {
    maxTimeMS,
    readPreference
  } = {}) {
    return this._executeWithTrace("aggregate", this._mongoCollection.aggregate(pipeline, {
      maxTimeMS,
      readPreference
    }).toArray());
  }

  insertOne(object, session) {
    return this._executeWithTrace("insertOne", this._mongoCollection.insertOne(object, {
      session
    }));
  }

  insertMany(object, session) {
    return this._executeWithTrace("insertMany", this._mongoCollection.insertMany(object, {
      session
    }));
  } // Atomically updates data in the database for a single (first) object that matched the query
  // If there is nothing that matches the query - does insert
  // Postgres Note: `INSERT ... ON CONFLICT UPDATE` that is available since 9.5.


  upsertOne(query, update, session) {
    return this._executeWithTrace("upsertOne", this._mongoCollection.updateOne(query, update, {
      upsert: true,
      session
    }));
  }

  updateOne(query, update) {
    return this._executeWithTrace("updateOne", this._mongoCollection.updateOne(query, update));
  }

  updateMany(query, update, session) {
    return this._executeWithTrace("updateMany", this._mongoCollection.updateMany(query, update, {
      session
    }));
  }

  deleteMany(query, session) {
    return this._executeWithTrace("deleteMany", this._mongoCollection.deleteMany(query, {
      session
    }));
  }

  _ensureSparseUniqueIndexInBackground(indexRequest) {
    return new Promise((resolve, reject) => {
      this._mongoCollection.createIndex(indexRequest, {
        unique: true,
        background: true,
        sparse: true
      }, error => {
        if (error) {
          reject(error);
        } else {
          resolve();
        }
      });
    });
  }

  drop() {
    return this._mongoCollection.drop();
  }

  _executeWithTrace(type, fn) {
    const parent = AWSXRay.getSegment();

    if (!parent) {
      return fn;
    }

    return new Promise((resolve, reject) => {
      AWSXRay.captureAsyncFunc("MongoDB", subsegment => {
        subsegment && subsegment.addMetadata("collection", this._mongoCollection.collectionName);
        subsegment && subsegment.addMetadata("query", type);
        fn.then(function (result) {
          resolve(result);
          subsegment && subsegment.close();
        }, function (error) {
          reject(error);
          subsegment && subsegment.close(error);
        });
      });
    });
  }

}

exports.default = MongoCollection;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9BZGFwdGVycy9TdG9yYWdlL01vbmdvL01vbmdvQ29sbGVjdGlvbi5qcyJdLCJuYW1lcyI6WyJBV1NYUmF5IiwicmVxdWlyZSIsIm1vbmdvZGIiLCJDb2xsZWN0aW9uIiwiTW9uZ29Db2xsZWN0aW9uIiwiY29uc3RydWN0b3IiLCJtb25nb0NvbGxlY3Rpb24iLCJfbW9uZ29Db2xsZWN0aW9uIiwiZmluZCIsInF1ZXJ5Iiwic2tpcCIsImxpbWl0Iiwic29ydCIsImtleXMiLCJtYXhUaW1lTVMiLCJyZWFkUHJlZmVyZW5jZSIsIiRzY29yZSIsInNjb3JlIiwiJG1ldGEiLCJfZXhlY3V0ZVdpdGhUcmFjZSIsIl9yYXdGaW5kIiwiY2F0Y2giLCJlcnJvciIsImNvZGUiLCJtZXNzYWdlIiwibWF0Y2giLCJrZXkiLCJpbmRleCIsImNyZWF0ZUluZGV4IiwidGhlbiIsImZpbmRPcGVyYXRpb24iLCJwcm9qZWN0IiwidG9BcnJheSIsImNvdW50IiwiT2JqZWN0IiwibGVuZ3RoIiwiZXN0aW1hdGVkRG9jdW1lbnRDb3VudCIsImNvdW50T3BlcmF0aW9uIiwiY291bnREb2N1bWVudHMiLCJkaXN0aW5jdCIsImZpZWxkIiwiYWdncmVnYXRlIiwicGlwZWxpbmUiLCJpbnNlcnRPbmUiLCJvYmplY3QiLCJzZXNzaW9uIiwiaW5zZXJ0TWFueSIsInVwc2VydE9uZSIsInVwZGF0ZSIsInVwZGF0ZU9uZSIsInVwc2VydCIsInVwZGF0ZU1hbnkiLCJkZWxldGVNYW55IiwiX2Vuc3VyZVNwYXJzZVVuaXF1ZUluZGV4SW5CYWNrZ3JvdW5kIiwiaW5kZXhSZXF1ZXN0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJ1bmlxdWUiLCJiYWNrZ3JvdW5kIiwic3BhcnNlIiwiZHJvcCIsInR5cGUiLCJmbiIsInBhcmVudCIsImdldFNlZ21lbnQiLCJjYXB0dXJlQXN5bmNGdW5jIiwic3Vic2VnbWVudCIsImFkZE1ldGFkYXRhIiwiY29sbGVjdGlvbk5h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QVA7QUFhRDs7QUFFREssRUFBQUEsSUFBSSxHQUFHO0FBQ0wsV0FBTyxLQUFLdEQsZ0JBQUwsQ0FBc0JzRCxJQUF0QixFQUFQO0FBQ0Q7O0FBRUQxQyxFQUFBQSxpQkFBaUIsQ0FBQzJDLElBQUQsRUFBT0MsRUFBUCxFQUFXO0FBQzFCLFVBQU1DLE1BQU0sR0FBR2hFLE9BQU8sQ0FBQ2lFLFVBQVIsRUFBZjs7QUFDQSxRQUFJLENBQUNELE1BQUwsRUFBYTtBQUNYLGFBQU9ELEVBQVA7QUFDRDs7QUFDRCxXQUFPLElBQUlSLE9BQUosQ0FBWSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDdEN6RCxNQUFBQSxPQUFPLENBQUNrRSxnQkFBUixDQUF5QixTQUF6QixFQUFxQ0MsVUFBRCxJQUFnQjtBQUNsREEsUUFBQUEsVUFBVSxJQUFJQSxVQUFVLENBQUNDLFdBQVgsQ0FBdUIsWUFBdkIsRUFBcUMsS0FBSzdELGdCQUFMLENBQXNCOEQsY0FBM0QsQ0FBZDtBQUNBRixRQUFBQSxVQUFVLElBQUlBLFVBQVUsQ0FBQ0MsV0FBWCxDQUF1QixPQUF2QixFQUFnQ04sSUFBaEMsQ0FBZDtBQUNBQyxRQUFBQSxFQUFFLENBQUNsQyxJQUFILENBQ0UsVUFBVXlDLE1BQVYsRUFBa0I7QUFDaEJkLFVBQUFBLE9BQU8sQ0FBQ2MsTUFBRCxDQUFQO0FBQ0FILFVBQUFBLFVBQVUsSUFBSUEsVUFBVSxDQUFDSSxLQUFYLEVBQWQ7QUFDRCxTQUpILEVBS0UsVUFBVWpELEtBQVYsRUFBaUI7QUFDZm1DLFVBQUFBLE1BQU0sQ0FBQ25DLEtBQUQsQ0FBTjtBQUNBNkMsVUFBQUEsVUFBVSxJQUFJQSxVQUFVLENBQUNJLEtBQVgsQ0FBaUJqRCxLQUFqQixDQUFkO0FBQ0QsU0FSSDtBQVVELE9BYkQ7QUFjRCxLQWZNLENBQVA7QUFnQkQ7O0FBbkxrQyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IEFXU1hSYXkgPSByZXF1aXJlKCdhd3MteHJheS1zZGsnKTtcbmNvbnN0IG1vbmdvZGIgPSByZXF1aXJlKCdtb25nb2RiJyk7XG5jb25zdCBDb2xsZWN0aW9uID0gbW9uZ29kYi5Db2xsZWN0aW9uO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNb25nb0NvbGxlY3Rpb24ge1xuICBfbW9uZ29Db2xsZWN0aW9uOiBDb2xsZWN0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKG1vbmdvQ29sbGVjdGlvbjogQ29sbGVjdGlvbikge1xuICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbiA9IG1vbmdvQ29sbGVjdGlvbjtcbiAgfVxuXG4gIC8vIERvZXMgYSBmaW5kIHdpdGggXCJzbWFydCBpbmRleGluZ1wiLlxuICAvLyBDdXJyZW50bHkgdGhpcyBqdXN0IG1lYW5zLCBpZiBpdCBuZWVkcyBhIGdlb2luZGV4IGFuZCB0aGVyZSBpc1xuICAvLyBub25lLCB0aGVuIGJ1aWxkIHRoZSBnZW9pbmRleC5cbiAgLy8gVGhpcyBjb3VsZCBiZSBpbXByb3ZlZCBhIGxvdCBidXQgaXQncyBub3QgY2xlYXIgaWYgdGhhdCdzIGEgZ29vZFxuICAvLyBpZGVhLiBPciBldmVuIGlmIHRoaXMgYmVoYXZpb3IgaXMgYSBnb29kIGlkZWEuXG4gIGZpbmQocXVlcnksIHsgc2tpcCwgbGltaXQsIHNvcnQsIGtleXMsIG1heFRpbWVNUywgcmVhZFByZWZlcmVuY2UgfSA9IHt9KSB7XG4gICAgLy8gU3VwcG9ydCBmb3IgRnVsbCBUZXh0IFNlYXJjaCAtICR0ZXh0XG4gICAgaWYgKGtleXMgJiYga2V5cy4kc2NvcmUpIHtcbiAgICAgIGRlbGV0ZSBrZXlzLiRzY29yZTtcbiAgICAgIGtleXMuc2NvcmUgPSB7ICRtZXRhOiAndGV4dFNjb3JlJyB9O1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcImZpbmRcIiwgdGhpcy5fcmF3RmluZChxdWVyeSwge1xuICAgICAgc2tpcCxcbiAgICAgIGxpbWl0LFxuICAgICAgc29ydCxcbiAgICAgIGtleXMsXG4gICAgICBtYXhUaW1lTVMsXG4gICAgICByZWFkUHJlZmVyZW5jZSxcbiAgICB9KSkuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgLy8gQ2hlY2sgZm9yIFwibm8gZ2VvaW5kZXhcIiBlcnJvclxuICAgICAgaWYgKFxuICAgICAgICBlcnJvci5jb2RlICE9IDE3MDA3ICYmXG4gICAgICAgICFlcnJvci5tZXNzYWdlLm1hdGNoKC91bmFibGUgdG8gZmluZCBpbmRleCBmb3IgLmdlb05lYXIvKVxuICAgICAgKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuICAgICAgLy8gRmlndXJlIG91dCB3aGF0IGtleSBuZWVkcyBhbiBpbmRleFxuICAgICAgY29uc3Qga2V5ID0gZXJyb3IubWVzc2FnZS5tYXRjaCgvZmllbGQ9KFtBLVphLXpfMC05XSspIC8pWzFdO1xuICAgICAgaWYgKCFrZXkpIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG5cbiAgICAgIHZhciBpbmRleCA9IHt9O1xuICAgICAgaW5kZXhba2V5XSA9ICcyZCc7XG4gICAgICByZXR1cm4gKFxuICAgICAgICB0aGlzLl9tb25nb0NvbGxlY3Rpb25cbiAgICAgICAgICAuY3JlYXRlSW5kZXgoaW5kZXgpXG4gICAgICAgICAgLy8gUmV0cnksIGJ1dCBqdXN0IG9uY2UuXG4gICAgICAgICAgLnRoZW4oKCkgPT5cbiAgICAgICAgICAgIHRoaXMuX2V4ZWN1dGVXaXRoVHJhY2UoXCJmaW5kXCIsIHRoaXMuX3Jhd0ZpbmQocXVlcnksIHtcbiAgICAgICAgICAgICAgc2tpcCxcbiAgICAgICAgICAgICAgbGltaXQsXG4gICAgICAgICAgICAgIHNvcnQsXG4gICAgICAgICAgICAgIGtleXMsXG4gICAgICAgICAgICAgIG1heFRpbWVNUyxcbiAgICAgICAgICAgICAgcmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgICB9KSlcbiAgICAgICAgICApXG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgX3Jhd0ZpbmQocXVlcnksIHsgc2tpcCwgbGltaXQsIHNvcnQsIGtleXMsIG1heFRpbWVNUywgcmVhZFByZWZlcmVuY2UgfSA9IHt9KSB7XG4gICAgbGV0IGZpbmRPcGVyYXRpb24gPSB0aGlzLl9tb25nb0NvbGxlY3Rpb24uZmluZChxdWVyeSwge1xuICAgICAgc2tpcCxcbiAgICAgIGxpbWl0LFxuICAgICAgc29ydCxcbiAgICAgIHJlYWRQcmVmZXJlbmNlLFxuICAgIH0pO1xuXG4gICAgaWYgKGtleXMpIHtcbiAgICAgIGZpbmRPcGVyYXRpb24gPSBmaW5kT3BlcmF0aW9uLnByb2plY3Qoa2V5cyk7XG4gICAgfVxuXG4gICAgaWYgKG1heFRpbWVNUykge1xuICAgICAgZmluZE9wZXJhdGlvbiA9IGZpbmRPcGVyYXRpb24ubWF4VGltZU1TKG1heFRpbWVNUyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZpbmRPcGVyYXRpb24udG9BcnJheSgpO1xuICB9XG5cbiAgY291bnQocXVlcnksIHsgc2tpcCwgbGltaXQsIHNvcnQsIG1heFRpbWVNUywgcmVhZFByZWZlcmVuY2UgfSA9IHt9KSB7XG4gICAgLy8gSWYgcXVlcnkgaXMgZW1wdHksIHRoZW4gdXNlIGVzdGltYXRlZERvY3VtZW50Q291bnQgaW5zdGVhZC5cbiAgICAvLyBUaGlzIGlzIGR1ZSB0byBjb3VudERvY3VtZW50cyBwZXJmb3JtaW5nIGEgc2NhbixcbiAgICAvLyB3aGljaCBncmVhdGx5IGluY3JlYXNlcyBleGVjdXRpb24gdGltZSB3aGVuIGJlaW5nIHJ1biBvbiBsYXJnZSBjb2xsZWN0aW9ucy5cbiAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL0F1dG9tYXR0aWMvbW9uZ29vc2UvaXNzdWVzLzY3MTMgZm9yIG1vcmUgaW5mbyByZWdhcmRpbmcgdGhpcyBwcm9ibGVtLlxuICAgIGlmICh0eXBlb2YgcXVlcnkgIT09ICdvYmplY3QnIHx8ICFPYmplY3Qua2V5cyhxdWVyeSkubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcImVzdGltYXRlZERvY3VtZW50Q291bnRcIiwgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLmVzdGltYXRlZERvY3VtZW50Q291bnQoe1xuICAgICAgICBtYXhUaW1lTVMsXG4gICAgICB9KSk7XG4gICAgfVxuXG4gICAgY29uc3QgY291bnRPcGVyYXRpb24gPSB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFwiY291bnREb2N1bWVudHNcIiwgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLmNvdW50RG9jdW1lbnRzKHF1ZXJ5LCB7XG4gICAgICBza2lwLFxuICAgICAgbGltaXQsXG4gICAgICBzb3J0LFxuICAgICAgbWF4VGltZU1TLFxuICAgICAgcmVhZFByZWZlcmVuY2VcbiAgICB9KSk7XG5cbiAgICByZXR1cm4gY291bnRPcGVyYXRpb247XG4gIH1cblxuICBkaXN0aW5jdChmaWVsZCwgcXVlcnkpIHtcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcImRpc3RpbmN0XCIsIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5kaXN0aW5jdChmaWVsZCwgcXVlcnkpKTtcbiAgfVxuXG4gIGFnZ3JlZ2F0ZShwaXBlbGluZSwge21heFRpbWVNUywgcmVhZFByZWZlcmVuY2V9ID0ge30pIHtcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcImFnZ3JlZ2F0ZVwiLCB0aGlzLl9tb25nb0NvbGxlY3Rpb24uYWdncmVnYXRlKHBpcGVsaW5lLCB7bWF4VGltZU1TLCByZWFkUHJlZmVyZW5jZX0pLnRvQXJyYXkoKSk7XG4gIH1cblxuICBpbnNlcnRPbmUob2JqZWN0LCBzZXNzaW9uKSB7XG4gICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVXaXRoVHJhY2UoXCJpbnNlcnRPbmVcIiwgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLmluc2VydE9uZShvYmplY3QsIHtzZXNzaW9ufSkpO1xuICB9XG5cbiAgaW5zZXJ0TWFueShvYmplY3QsIHNlc3Npb24pIHtcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcImluc2VydE1hbnlcIiwgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLmluc2VydE1hbnkob2JqZWN0LCB7c2Vzc2lvbn0pKTtcbiAgfVxuXG4gIC8vIEF0b21pY2FsbHkgdXBkYXRlcyBkYXRhIGluIHRoZSBkYXRhYmFzZSBmb3IgYSBzaW5nbGUgKGZpcnN0KSBvYmplY3QgdGhhdCBtYXRjaGVkIHRoZSBxdWVyeVxuICAvLyBJZiB0aGVyZSBpcyBub3RoaW5nIHRoYXQgbWF0Y2hlcyB0aGUgcXVlcnkgLSBkb2VzIGluc2VydFxuICAvLyBQb3N0Z3JlcyBOb3RlOiBgSU5TRVJUIC4uLiBPTiBDT05GTElDVCBVUERBVEVgIHRoYXQgaXMgYXZhaWxhYmxlIHNpbmNlIDkuNS5cbiAgdXBzZXJ0T25lKHF1ZXJ5LCB1cGRhdGUsIHNlc3Npb24pIHtcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcInVwc2VydE9uZVwiLCB0aGlzLl9tb25nb0NvbGxlY3Rpb24udXBkYXRlT25lKHF1ZXJ5LCB1cGRhdGUsIHtcbiAgICAgIHVwc2VydDogdHJ1ZSxcbiAgICAgIHNlc3Npb25cbiAgICB9KSk7XG4gIH1cblxuICB1cGRhdGVPbmUocXVlcnksIHVwZGF0ZSkge1xuICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFwidXBkYXRlT25lXCIsIHRoaXMuX21vbmdvQ29sbGVjdGlvbi51cGRhdGVPbmUocXVlcnksIHVwZGF0ZSkpO1xuICB9XG5cbiAgdXBkYXRlTWFueShxdWVyeSwgdXBkYXRlLCBzZXNzaW9uKSB7XG4gICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVXaXRoVHJhY2UoXCJ1cGRhdGVNYW55XCIsIHRoaXMuX21vbmdvQ29sbGVjdGlvbi51cGRhdGVNYW55KHF1ZXJ5LCB1cGRhdGUsIHtzZXNzaW9ufSkpO1xuICB9XG5cbiAgZGVsZXRlTWFueShxdWVyeSwgc2Vzc2lvbikge1xuICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFwiZGVsZXRlTWFueVwiLCB0aGlzLl9tb25nb0NvbGxlY3Rpb24uZGVsZXRlTWFueShxdWVyeSwge3Nlc3Npb259KSk7XG4gIH1cblxuICBfZW5zdXJlU3BhcnNlVW5pcXVlSW5kZXhJbkJhY2tncm91bmQoaW5kZXhSZXF1ZXN0KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5jcmVhdGVJbmRleChcbiAgICAgICAgaW5kZXhSZXF1ZXN0LFxuICAgICAgICB7IHVuaXF1ZTogdHJ1ZSwgYmFja2dyb3VuZDogdHJ1ZSwgc3BhcnNlOiB0cnVlIH0sXG4gICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBkcm9wKCkge1xuICAgIHJldHVybiB0aGlzLl9tb25nb0NvbGxlY3Rpb24uZHJvcCgpO1xuICB9XG5cbiAgX2V4ZWN1dGVXaXRoVHJhY2UodHlwZSwgZm4pIHtcbiAgICBjb25zdCBwYXJlbnQgPSBBV1NYUmF5LmdldFNlZ21lbnQoKTtcbiAgICBpZiAoIXBhcmVudCkge1xuICAgICAgcmV0dXJuIGZuO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgQVdTWFJheS5jYXB0dXJlQXN5bmNGdW5jKFwiTW9uZ29EQlwiLCAoc3Vic2VnbWVudCkgPT4ge1xuICAgICAgICBzdWJzZWdtZW50ICYmIHN1YnNlZ21lbnQuYWRkTWV0YWRhdGEoXCJjb2xsZWN0aW9uXCIsIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5jb2xsZWN0aW9uTmFtZSk7XG4gICAgICAgIHN1YnNlZ21lbnQgJiYgc3Vic2VnbWVudC5hZGRNZXRhZGF0YShcInF1ZXJ5XCIsIHR5cGUpO1xuICAgICAgICBmbi50aGVuKFxuICAgICAgICAgIGZ1bmN0aW9uIChyZXN1bHQpIHtcbiAgICAgICAgICAgIHJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgICAgIHN1YnNlZ21lbnQgJiYgc3Vic2VnbWVudC5jbG9zZSgpO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgZnVuY3Rpb24gKGVycm9yKSB7XG4gICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgc3Vic2VnbWVudCAmJiBzdWJzZWdtZW50LmNsb3NlKGVycm9yKTtcbiAgICAgICAgICB9XG4gICAgICAgIClcbiAgICAgIH0pXG4gICAgfSlcbiAgfVxufVxuIl19