"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

const AWSXRay = require('hulab-xray-sdk');

const mongodb = require('mongodb');

const Collection = mongodb.Collection;

class MongoCollection {
  constructor(mongoCollection) {
    this._mongoCollection = mongoCollection;
  } // Does a find with "smart indexing".
  // Currently this just means, if it needs a geoindex and there is
  // none, then build the geoindex.
  // This could be improved a lot but it's not clear if that's a good
  // idea. Or even if this behavior is a good idea.


  find(query, {
    skip,
    limit,
    sort,
    keys,
    maxTimeMS,
    readPreference,
    hint,
    caseInsensitive,
    explain
  } = {}) {
    // Support for Full Text Search - $text
    if (keys && keys.$score) {
      delete keys.$score;
      keys.score = {
        $meta: 'textScore'
      };
    }

    return this._executeWithTrace('find', this._rawFind(query, {
      skip,
      limit,
      sort,
      keys,
      maxTimeMS,
      readPreference,
      hint,
      caseInsensitive,
      explain
    }), query).catch(error => {
      // Check for "no geoindex" error
      if (error.code != 17007 && !error.message.match(/unable to find index for .geoNear/)) {
        throw error;
      } // Figure out what key needs an index


      const key = error.message.match(/field=([A-Za-z_0-9]+) /)[1];

      if (!key) {
        throw error;
      }

      var index = {};
      index[key] = '2d';
      return this._mongoCollection.createIndex(index) // Retry, but just once.
      .then(() => this._executeWithTrace('find', this._rawFind(query, {
        skip,
        limit,
        sort,
        keys,
        maxTimeMS,
        readPreference,
        hint,
        caseInsensitive,
        explain
      })));
    });
  }
  /**
   * Collation to support case insensitive queries
   */


  static caseInsensitiveCollation() {
    return {
      locale: 'en_US',
      strength: 2
    };
  }

  _rawFind(query, {
    skip,
    limit,
    sort,
    keys,
    maxTimeMS,
    readPreference,
    hint,
    caseInsensitive,
    explain
  } = {}) {
    let findOperation = this._mongoCollection.find(query, {
      skip,
      limit,
      sort,
      readPreference,
      hint
    });

    if (keys) {
      findOperation = findOperation.project(keys);
    }

    if (caseInsensitive) {
      findOperation = findOperation.collation(MongoCollection.caseInsensitiveCollation());
    }

    if (maxTimeMS) {
      findOperation = findOperation.maxTimeMS(maxTimeMS);
    }

    return explain ? findOperation.explain(explain) : findOperation.toArray();
  }

  count(query, {
    skip,
    limit,
    sort,
    maxTimeMS,
    readPreference,
    hint
  } = {}) {
    // If query is empty, then use estimatedDocumentCount instead.
    // This is due to countDocuments performing a scan,
    // which greatly increases execution time when being run on large collections.
    // See https://github.com/Automattic/mongoose/issues/6713 for more info regarding this problem.
    if (typeof query !== 'object' || !Object.keys(query).length) {
      return this._executeWithTrace('estimatedDocumentCount', this._mongoCollection.estimatedDocumentCount({
        maxTimeMS
      }));
    }

    const countOperation = this._executeWithTrace('countDocuments', this._mongoCollection.countDocuments(query, {
      skip,
      limit,
      sort,
      maxTimeMS,
      readPreference,
      hint
    }));

    return countOperation;
  }

  distinct(field, query) {
    return this._executeWithTrace('distinct', this._mongoCollection.distinct(field, query));
  }

  aggregate(pipeline, {
    maxTimeMS,
    readPreference,
    hint,
    explain
  } = {}) {
    return this._executeWithTrace('aggregate', this._mongoCollection.aggregate(pipeline, {
      maxTimeMS,
      readPreference,
      hint,
      explain
    }).toArray());
  }

  insertOne(object, session) {
    return this._executeWithTrace('insertOne', this._mongoCollection.insertOne(object, {
      session
    }));
  }

  insertMany(object, session) {
    return this._executeWithTrace('insertMany', this._mongoCollection.insertMany(object, {
      session
    }));
  } // Atomically updates data in the database for a single (first) object that matched the query
  // If there is nothing that matches the query - does insert
  // Postgres Note: `INSERT ... ON CONFLICT UPDATE` that is available since 9.5.


  upsertOne(query, update, session) {
    return this._executeWithTrace('upsertOne', this._mongoCollection.updateOne(query, update, {
      upsert: true,
      session
    }));
  }

  updateOne(query, update) {
    return this._executeWithTrace('updateOne', this._mongoCollection.updateOne(query, update));
  }

  updateMany(query, update, session) {
    return this._executeWithTrace('updateMany', this._mongoCollection.updateMany(query, update, {
      session
    }));
  }

  deleteMany(query, session) {
    return this._executeWithTrace('deleteMany', this._mongoCollection.deleteMany(query, {
      session
    }));
  }

  _ensureSparseUniqueIndexInBackground(indexRequest) {
    return new Promise((resolve, reject) => {
      this._mongoCollection.createIndex(indexRequest, {
        unique: true,
        background: true,
        sparse: true
      }, error => {
        if (error) {
          reject(error);
        } else {
          resolve();
        }
      });
    });
  }

  drop() {
    return this._mongoCollection.drop();
  }

  _executeWithTrace(type, fn, query) {
    const parent = AWSXRay.getSegment();

    if (!parent) {
      return fn;
    }

    return new Promise((resolve, reject) => {
      AWSXRay.captureAsyncFunc(`MongoDB_${this._mongoCollection.collectionName}`, subsegment => {
        try {
          subsegment && subsegment.addAnnotation('collection', this._mongoCollection.collectionName);
          subsegment && subsegment.addAnnotation('query', type);

          if (query && typeof query === "object") {
            subsegment && subsegment.addAnnotation('where', JSON.stringify(query));
          }
        } catch (error) {//
        }

        fn.then(function (result) {
          resolve(result);
          subsegment && subsegment.close();
        }, function (error) {
          reject(error);
          subsegment && subsegment.close(error);
        });
      });
    });
  }

}

exports.default = MongoCollection;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9BZGFwdGVycy9TdG9yYWdlL01vbmdvL01vbmdvQ29sbGVjdGlvbi5qcyJdLCJuYW1lcyI6WyJBV1NYUmF5IiwicmVxdWlyZSIsIm1vbmdvZGIiLCJDb2xsZWN0aW9uIiwiTW9uZ29Db2xsZWN0aW9uIiwiY29uc3RydWN0b3IiLCJtb25nb0NvbGxlY3Rpb24iLCJfbW9uZ29Db2xsZWN0aW9uIiwiZmluZCIsInF1ZXJ5Iiwic2tpcCIsImxpbWl0Iiwic29ydCIsImtleXMiLCJtYXhUaW1lTVMiLCJyZWFkUHJlZmVyZW5jZSIsImhpbnQiLCJjYXNlSW5zZW5zaXRpdmUiLCJleHBsYWluIiwiJHNjb3JlIiwic2NvcmUiLCIkbWV0YSIsIl9leGVjdXRlV2l0aFRyYWNlIiwiX3Jhd0ZpbmQiLCJjYXRjaCIsImVycm9yIiwiY29kZSIsIm1lc3NhZ2UiLCJtYXRjaCIsImtleSIsImluZGV4IiwiY3JlYXRlSW5kZXgiLCJ0aGVuIiwiY2FzZUluc2Vuc2l0aXZlQ29sbGF0aW9uIiwibG9jYWxlIiwic3RyZW5ndGgiLCJmaW5kT3BlcmF0aW9uIiwicHJvamVjdCIsImNvbGxhdGlvbiIsInRvQXJyYXkiLCJjb3VudCIsIk9iamVjdCIsImxlbmd0aCIsImVzdGltYXRlZERvY3VtZW50Q291bnQiLCJjb3VudE9wZXJhdGlvbiIsImNvdW50RG9jdW1lbnRzIiwiZGlzdGluY3QiLCJmaWVsZCIsImFnZ3JlZ2F0ZSIsInBpcGVsaW5lIiwiaW5zZXJ0T25lIiwib2JqZWN0Iiwic2Vzc2lvbiIsImluc2VydE1hbnkiLCJ1cHNlcnRPbmUiLCJ1cGRhdGUiLCJ1cGRhdGVPbmUiLCJ1cHNlcnQiLCJ1cGRhdGVNYW55IiwiZGVsZXRlTWFueSIsIl9lbnN1cmVTcGFyc2VVbmlxdWVJbmRleEluQmFja2dyb3VuZCIsImluZGV4UmVxdWVzdCIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwidW5pcXVlIiwiYmFja2dyb3VuZCIsInNwYXJzZSIsImRyb3AiLCJ0eXBlIiwiZm4iLCJwYXJlbnQiLCJnZXRTZWdtZW50IiwiY2FwdHVyZUFzeW5jRnVuYyIsImNvbGxlY3Rpb25OYW1lIiwic3Vic2VnbWVudCIsImFkZEFubm90YXRpb24iLCJKU09OIiwic3RyaW5naWZ5IiwicmVzdWx0IiwiY2xvc2UiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQSxNQUFNQSxPQUFPLEdBQUdDLE9BQU8sQ0FBQyxnQkFBRCxDQUF2Qjs7QUFDQSxNQUFNQyxPQUFPLEdBQUdELE9BQU8sQ0FBQyxTQUFELENBQXZCOztBQUNBLE1BQU1FLFVBQVUsR0FBR0QsT0FBTyxDQUFDQyxVQUEzQjs7QUFFZSxNQUFNQyxlQUFOLENBQXNCO0FBR25DQyxFQUFBQSxXQUFXLENBQUNDLGVBQUQsRUFBOEI7QUFDdkMsU0FBS0MsZ0JBQUwsR0FBd0JELGVBQXhCO0FBQ0QsR0FMa0MsQ0FPbkM7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7O0FBQ0FFLEVBQUFBLElBQUksQ0FDRkMsS0FERSxFQUVGO0FBQ0VDLElBQUFBLElBREY7QUFFRUMsSUFBQUEsS0FGRjtBQUdFQyxJQUFBQSxJQUhGO0FBSUVDLElBQUFBLElBSkY7QUFLRUMsSUFBQUEsU0FMRjtBQU1FQyxJQUFBQSxjQU5GO0FBT0VDLElBQUFBLElBUEY7QUFRRUMsSUFBQUEsZUFSRjtBQVNFQyxJQUFBQTtBQVRGLE1BVUksRUFaRixFQWFGO0FBQ0E7QUFDQSxRQUFJTCxJQUFJLElBQUlBLElBQUksQ0FBQ00sTUFBakIsRUFBeUI7QUFDdkIsYUFBT04sSUFBSSxDQUFDTSxNQUFaO0FBQ0FOLE1BQUFBLElBQUksQ0FBQ08sS0FBTCxHQUFhO0FBQUVDLFFBQUFBLEtBQUssRUFBRTtBQUFULE9BQWI7QUFDRDs7QUFFRCxXQUFPLEtBQUtDLGlCQUFMLENBQ0wsTUFESyxFQUVMLEtBQUtDLFFBQUwsQ0FBY2QsS0FBZCxFQUFxQjtBQUNuQkMsTUFBQUEsSUFEbUI7QUFFbkJDLE1BQUFBLEtBRm1CO0FBR25CQyxNQUFBQSxJQUhtQjtBQUluQkMsTUFBQUEsSUFK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bmNvbnN0IG1vbmdvZGIgPSByZXF1aXJlKCdtb25nb2RiJyk7XG5jb25zdCBDb2xsZWN0aW9uID0gbW9uZ29kYi5Db2xsZWN0aW9uO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNb25nb0NvbGxlY3Rpb24ge1xuICBfbW9uZ29Db2xsZWN0aW9uOiBDb2xsZWN0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKG1vbmdvQ29sbGVjdGlvbjogQ29sbGVjdGlvbikge1xuICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbiA9IG1vbmdvQ29sbGVjdGlvbjtcbiAgfVxuXG4gIC8vIERvZXMgYSBmaW5kIHdpdGggXCJzbWFydCBpbmRleGluZ1wiLlxuICAvLyBDdXJyZW50bHkgdGhpcyBqdXN0IG1lYW5zLCBpZiBpdCBuZWVkcyBhIGdlb2luZGV4IGFuZCB0aGVyZSBpc1xuICAvLyBub25lLCB0aGVuIGJ1aWxkIHRoZSBnZW9pbmRleC5cbiAgLy8gVGhpcyBjb3VsZCBiZSBpbXByb3ZlZCBhIGxvdCBidXQgaXQncyBub3QgY2xlYXIgaWYgdGhhdCdzIGEgZ29vZFxuICAvLyBpZGVhLiBPciBldmVuIGlmIHRoaXMgYmVoYXZpb3IgaXMgYSBnb29kIGlkZWEuXG4gIGZpbmQoXG4gICAgcXVlcnksXG4gICAge1xuICAgICAgc2tpcCxcbiAgICAgIGxpbWl0LFxuICAgICAgc29ydCxcbiAgICAgIGtleXMsXG4gICAgICBtYXhUaW1lTVMsXG4gICAgICByZWFkUHJlZmVyZW5jZSxcbiAgICAgIGhpbnQsXG4gICAgICBjYXNlSW5zZW5zaXRpdmUsXG4gICAgICBleHBsYWluLFxuICAgIH0gPSB7fVxuICApIHtcbiAgICAvLyBTdXBwb3J0IGZvciBGdWxsIFRleHQgU2VhcmNoIC0gJHRleHRcbiAgICBpZiAoa2V5cyAmJiBrZXlzLiRzY29yZSkge1xuICAgICAgZGVsZXRlIGtleXMuJHNjb3JlO1xuICAgICAga2V5cy5zY29yZSA9IHsgJG1ldGE6ICd0ZXh0U2NvcmUnIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVXaXRoVHJhY2UoXG4gICAgICAnZmluZCcsXG4gICAgICB0aGlzLl9yYXdGaW5kKHF1ZXJ5LCB7XG4gICAgICAgIHNraXAsXG4gICAgICAgIGxpbWl0LFxuICAgICAgICBzb3J0LFxuICAgICAgICBrZXlzLFxuICAgICAgICBtYXhUaW1lTVMsXG4gICAgICAgIHJlYWRQcmVmZXJlbmNlLFxuICAgICAgICBoaW50LFxuICAgICAgICBjYXNlSW5zZW5zaXRpdmUsXG4gICAgICAgIGV4cGxhaW4sXG4gICAgICB9KSwgcXVlcnlcbiAgICApLmNhdGNoKGVycm9yID0+IHtcbiAgICAgIC8vIENoZWNrIGZvciBcIm5vIGdlb2luZGV4XCIgZXJyb3JcbiAgICAgIGlmIChcbiAgICAgICAgZXJyb3IuY29kZSAhPSAxNzAwNyAmJlxuICAgICAgICAhZXJyb3IubWVzc2FnZS5tYXRjaCgvdW5hYmxlIHRvIGZpbmQgaW5kZXggZm9yIC5nZW9OZWFyLylcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICAgIC8vIEZpZ3VyZSBvdXQgd2hhdCBrZXkgbmVlZHMgYW4gaW5kZXhcbiAgICAgIGNvbnN0IGtleSA9IGVycm9yLm1lc3NhZ2UubWF0Y2goL2ZpZWxkPShbQS1aYS16XzAtOV0rKSAvKVsxXTtcbiAgICAgIGlmICgha2V5KSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuXG4gICAgICB2YXIgaW5kZXggPSB7fTtcbiAgICAgIGluZGV4W2tleV0gPSAnMmQnO1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uXG4gICAgICAgICAgLmNyZWF0ZUluZGV4KGluZGV4KVxuICAgICAgICAgIC8vIFJldHJ5LCBidXQganVzdCBvbmNlLlxuICAgICAgICAgIC50aGVuKCgpID0+XG4gICAgICAgICAgICB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgICAgICAgICAnZmluZCcsXG4gICAgICAgICAgICAgIHRoaXMuX3Jhd0ZpbmQocXVlcnksIHtcbiAgICAgICAgICAgICAgICBza2lwLFxuICAgICAgICAgICAgICAgIGxpbWl0LFxuICAgICAgICAgICAgICAgIHNvcnQsXG4gICAgICAgICAgICAgICAga2V5cyxcbiAgICAgICAgICAgICAgICBtYXhUaW1lTVMsXG4gICAgICAgICAgICAgICAgcmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgICAgICAgaGludCxcbiAgICAgICAgICAgICAgICBjYXNlSW5zZW5zaXRpdmUsXG4gICAgICAgICAgICAgICAgZXhwbGFpbixcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIClcbiAgICAgICAgICApXG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbGxhdGlvbiB0byBzdXBwb3J0IGNhc2UgaW5zZW5zaXRpdmUgcXVlcmllc1xuICAgKi9cbiAgc3RhdGljIGNhc2VJbnNlbnNpdGl2ZUNvbGxhdGlvbigpIHtcbiAgICByZXR1cm4geyBsb2NhbGU6ICdlbl9VUycsIHN0cmVuZ3RoOiAyIH07XG4gIH1cblxuICBfcmF3RmluZChcbiAgICBxdWVyeSxcbiAgICB7XG4gICAgICBza2lwLFxuICAgICAgbGltaXQsXG4gICAgICBzb3J0LFxuICAgICAga2V5cyxcbiAgICAgIG1heFRpbWVNUyxcbiAgICAgIHJlYWRQcmVmZXJlbmNlLFxuICAgICAgaGludCxcbiAgICAgIGNhc2VJbnNlbnNpdGl2ZSxcbiAgICAgIGV4cGxhaW4sXG4gICAgfSA9IHt9XG4gICkge1xuICAgIGxldCBmaW5kT3BlcmF0aW9uID0gdGhpcy5fbW9uZ29Db2xsZWN0aW9uLmZpbmQocXVlcnksIHtcbiAgICAgIHNraXAsXG4gICAgICBsaW1pdCxcbiAgICAgIHNvcnQsXG4gICAgICByZWFkUHJlZmVyZW5jZSxcbiAgICAgIGhpbnQsXG4gICAgfSk7XG5cbiAgICBpZiAoa2V5cykge1xuICAgICAgZmluZE9wZXJhdGlvbiA9IGZpbmRPcGVyYXRpb24ucHJvamVjdChrZXlzKTtcbiAgICB9XG5cbiAgICBpZiAoY2FzZUluc2Vuc2l0aXZlKSB7XG4gICAgICBmaW5kT3BlcmF0aW9uID0gZmluZE9wZXJhdGlvbi5jb2xsYXRpb24oXG4gICAgICAgIE1vbmdvQ29sbGVjdGlvbi5jYXNlSW5zZW5zaXRpdmVDb2xsYXRpb24oKVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAobWF4VGltZU1TKSB7XG4gICAgICBmaW5kT3BlcmF0aW9uID0gZmluZE9wZXJhdGlvbi5tYXhUaW1lTVMobWF4VGltZU1TKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZXhwbGFpbiA/IGZpbmRPcGVyYXRpb24uZXhwbGFpbihleHBsYWluKSA6IGZpbmRPcGVyYXRpb24udG9BcnJheSgpO1xuICB9XG5cbiAgY291bnQocXVlcnksIHsgc2tpcCwgbGltaXQsIHNvcnQsIG1heFRpbWVNUywgcmVhZFByZWZlcmVuY2UsIGhpbnQgfSA9IHt9KSB7XG4gICAgLy8gSWYgcXVlcnkgaXMgZW1wdHksIHRoZW4gdXNlIGVzdGltYXRlZERvY3VtZW50Q291bnQgaW5zdGVhZC5cbiAgICAvLyBUaGlzIGlzIGR1ZSB0byBjb3VudERvY3VtZW50cyBwZXJmb3JtaW5nIGEgc2NhbixcbiAgICAvLyB3aGljaCBncmVhdGx5IGluY3JlYXNlcyBleGVjdXRpb24gdGltZSB3aGVuIGJlaW5nIHJ1biBvbiBsYXJnZSBjb2xsZWN0aW9ucy5cbiAgICAvLyBTZWUgaHR0cHM6Ly9naXRodWIuY29tL0F1dG9tYXR0aWMvbW9uZ29vc2UvaXNzdWVzLzY3MTMgZm9yIG1vcmUgaW5mbyByZWdhcmRpbmcgdGhpcyBwcm9ibGVtLlxuICAgIGlmICh0eXBlb2YgcXVlcnkgIT09ICdvYmplY3QnIHx8ICFPYmplY3Qua2V5cyhxdWVyeSkubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcbiAgICAgICAgJ2VzdGltYXRlZERvY3VtZW50Q291bnQnLFxuICAgICAgICB0aGlzLl9tb25nb0NvbGxlY3Rpb24uZXN0aW1hdGVkRG9jdW1lbnRDb3VudCh7XG4gICAgICAgICAgbWF4VGltZU1TLFxuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBjb3VudE9wZXJhdGlvbiA9IHRoaXMuX2V4ZWN1dGVXaXRoVHJhY2UoXG4gICAgICAnY291bnREb2N1bWVudHMnLFxuICAgICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLmNvdW50RG9jdW1lbnRzKHF1ZXJ5LCB7XG4gICAgICAgIHNraXAsXG4gICAgICAgIGxpbWl0LFxuICAgICAgICBzb3J0LFxuICAgICAgICBtYXhUaW1lTVMsXG4gICAgICAgIHJlYWRQcmVmZXJlbmNlLFxuICAgICAgICBoaW50LFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgcmV0dXJuIGNvdW50T3BlcmF0aW9uO1xuICB9XG5cbiAgZGlzdGluY3QoZmllbGQsIHF1ZXJ5KSB7XG4gICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVXaXRoVHJhY2UoXG4gICAgICAnZGlzdGluY3QnLFxuICAgICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLmRpc3RpbmN0KGZpZWxkLCBxdWVyeSlcbiAgICApO1xuICB9XG5cbiAgYWdncmVnYXRlKHBpcGVsaW5lLCB7IG1heFRpbWVNUywgcmVhZFByZWZlcmVuY2UsIGhpbnQsIGV4cGxhaW4gfSA9IHt9KSB7XG4gICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVXaXRoVHJhY2UoXG4gICAgICAnYWdncmVnYXRlJyxcbiAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvblxuICAgICAgICAuYWdncmVnYXRlKHBpcGVsaW5lLCB7IG1heFRpbWVNUywgcmVhZFByZWZlcmVuY2UsIGhpbnQsIGV4cGxhaW4gfSlcbiAgICAgICAgLnRvQXJyYXkoKVxuICAgICk7XG4gIH1cblxuICBpbnNlcnRPbmUob2JqZWN0LCBzZXNzaW9uKSB7XG4gICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVXaXRoVHJhY2UoXG4gICAgICAnaW5zZXJ0T25lJyxcbiAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5pbnNlcnRPbmUob2JqZWN0LCB7IHNlc3Npb24gfSlcbiAgICApO1xuICB9XG5cbiAgaW5zZXJ0TWFueShvYmplY3QsIHNlc3Npb24pIHtcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcbiAgICAgICdpbnNlcnRNYW55JyxcbiAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5pbnNlcnRNYW55KG9iamVjdCwgeyBzZXNzaW9uIH0pXG4gICAgKTtcbiAgfVxuXG4gIC8vIEF0b21pY2FsbHkgdXBkYXRlcyBkYXRhIGluIHRoZSBkYXRhYmFzZSBmb3IgYSBzaW5nbGUgKGZpcnN0KSBvYmplY3QgdGhhdCBtYXRjaGVkIHRoZSBxdWVyeVxuICAvLyBJZiB0aGVyZSBpcyBub3RoaW5nIHRoYXQgbWF0Y2hlcyB0aGUgcXVlcnkgLSBkb2VzIGluc2VydFxuICAvLyBQb3N0Z3JlcyBOb3RlOiBgSU5TRVJUIC4uLiBPTiBDT05GTElDVCBVUERBVEVgIHRoYXQgaXMgYXZhaWxhYmxlIHNpbmNlIDkuNS5cbiAgdXBzZXJ0T25lKHF1ZXJ5LCB1cGRhdGUsIHNlc3Npb24pIHtcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcbiAgICAgICd1cHNlcnRPbmUnLFxuICAgICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLnVwZGF0ZU9uZShxdWVyeSwgdXBkYXRlLCB7XG4gICAgICAgIHVwc2VydDogdHJ1ZSxcbiAgICAgICAgc2Vzc2lvbixcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHVwZGF0ZU9uZShxdWVyeSwgdXBkYXRlKSB7XG4gICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVXaXRoVHJhY2UoXG4gICAgICAndXBkYXRlT25lJyxcbiAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbi51cGRhdGVPbmUocXVlcnksIHVwZGF0ZSlcbiAgICApO1xuICB9XG5cbiAgdXBkYXRlTWFueShxdWVyeSwgdXBkYXRlLCBzZXNzaW9uKSB7XG4gICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVXaXRoVHJhY2UoXG4gICAgICAndXBkYXRlTWFueScsXG4gICAgICB0aGlzLl9tb25nb0NvbGxlY3Rpb24udXBkYXRlTWFueShxdWVyeSwgdXBkYXRlLCB7IHNlc3Npb24gfSlcbiAgICApO1xuICB9XG5cbiAgZGVsZXRlTWFueShxdWVyeSwgc2Vzc2lvbikge1xuICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgJ2RlbGV0ZU1hbnknLFxuICAgICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLmRlbGV0ZU1hbnkocXVlcnksIHsgc2Vzc2lvbiB9KVxuICAgICk7XG4gIH1cblxuICBfZW5zdXJlU3BhcnNlVW5pcXVlSW5kZXhJbkJhY2tncm91bmQoaW5kZXhSZXF1ZXN0KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5jcmVhdGVJbmRleChcbiAgICAgICAgaW5kZXhSZXF1ZXN0LFxuICAgICAgICB7IHVuaXF1ZTogdHJ1ZSwgYmFja2dyb3VuZDogdHJ1ZSwgc3BhcnNlOiB0cnVlIH0sXG4gICAgICAgIGVycm9yID0+IHtcbiAgICAgICAgICBpZiAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBkcm9wKCkge1xuICAgIHJldHVybiB0aGlzLl9tb25nb0NvbGxlY3Rpb24uZHJvcCgpO1xuICB9XG5cbiAgX2V4ZWN1dGVXaXRoVHJhY2UodHlwZSwgZm4sIHF1ZXJ5KSB7XG4gICAgY29uc3QgcGFyZW50ID0gQVdTWFJheS5nZXRTZWdtZW50KCk7XG4gICAgaWYgKCFwYXJlbnQpIHtcbiAgICAgIHJldHVybiBmbjtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIEFXU1hSYXkuY2FwdHVyZUFzeW5jRnVuYyhgTW9uZ29EQl8ke3RoaXMuX21vbmdvQ29sbGVjdGlvbi5jb2xsZWN0aW9uTmFtZX1gLCBzdWJzZWdtZW50ID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBzdWJzZWdtZW50ICYmIHN1YnNlZ21lbnQuYWRkQW5ub3RhdGlvbignY29sbGVjdGlvbicsIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5jb2xsZWN0aW9uTmFtZSk7XG4gICAgICAgICAgc3Vic2VnbWVudCAmJiBzdWJzZWdtZW50LmFkZEFubm90YXRpb24oJ3F1ZXJ5JywgdHlwZSk7XG4gICAgICAgICAgaWYgKHF1ZXJ5ICYmIHR5cGVvZiBxdWVyeSA9PT0gXCJvYmplY3RcIikge1xuICAgICAgICAgICAgc3Vic2VnbWVudCAmJiBzdWJzZWdtZW50LmFkZEFubm90YXRpb24oJ3doZXJlJywgSlNPTi5zdHJpbmdpZnkocXVlcnkpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgLy9cbiAgICAgICAgfVxuICAgICAgICBmbi50aGVuKFxuICAgICAgICAgIGZ1bmN0aW9uKHJlc3VsdCkge1xuICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgICAgc3Vic2VnbWVudCAmJiBzdWJzZWdtZW50LmNsb3NlKCk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBmdW5jdGlvbihlcnJvcikge1xuICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgIHN1YnNlZ21lbnQgJiYgc3Vic2VnbWVudC5jbG9zZShlcnJvcik7XG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==