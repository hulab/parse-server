"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

const AWSXRay = require('hulab-xray-sdk');

const mongodb = require('mongodb');

const Collection = mongodb.Collection;

class MongoCollection {
  constructor(mongoCollection) {
    this._mongoCollection = mongoCollection;
  } // Does a find with "smart indexing".
  // Currently this just means, if it needs a geoindex and there is
  // none, then build the geoindex.
  // This could be improved a lot but it's not clear if that's a good
  // idea. Or even if this behavior is a good idea.


  find(query, {
    skip,
    limit,
    sort,
    keys,
    maxTimeMS,
    readPreference
  } = {}) {
    // Support for Full Text Search - $text
    if (keys && keys.$score) {
      delete keys.$score;
      keys.score = {
        $meta: 'textScore'
      };
    }

    return this._executeWithTrace('find', this._rawFind(query, {
      skip,
      limit,
      sort,
      keys,
      maxTimeMS,
      readPreference
    }), query).catch(error => {
      // Check for "no geoindex" error
      if (error.code != 17007 && !error.message.match(/unable to find index for .geoNear/)) {
        throw error;
      } // Figure out what key needs an index


      const key = error.message.match(/field=([A-Za-z_0-9]+) /)[1];

      if (!key) {
        throw error;
      }

      var index = {};
      index[key] = '2d';
      return this._mongoCollection.createIndex(index) // Retry, but just once.
      .then(() => this._executeWithTrace('find', this._rawFind(query, {
        skip,
        limit,
        sort,
        keys,
        maxTimeMS,
        readPreference
      })));
    });
  }

  _rawFind(query, {
    skip,
    limit,
    sort,
    keys,
    maxTimeMS,
    readPreference
  } = {}) {
    let findOperation = this._mongoCollection.find(query, {
      skip,
      limit,
      sort,
      readPreference
    });

    if (keys) {
      findOperation = findOperation.project(keys);
    }

    if (maxTimeMS) {
      findOperation = findOperation.maxTimeMS(maxTimeMS);
    }

    return findOperation.toArray();
  }

  count(query, {
    skip,
    limit,
    sort,
    maxTimeMS,
    readPreference
  } = {}) {
    // If query is empty, then use estimatedDocumentCount instead.
    // This is due to countDocuments performing a scan,
    // which greatly increases execution time when being run on large collections.
    // See https://github.com/Automattic/mongoose/issues/6713 for more info regarding this problem.
    if (typeof query !== 'object' || !Object.keys(query).length) {
      return this._executeWithTrace('estimatedDocumentCount', this._mongoCollection.estimatedDocumentCount({
        maxTimeMS
      }));
    }

    const countOperation = this._executeWithTrace('countDocuments', this._mongoCollection.countDocuments(query, {
      skip,
      limit,
      sort,
      maxTimeMS,
      readPreference
    }));

    return countOperation;
  }

  distinct(field, query) {
    return this._executeWithTrace('distinct', this._mongoCollection.distinct(field, query));
  }

  aggregate(pipeline, {
    maxTimeMS,
    readPreference
  } = {}) {
    return this._executeWithTrace('aggregate', this._mongoCollection.aggregate(pipeline, {
      maxTimeMS,
      readPreference
    }).toArray());
  }

  insertOne(object, session) {
    return this._executeWithTrace('insertOne', this._mongoCollection.insertOne(object, {
      session
    }));
  }

  insertMany(object, session) {
    return this._executeWithTrace('insertMany', this._mongoCollection.insertMany(object, {
      session
    }));
  } // Atomically updates data in the database for a single (first) object that matched the query
  // If there is nothing that matches the query - does insert
  // Postgres Note: `INSERT ... ON CONFLICT UPDATE` that is available since 9.5.


  upsertOne(query, update, session) {
    return this._executeWithTrace('upsertOne', this._mongoCollection.updateOne(query, update, {
      upsert: true,
      session
    }));
  }

  updateOne(query, update) {
    return this._executeWithTrace('updateOne', this._mongoCollection.updateOne(query, update));
  }

  updateMany(query, update, session) {
    return this._executeWithTrace('updateMany', this._mongoCollection.updateMany(query, update, {
      session
    }));
  }

  deleteMany(query, session) {
    return this._executeWithTrace('deleteMany', this._mongoCollection.deleteMany(query, {
      session
    }));
  }

  _ensureSparseUniqueIndexInBackground(indexRequest) {
    return new Promise((resolve, reject) => {
      this._mongoCollection.createIndex(indexRequest, {
        unique: true,
        background: true,
        sparse: true
      }, error => {
        if (error) {
          reject(error);
        } else {
          resolve();
        }
      });
    });
  }

  drop() {
    return this._mongoCollection.drop();
  }

  _executeWithTrace(type, fn, query) {
    const parent = AWSXRay.getSegment();

    if (!parent) {
      return fn;
    }

    return new Promise((resolve, reject) => {
      AWSXRay.captureAsyncFunc(`MongoDB_${this._mongoCollection.collectionName}`, subsegment => {
        try {
          subsegment && subsegment.addAnnotation('collection', this._mongoCollection.collectionName);
          subsegment && subsegment.addAnnotation('query', type);

          if (query && typeof query === "object") {
            subsegment && subsegment.addAnnotation('where', JSON.stringify(query));
          }
        } catch (error) {//
        }

        fn.then(function (result) {
          resolve(result);
          subsegment && subsegment.close();
        }, function (error) {
          reject(error);
          subsegment && subsegment.close(error);
        });
      });
    });
  }

}

exports.default = MongoCollection;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9BZGFwdGVycy9TdG9yYWdlL01vbmdvL01vbmdvQ29sbGVjdGlvbi5qcyJdLCJuYW1lcyI6WyJBV1NYUmF5IiwicmVxdWlyZSIsIm1vbmdvZGIiLCJDb2xsZWN0aW9uIiwiTW9uZ29Db2xsZWN0aW9uIiwiY29uc3RydWN0b3IiLCJtb25nb0NvbGxlY3Rpb24iLCJfbW9uZ29Db2xsZWN0aW9uIiwiZmluZCIsInF1ZXJ5Iiwic2tpcCIsImxpbWl0Iiwic29ydCIsImtleXMiLCJtYXhUaW1lTVMiLCJyZWFkUHJlZmVyZW5jZSIsIiRzY29yZSIsInNjb3JlIiwiJG1ldGEiLCJfZXhlY3V0ZVdpdGhUcmFjZSIsIl9yYXdGaW5kIiwiY2F0Y2giLCJlcnJvciIsImNvZGUiLCJtZXNzYWdlIiwibWF0Y2giLCJrZXkiLCJpbmRleCIsImNyZWF0ZUluZGV4IiwidGhlbiIsImZpbmRPcGVyYXRpb24iLCJwcm9qZWN0IiwidG9BcnJheSIsImNvdW50IiwiT2JqZWN0IiwibGVuZ3RoIiwiZXN0aW1hdGVkRG9jdW1lbnRDb3VudCIsImNvdW50T3BlcmF0aW9uIiwiY291bnREb2N1bWVudHMiLCJkaXN0aW5jdCIsImZpZWxkIiwiYWdncmVnYXRlIiwicGlwZWxpbmUiLCJpbnNlcnRPbmUiLCJvYmplY3QiLCJzZXNzaW9uIiwiaW5zZXJ0TWFueSIsInVwc2VydE9uZSIsInVwZGF0ZSIsInVwZGF0ZU9uZSIsInVwc2VydCIsInVwZGF0ZU1hbnkiLCJkZWxldGVNYW55IiwiX2Vuc3VyZVNwYXJzZVVuaXF1ZUluZGV4SW5CYWNrZ3JvdW5kIiwiaW5kZXhSZXF1ZXN0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJ1bmlxdWUiLCJiYWNrZ3JvdW5kIiwic3BhcnNlIiwiZHJvcCIsInR5cGUiLCJmbiIsInBhcmVudCIsImdldFNlZ21lbnQiLCJjYXB0dXJlQXN5bmNGdW5jIiwiY29sbGVjdGlvbk5hbWUiLCJzdWJzZWdtZW50IiwiYWRkQW5ub3Rh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QyxVQUFBQSxNQUFNLENBQUNuQyxLQUFELENBQU47QUFDQThDLFVBQUFBLFVBQVUsSUFBSUEsVUFBVSxDQUFDSyxLQUFYLENBQWlCbkQsS0FBakIsQ0FBZDtBQUNELFNBUkg7QUFVRCxPQXBCRDtBQXFCRCxLQXRCTSxDQUFQO0FBdUJEOztBQWhPa0MiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBBV1NYUmF5ID0gcmVxdWlyZSgnaHVsYWIteHJheS1zZGsnKTtcbmNvbnN0IG1vbmdvZGIgPSByZXF1aXJlKCdtb25nb2RiJyk7XG5jb25zdCBDb2xsZWN0aW9uID0gbW9uZ29kYi5Db2xsZWN0aW9uO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNb25nb0NvbGxlY3Rpb24ge1xuICBfbW9uZ29Db2xsZWN0aW9uOiBDb2xsZWN0aW9uO1xuXG4gIGNvbnN0cnVjdG9yKG1vbmdvQ29sbGVjdGlvbjogQ29sbGVjdGlvbikge1xuICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbiA9IG1vbmdvQ29sbGVjdGlvbjtcbiAgfVxuXG4gIC8vIERvZXMgYSBmaW5kIHdpdGggXCJzbWFydCBpbmRleGluZ1wiLlxuICAvLyBDdXJyZW50bHkgdGhpcyBqdXN0IG1lYW5zLCBpZiBpdCBuZWVkcyBhIGdlb2luZGV4IGFuZCB0aGVyZSBpc1xuICAvLyBub25lLCB0aGVuIGJ1aWxkIHRoZSBnZW9pbmRleC5cbiAgLy8gVGhpcyBjb3VsZCBiZSBpbXByb3ZlZCBhIGxvdCBidXQgaXQncyBub3QgY2xlYXIgaWYgdGhhdCdzIGEgZ29vZFxuICAvLyBpZGVhLiBPciBldmVuIGlmIHRoaXMgYmVoYXZpb3IgaXMgYSBnb29kIGlkZWEuXG4gIGZpbmQocXVlcnksIHsgc2tpcCwgbGltaXQsIHNvcnQsIGtleXMsIG1heFRpbWVNUywgcmVhZFByZWZlcmVuY2UgfSA9IHt9KSB7XG4gICAgLy8gU3VwcG9ydCBmb3IgRnVsbCBUZXh0IFNlYXJjaCAtICR0ZXh0XG4gICAgaWYgKGtleXMgJiYga2V5cy4kc2NvcmUpIHtcbiAgICAgIGRlbGV0ZSBrZXlzLiRzY29yZTtcbiAgICAgIGtleXMuc2NvcmUgPSB7ICRtZXRhOiAndGV4dFNjb3JlJyB9O1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcbiAgICAgICdmaW5kJyxcbiAgICAgIHRoaXMuX3Jhd0ZpbmQocXVlcnksIHtcbiAgICAgICAgc2tpcCxcbiAgICAgICAgbGltaXQsXG4gICAgICAgIHNvcnQsXG4gICAgICAgIGtleXMsXG4gICAgICAgIG1heFRpbWVNUyxcbiAgICAgICAgcmVhZFByZWZlcmVuY2UsXG4gICAgICB9KSwgcXVlcnlcbiAgICApLmNhdGNoKGVycm9yID0+IHtcbiAgICAgIC8vIENoZWNrIGZvciBcIm5vIGdlb2luZGV4XCIgZXJyb3JcbiAgICAgIGlmIChcbiAgICAgICAgZXJyb3IuY29kZSAhPSAxNzAwNyAmJlxuICAgICAgICAhZXJyb3IubWVzc2FnZS5tYXRjaCgvdW5hYmxlIHRvIGZpbmQgaW5kZXggZm9yIC5nZW9OZWFyLylcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICAgIC8vIEZpZ3VyZSBvdXQgd2hhdCBrZXkgbmVlZHMgYW4gaW5kZXhcbiAgICAgIGNvbnN0IGtleSA9IGVycm9yLm1lc3NhZ2UubWF0Y2goL2ZpZWxkPShbQS1aYS16XzAtOV0rKSAvKVsxXTtcbiAgICAgIGlmICgha2V5KSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuXG4gICAgICB2YXIgaW5kZXggPSB7fTtcbiAgICAgIGluZGV4W2tleV0gPSAnMmQnO1xuICAgICAgcmV0dXJuIChcbiAgICAgICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uXG4gICAgICAgICAgLmNyZWF0ZUluZGV4KGluZGV4KVxuICAgICAgICAgIC8vIFJldHJ5LCBidXQganVzdCBvbmNlLlxuICAgICAgICAgIC50aGVuKCgpID0+XG4gICAgICAgICAgICB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgICAgICAgICAnZmluZCcsXG4gICAgICAgICAgICAgIHRoaXMuX3Jhd0ZpbmQocXVlcnksIHtcbiAgICAgICAgICAgICAgICBza2lwLFxuICAgICAgICAgICAgICAgIGxpbWl0LFxuICAgICAgICAgICAgICAgIHNvcnQsXG4gICAgICAgICAgICAgICAga2V5cyxcbiAgICAgICAgICAgICAgICBtYXhUaW1lTVMsXG4gICAgICAgICAgICAgICAgcmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApXG4gICAgICAgICAgKVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIF9yYXdGaW5kKHF1ZXJ5LCB7IHNraXAsIGxpbWl0LCBzb3J0LCBrZXlzLCBtYXhUaW1lTVMsIHJlYWRQcmVmZXJlbmNlIH0gPSB7fSkge1xuICAgIGxldCBmaW5kT3BlcmF0aW9uID0gdGhpcy5fbW9uZ29Db2xsZWN0aW9uLmZpbmQocXVlcnksIHtcbiAgICAgIHNraXAsXG4gICAgICBsaW1pdCxcbiAgICAgIHNvcnQsXG4gICAgICByZWFkUHJlZmVyZW5jZSxcbiAgICB9KTtcblxuICAgIGlmIChrZXlzKSB7XG4gICAgICBmaW5kT3BlcmF0aW9uID0gZmluZE9wZXJhdGlvbi5wcm9qZWN0KGtleXMpO1xuICAgIH1cblxuICAgIGlmIChtYXhUaW1lTVMpIHtcbiAgICAgIGZpbmRPcGVyYXRpb24gPSBmaW5kT3BlcmF0aW9uLm1heFRpbWVNUyhtYXhUaW1lTVMpO1xuICAgIH1cblxuICAgIHJldHVybiBmaW5kT3BlcmF0aW9uLnRvQXJyYXkoKTtcbiAgfVxuXG4gIGNvdW50KHF1ZXJ5LCB7IHNraXAsIGxpbWl0LCBzb3J0LCBtYXhUaW1lTVMsIHJlYWRQcmVmZXJlbmNlIH0gPSB7fSkge1xuICAgIC8vIElmIHF1ZXJ5IGlzIGVtcHR5LCB0aGVuIHVzZSBlc3RpbWF0ZWREb2N1bWVudENvdW50IGluc3RlYWQuXG4gICAgLy8gVGhpcyBpcyBkdWUgdG8gY291bnREb2N1bWVudHMgcGVyZm9ybWluZyBhIHNjYW4sXG4gICAgLy8gd2hpY2ggZ3JlYXRseSBpbmNyZWFzZXMgZXhlY3V0aW9uIHRpbWUgd2hlbiBiZWluZyBydW4gb24gbGFyZ2UgY29sbGVjdGlvbnMuXG4gICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9BdXRvbWF0dGljL21vbmdvb3NlL2lzc3Vlcy82NzEzIGZvciBtb3JlIGluZm8gcmVnYXJkaW5nIHRoaXMgcHJvYmxlbS5cbiAgICBpZiAodHlwZW9mIHF1ZXJ5ICE9PSAnb2JqZWN0JyB8fCAhT2JqZWN0LmtleXMocXVlcnkpLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVXaXRoVHJhY2UoXG4gICAgICAgICdlc3RpbWF0ZWREb2N1bWVudENvdW50JyxcbiAgICAgICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLmVzdGltYXRlZERvY3VtZW50Q291bnQoe1xuICAgICAgICAgIG1heFRpbWVNUyxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgY291bnRPcGVyYXRpb24gPSB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgJ2NvdW50RG9jdW1lbnRzJyxcbiAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5jb3VudERvY3VtZW50cyhxdWVyeSwge1xuICAgICAgICBza2lwLFxuICAgICAgICBsaW1pdCxcbiAgICAgICAgc29ydCxcbiAgICAgICAgbWF4VGltZU1TLFxuICAgICAgICByZWFkUHJlZmVyZW5jZSxcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHJldHVybiBjb3VudE9wZXJhdGlvbjtcbiAgfVxuXG4gIGRpc3RpbmN0KGZpZWxkLCBxdWVyeSkge1xuICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgJ2Rpc3RpbmN0JyxcbiAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5kaXN0aW5jdChmaWVsZCwgcXVlcnkpXG4gICAgKTtcbiAgfVxuXG4gIGFnZ3JlZ2F0ZShwaXBlbGluZSwgeyBtYXhUaW1lTVMsIHJlYWRQcmVmZXJlbmNlIH0gPSB7fSkge1xuICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgJ2FnZ3JlZ2F0ZScsXG4gICAgICB0aGlzLl9tb25nb0NvbGxlY3Rpb25cbiAgICAgICAgLmFnZ3JlZ2F0ZShwaXBlbGluZSwgeyBtYXhUaW1lTVMsIHJlYWRQcmVmZXJlbmNlIH0pXG4gICAgICAgIC50b0FycmF5KClcbiAgICApO1xuICB9XG5cbiAgaW5zZXJ0T25lKG9iamVjdCwgc2Vzc2lvbikge1xuICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgJ2luc2VydE9uZScsXG4gICAgICB0aGlzLl9tb25nb0NvbGxlY3Rpb24uaW5zZXJ0T25lKG9iamVjdCwgeyBzZXNzaW9uIH0pXG4gICAgKTtcbiAgfVxuXG4gIGluc2VydE1hbnkob2JqZWN0LCBzZXNzaW9uKSB7XG4gICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVXaXRoVHJhY2UoXG4gICAgICAnaW5zZXJ0TWFueScsXG4gICAgICB0aGlzLl9tb25nb0NvbGxlY3Rpb24uaW5zZXJ0TWFueShvYmplY3QsIHsgc2Vzc2lvbiB9KVxuICAgICk7XG4gIH1cblxuICAvLyBBdG9taWNhbGx5IHVwZGF0ZXMgZGF0YSBpbiB0aGUgZGF0YWJhc2UgZm9yIGEgc2luZ2xlIChmaXJzdCkgb2JqZWN0IHRoYXQgbWF0Y2hlZCB0aGUgcXVlcnlcbiAgLy8gSWYgdGhlcmUgaXMgbm90aGluZyB0aGF0IG1hdGNoZXMgdGhlIHF1ZXJ5IC0gZG9lcyBpbnNlcnRcbiAgLy8gUG9zdGdyZXMgTm90ZTogYElOU0VSVCAuLi4gT04gQ09ORkxJQ1QgVVBEQVRFYCB0aGF0IGlzIGF2YWlsYWJsZSBzaW5jZSA5LjUuXG4gIHVwc2VydE9uZShxdWVyeSwgdXBkYXRlLCBzZXNzaW9uKSB7XG4gICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVXaXRoVHJhY2UoXG4gICAgICAndXBzZXJ0T25lJyxcbiAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbi51cGRhdGVPbmUocXVlcnksIHVwZGF0ZSwge1xuICAgICAgICB1cHNlcnQ6IHRydWUsXG4gICAgICAgIHNlc3Npb24sXG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICB1cGRhdGVPbmUocXVlcnksIHVwZGF0ZSkge1xuICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgJ3VwZGF0ZU9uZScsXG4gICAgICB0aGlzLl9tb25nb0NvbGxlY3Rpb24udXBkYXRlT25lKHF1ZXJ5LCB1cGRhdGUpXG4gICAgKTtcbiAgfVxuXG4gIHVwZGF0ZU1hbnkocXVlcnksIHVwZGF0ZSwgc2Vzc2lvbikge1xuICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgJ3VwZGF0ZU1hbnknLFxuICAgICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLnVwZGF0ZU1hbnkocXVlcnksIHVwZGF0ZSwgeyBzZXNzaW9uIH0pXG4gICAgKTtcbiAgfVxuXG4gIGRlbGV0ZU1hbnkocXVlcnksIHNlc3Npb24pIHtcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcbiAgICAgICdkZWxldGVNYW55JyxcbiAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5kZWxldGVNYW55KHF1ZXJ5LCB7IHNlc3Npb24gfSlcbiAgICApO1xuICB9XG5cbiAgX2Vuc3VyZVNwYXJzZVVuaXF1ZUluZGV4SW5CYWNrZ3JvdW5kKGluZGV4UmVxdWVzdCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICB0aGlzLl9tb25nb0NvbGxlY3Rpb24uY3JlYXRlSW5kZXgoXG4gICAgICAgIGluZGV4UmVxdWVzdCxcbiAgICAgICAgeyB1bmlxdWU6IHRydWUsIGJhY2tncm91bmQ6IHRydWUsIHNwYXJzZTogdHJ1ZSB9LFxuICAgICAgICBlcnJvciA9PiB7XG4gICAgICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgZHJvcCgpIHtcbiAgICByZXR1cm4gdGhpcy5fbW9uZ29Db2xsZWN0aW9uLmRyb3AoKTtcbiAgfVxuXG4gIF9leGVjdXRlV2l0aFRyYWNlKHR5cGUsIGZuLCBxdWVyeSkge1xuICAgIGNvbnN0IHBhcmVudCA9IEFXU1hSYXkuZ2V0U2VnbWVudCgpO1xuICAgIGlmICghcGFyZW50KSB7XG4gICAgICByZXR1cm4gZm47XG4gICAgfVxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBBV1NYUmF5LmNhcHR1cmVBc3luY0Z1bmMoYE1vbmdvREJfJHt0aGlzLl9tb25nb0NvbGxlY3Rpb24uY29sbGVjdGlvbk5hbWV9YCwgc3Vic2VnbWVudCA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgc3Vic2VnbWVudCAmJiBzdWJzZWdtZW50LmFkZEFubm90YXRpb24oJ2NvbGxlY3Rpb24nLCB0aGlzLl9tb25nb0NvbGxlY3Rpb24uY29sbGVjdGlvbk5hbWUpO1xuICAgICAgICAgIHN1YnNlZ21lbnQgJiYgc3Vic2VnbWVudC5hZGRBbm5vdGF0aW9uKCdxdWVyeScsIHR5cGUpO1xuICAgICAgICAgIGlmIChxdWVyeSAmJiB0eXBlb2YgcXVlcnkgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICAgIHN1YnNlZ21lbnQgJiYgc3Vic2VnbWVudC5hZGRBbm5vdGF0aW9uKCd3aGVyZScsIEpTT04uc3RyaW5naWZ5KHF1ZXJ5KSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIC8vXG4gICAgICAgIH1cbiAgICAgICAgZm4udGhlbihcbiAgICAgICAgICBmdW5jdGlvbihyZXN1bHQpIHtcbiAgICAgICAgICAgIHJlc29sdmUocmVzdWx0KTtcbiAgICAgICAgICAgIHN1YnNlZ21lbnQgJiYgc3Vic2VnbWVudC5jbG9zZSgpO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgZnVuY3Rpb24oZXJyb3IpIHtcbiAgICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICAgICAgICBzdWJzZWdtZW50ICYmIHN1YnNlZ21lbnQuY2xvc2UoZXJyb3IpO1xuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG59XG4iXX0=