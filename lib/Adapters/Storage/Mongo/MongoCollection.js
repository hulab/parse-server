"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

const AWSXRay = require('hulab-xray-sdk');

const mongodb = require('mongodb');

const Collection = mongodb.Collection;

class MongoCollection {
  constructor(mongoCollection) {
    this._mongoCollection = mongoCollection;
  } // Does a find with "smart indexing".
  // Currently this just means, if it needs a geoindex and there is
  // none, then build the geoindex.
  // This could be improved a lot but it's not clear if that's a good
  // idea. Or even if this behavior is a good idea.


  find(query, {
    skip,
    limit,
    sort,
    keys,
    maxTimeMS,
    readPreference,
    hint,
    caseInsensitive,
    explain
  } = {}) {
    // Support for Full Text Search - $text
    if (keys && keys.$score) {
      delete keys.$score;
      keys.score = {
        $meta: 'textScore'
      };
    }

    return this._executeWithTrace('find', this._rawFind(query, {
      skip,
      limit,
      sort,
      keys,
      maxTimeMS,
      readPreference,
      hint,
      caseInsensitive,
      explain
    }), query).catch(error => {
      // Check for "no geoindex" error
      if (error.code != 17007 && !error.message.match(/unable to find index for .geoNear/)) {
        throw error;
      } // Figure out what key needs an index


      const key = error.message.match(/field=([A-Za-z_0-9]+) /)[1];

      if (!key) {
        throw error;
      }

      var index = {};
      index[key] = '2d';
      return this._mongoCollection.createIndex(index) // Retry, but just once.
      .then(() => this._executeWithTrace('find', this._rawFind(query, {
        skip,
        limit,
        sort,
        keys,
        maxTimeMS,
        readPreference,
        hint,
        caseInsensitive,
        explain
      })));
    });
  }
  /**
   * Collation to support case insensitive queries
   */


  static caseInsensitiveCollation() {
    return {
      locale: 'en_US',
      strength: 2
    };
  }

  _rawFind(query, {
    skip,
    limit,
    sort,
    keys,
    maxTimeMS,
    readPreference,
    hint,
    caseInsensitive,
    explain
  } = {}) {
    let findOperation = this._mongoCollection.find(query, {
      skip,
      limit,
      sort,
      readPreference,
      hint
    });

    if (keys) {
      findOperation = findOperation.project(keys);
    }

    if (caseInsensitive) {
      findOperation = findOperation.collation(MongoCollection.caseInsensitiveCollation());
    }

    if (maxTimeMS) {
      findOperation = findOperation.maxTimeMS(maxTimeMS);
    }

    return explain ? findOperation.explain(explain) : findOperation.toArray();
  }

  count(query, {
    skip,
    limit,
    sort,
    maxTimeMS,
    readPreference,
    hint
  } = {}) {
    // If query is empty, then use estimatedDocumentCount instead.
    // This is due to countDocuments performing a scan,
    // which greatly increases execution time when being run on large collections.
    // See https://github.com/Automattic/mongoose/issues/6713 for more info regarding this problem.
    if (typeof query !== 'object' || !Object.keys(query).length) {
      return this._executeWithTrace('estimatedDocumentCount', this._mongoCollection.estimatedDocumentCount({
        maxTimeMS
      }));
    }

    const countOperation = this._executeWithTrace('countDocuments', this._mongoCollection.countDocuments(query, {
      skip,
      limit,
      sort,
      maxTimeMS,
      readPreference,
      hint
    }));

    return countOperation;
  }

  distinct(field, query) {
    return this._executeWithTrace('distinct', this._mongoCollection.distinct(field, query));
  }

  aggregate(pipeline, {
    maxTimeMS,
    readPreference,
    hint,
    explain
  } = {}) {
    return this._executeWithTrace('aggregate', this._mongoCollection.aggregate(pipeline, {
      maxTimeMS,
      readPreference,
      hint,
      explain
    }).toArray());
  }

  insertOne(object, session) {
    return this._executeWithTrace('insertOne', this._mongoCollection.insertOne(object, {
      session
    }));
  }

  insertMany(object, session) {
    return this._executeWithTrace('insertMany', this._mongoCollection.insertMany(object, {
      session
    }));
  } // Atomically updates data in the database for a single (first) object that matched the query
  // If there is nothing that matches the query - does insert
  // Postgres Note: `INSERT ... ON CONFLICT UPDATE` that is available since 9.5.


  upsertOne(query, update, session) {
    return this._executeWithTrace('upsertOne', this._mongoCollection.updateOne(query, update, {
      upsert: true,
      session
    }));
  }

  updateOne(query, update) {
    return this._executeWithTrace('updateOne', this._mongoCollection.updateOne(query, update));
  }

  updateMany(query, update, session) {
    return this._executeWithTrace('updateMany', this._mongoCollection.updateMany(query, update, {
      session
    }));
  }

  deleteMany(query, session) {
    return this._executeWithTrace('deleteMany', this._mongoCollection.deleteMany(query, {
      session
    }));
  }

  bulkWrite(operations, session) {
    return this._executeWithTrace('bulkwrite', this._mongoCollection.bulkWrite(operations, {
      ordered: false,
      session
    }));
  }

  _ensureSparseUniqueIndexInBackground(indexRequest) {
    return new Promise((resolve, reject) => {
      this._mongoCollection.createIndex(indexRequest, {
        unique: true,
        background: true,
        sparse: true
      }, error => {
        if (error) {
          reject(error);
        } else {
          resolve();
        }
      });
    });
  }

  drop() {
    return this._mongoCollection.drop();
  }

  _executeWithTrace(type, fn, query) {
    const parent = AWSXRay.getSegment();

    if (!parent) {
      return fn;
    }

    return new Promise((resolve, reject) => {
      AWSXRay.captureAsyncFunc(`MongoDB Atlas`, subsegment => {
        try {
          subsegment && subsegment.addAttribute('namespace', 'aws');
          subsegment.addAttribute('aws', {
            region: process.env.AWS_REGION,
            database: 'mapstr',
            operation: `${type.toUpperCase()} ${this._mongoCollection.collectionName}`,
            type,
            collection: this._mongoCollection.collectionName,
            retries: 0
          });
          subsegment && subsegment.addAnnotation('Collection', this._mongoCollection.collectionName);
          subsegment && subsegment.addAnnotation('Operation', type);

          if (query && typeof query === "object") {
            subsegment && subsegment.addMetadata('Query', JSON.stringify(query));
          }
        } catch (error) {//
        }

        fn.then(function (result) {
          resolve(result);
          subsegment && subsegment.addAttribute('http', {
            response: {
              status: 200
            }
          });
          subsegment && subsegment.close();
        }, function (error) {
          reject(error);
          subsegment && subsegment.close(error);
        });
      });
    });
  }

}

exports.default = MongoCollection;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9BZGFwdGVycy9TdG9yYWdlL01vbmdvL01vbmdvQ29sbGVjdGlvbi5qcyJdLCJuYW1lcyI6WyJBV1NYUmF5IiwicmVxdWlyZSIsIm1vbmdvZGIiLCJDb2xsZWN0aW9uIiwiTW9uZ29Db2xsZWN0aW9uIiwiY29uc3RydWN0b3IiLCJtb25nb0NvbGxlY3Rpb24iLCJfbW9uZ29Db2xsZWN0aW9uIiwiZmluZCIsInF1ZXJ5Iiwic2tpcCIsImxpbWl0Iiwic29ydCIsImtleXMiLCJtYXhUaW1lTVMiLCJyZWFkUHJlZmVyZW5jZSIsImhpbnQiLCJjYXNlSW5zZW5zaXRpdmUiLCJleHBsYWluIiwiJHNjb3JlIiwic2NvcmUiLCIkbWV0YSIsIl9leGVjdXRlV2l0aFRyYWNlIiwiX3Jhd0ZpbmQiLCJjYXRjaCIsImVycm9yIiwiY29kZSIsIm1lc3NhZ2UiLCJtYXRjaCIsImtleSIsImluZGV4IiwiY3JlYXRlSW5kZXgiLCJ0aGVuIiwiY2FzZUluc2Vuc2l0aXZlQ29sbGF0aW9uIiwibG9jYWxlIiwic3RyZW5ndGgiLCJmaW5kT3BlcmF0aW9uIiwicHJvamVjdCIsImNvbGxhdGlvbiIsInRvQXJyYXkiLCJjb3VudCIsIk9iamVjdCIsImxlbmd0aCIsImVzdGltYXRlZERvY3VtZW50Q291bnQiLCJjb3VudE9wZXJhdGlvbiIsImNvdW50RG9jdW1lbnRzIiwiZGlzdGluY3QiLCJmaWVsZCIsImFnZ3JlZ2F0ZSIsInBpcGVsaW5lIiwiaW5zZXJ0T25lIiwib2JqZWN0Iiwic2Vzc2lvbiIsImluc2VydE1hbnkiLCJ1cHNlcnRPbmUiLCJ1cGRhdGUiLCJ1cGRhdGVPbmUiLCJ1cHNlcnQiLCJ1cGRhdGVNYW55IiwiZGVsZXRlTWFueSIsImJ1bGtXcml0ZSIsIm9wZXJhdGlvbnMiLCJvcmRlcmVkIiwiX2Vuc3VyZVNwYXJzZVVuaXF1ZUluZGV4SW5CYWNrZ3JvdW5kIiwiaW5kZXhSZXF1ZXN0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJ1bmlxdWUiLCJiYWNrZ3JvdW5kIiwic3BhcnNlIiwiZHJvcCIsInR5cGUiLCJmbiIsInBhcmVudCIsImdldFNlZ21lbnQiLCJjYXB0dXJlQXN5bmNGdW5jIiwic3Vic2VnbWVudCIsImFkZEF0dHJpYnV0ZSIsInJlZ2lvbiIsInByb2Nlc3MiLCJlbnYiLCJBV1NfUkVHSU9OIiwiZGF0YWJhc2UiLCJvcGVyYXRpb24iLCJ0b1VwcGVyQ2FzZSIsImNvbGxlY3Rpb25OYW1lIiwiY29sbGVjdGlvbiIsInJldHJpZXMiLCJhZGRBbm5vdGF0aW9uIiwiYWRkTWV0YWRhdGEiLCJKU09OIiwic3RyaW5naWZ5IiwicmVzdWx0IiwicmVzcG9uc2UiLCJzdGF0dXMiLCJjbG9zZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBLE1BQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLGdCQUFELENBQXZCOztBQUNBLE1BQU1DLE9BQU8sR0FBR0QsT0FBTyxDQUFDLFNBQUQsQ0FBdkI7O0FBQ0EsTUFBTUUsVUFBVSxHQUFHRCxPQUFPLENBQUNDLFVBQTNCOztBQUVlLE1BQU1DLGVBQU4sQ0FBc0I7QUFHbkNDLEVBQUFBLFdBQVcsQ0FBQ0MsZUFBRCxFQUE4QjtBQUN2QyxTQUFLQyxnQkFBTCxHQUF3QkQsZUFBeEI7QUFDRCxHQUxrQyxDQU9uQztBQUNBO0FBQ0E7QUFDQTtBQUNBOzs7QUFDQUUsRUFBQUEsSUFBSSxDQUNGQyxLQURFLEVBRUY7QUFDRUMsSUFBQUEsSUFERjtBQUVFQyxJQUFBQSxLQUZGO0FBR0VDLElBQUFBLElBSEY7QUFJRUMsSUFBQUEsSUFKRjtBQUtFQyxJQUFBQSxTQUxGO0FBTUVDLElBQUFBLGNBTkY7QUFPRUMsSUFBQUEsSUFQRjtBQVFFQyxJQUFBQSxlQVJGO0FBU0VDLElBQUFBO0FBVEYsTUFVSSxFQVpGLEVBYUY7QUFDQTtBQUNBLFFBQUlMLElBQUksSUFBSUEsSUFBSSxDQUFDTSxNQUFqQixFQUF5QjtBQUN2QixhQUFPTixJQUFJLENBQUNNLE1BQVo7QUFDQU4sTUFBQUEsSUFBSSxDQUFDTyxLQUFMLEdBQWE7QUFBRUMsUUFBQUEsS0FBSyxFQUFFO0FBQVQsT0FBYjtBQUNEOztBQUVELFdBQU8sS0FBS0MsaUJBQUwsQ0FDTCxNQURLLEVBRUwsS0FBS0MsUUFBTCxDQUFjZCxLQUFkLEVBQXFCO0FBQ25CQyxNQUFBQSxJQURtQjtBQUVuQkMsTUFBQUEsS0FGbUI7QUFHbkJDLE1BQUFBLElBSG1CO0FBSW5CQyxNQUFBQSxJQUptQjtBQUtuQkMsTUFBQUEsU0FMbUI7QUFNbkJDLE1BQUFBLGNBTm1CO0FBT25CQyxNQUFBQSxJQVBtQjtBQVFuQkMsTUFBQUEsZUFSbUI7QUFTbkJDLE1BQUFBO0FBVG1CLEtBQXJCLENBRkssRUFZRFQsS0FaQyxFQWFMZSxLQWJLLENBYUNDLEtBQUssSUFBSTtBQUNmO0FBQ0EsVUFDRUEsS0FBSyxDQUFDQyxJQUFOLElBQWMsS0FBZCxJQUNBLENBQUNELEtBQUssQ0FBQ0UsT0FBTixDQUFjQyxLQUFkLENBQW9CLG1DQUFwQixDQUZILEVBR0U7QUFDQSxjQUFNSCxLQUFOO0FBQ0QsT0FQYyxDQVFmOzs7QUFDQSxZQUFNSSxHQUFHLEdBQUdKLEtBQUssQ0FBQ0UsT0FBTixDQUFjQyxLQUFkLENBQW9CLHdCQUFwQixFQUE4QyxDQUE5QyxDQUFaOztBQUNBLFVBQUksQ0FBQ0MsR0FBTCxFQUFVO0FBQ1IsY0FBTUosS0FBTjtBQUNEOztBQUVELFVBQUlLLEtBQUssR0FBRyxFQUFaO0FBQ0FBLE1BQUFBLEtBQUssQ0FBQ0QsR0FBRCxDQUFMLEdBQWEsSUFBYjtBQUNBLGFBQ0UsS0FBS3RCLGdCQUFMLENBQ0d3QixXQURILENBQ2VELEtBRGYsRUFFRTtBQUZGLE9BR0dFLElBSEgsQ0FHUSxNQUNKLEtBQUtWLGlCQUFMLENBQ0UsTUFERixFQUVFLEtBQUtDLFFBQUwsQ0FBY2QsS0FBZCxFQUFxQjtBQUNuQkMsUUFBQUEsSUFEbUI7QUFFbkJDLFFBQUFBLEtBRm1CO0FBR25CQyxRQUFBQSxJQUhtQjtBQUluQkMsUUFBQUEsSUFKbUI7QUFLbkJDLFFBQUFBLFNBTG1CO0FBTW5CQyxRQUFBQSxjQU5tQjtBQU9uQkMsUUFBQUEsSUFQbUI7QUFRbkJDLFFBQUFBLGVBUm1CO0FBU25CQyxRQUFBQTtBQVRtQixPQUFyQixDQUZGLENBSkosQ0FERjtBQXFCRCxLQWxETSxDQUFQO0FBbUREO0FBRUQ7Ozs7O0FBR0EsU0FBT2Usd0JBQVAsR0FBa0M7QUFDaEMsV0FBTztBQUFFQyxNQUFBQSxNQUFNLEVBQUUsT0FBVjtBQUFtQkMsTUFBQUEsUUFBUSxFQUFFO0FBQTdCLEtBQVA7QUFDRDs7QUFFRFosRUFBQUEsUUFBUSxDQUNOZCxLQURNLEVBRU47QUFDRUMsSUFBQUEsSUFERjtBQUVFQyxJQUFBQSxLQUZGO0FBR0VDLElBQUFBLElBSEY7QUFJRUMsSUFBQUEsSUFKRjtBQUtFQyxJQUFBQSxTQUxGO0FBTUVDLElBQUFBLGNBTkY7QUFPRUMsSUFBQUEsSUFQRjtBQVFFQyxJQUFBQSxlQVJGO0FBU0VDLElBQUFBO0FBVEYsTUFVSSxFQVpFLEVBYU47QUFDQSxRQUFJa0IsYUFBYSxHQUFHLEtBQUs3QixnQkFBTCxDQUFzQkMsSUFBdEIsQ0FBMkJDLEtBQTNCLEVBQWtDO0FBQ3BEQyxNQUFBQSxJQURvRDtBQUVwREMsTUFBQUEsS0FGb0Q7QUFHcERDLE1BQUFBLElBSG9EO0FBSXBERyxNQUFBQSxjQUpvRDtBQUtwREMsTUFBQUE7QUFMb0QsS0FBbEMsQ0FBcEI7O0FBUUEsUUFBSUgsSUFBSixFQUFVO0FBQ1J1QixNQUFBQSxhQUFhLEdBQUdBLGFBQWEsQ0FBQ0MsT0FBZCxDQUFzQnhCLElBQXRCLENBQWhCO0FBQ0Q7O0FBRUQsUUFBSUksZUFBSixFQUFxQjtBQUNuQm1CLE1BQUFBLGFBQWEsR0FBR0EsYUFBYSxDQUFDRSxTQUFkLENBQ2RsQyxlQUFlLENBQUM2Qix3QkFBaEIsRUFEYyxDQUFoQjtBQUdEOztBQUVELFFBQUluQixTQUFKLEVBQWU7QUFDYnNCLE1BQUFBLGFBQWEsR0FBR0EsYUFBYSxDQUFDdEIsU0FBZCxDQUF3QkEsU0FBeEIsQ0FBaEI7QUFDRDs7QUFFRCxXQUFPSSxPQUFPLEdBQUdrQixhQUFhLENBQUNsQixPQUFkLENBQXNCQSxPQUF0QixDQUFILEdBQW9Da0IsYUFBYSxDQUFDRyxPQUFkLEVBQWxEO0FBQ0Q7O0FBRURDLEVBQUFBLEtBQUssQ0FBQy9CLEtBQUQsRUFBUTtBQUFFQyxJQUFBQSxJQUFGO0FBQVFDLElBQUFBLEtBQVI7QUFBZUMsSUFBQUEsSUFBZjtBQUFxQkUsSUFBQUEsU0FBckI7QUFBZ0NDLElBQUFBLGNBQWhDO0FBQWdEQyxJQUFBQTtBQUFoRCxNQUF5RCxFQUFqRSxFQUFxRTtBQUN4RTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFFBQUksT0FBT1AsS0FBUCxLQUFpQixRQUFqQixJQUE2QixDQUFDZ0MsTUFBTSxDQUFDNUIsSUFBUCxDQUFZSixLQUFaLEVBQW1CaUMsTUFBckQsRUFBNkQ7QUFDM0QsYUFBTyxLQUFLcEIsaUJBQUwsQ0FDTCx3QkFESyxFQUVMLEtBQUtmLGdCQUFMLENBQXNCb0Msc0JBQXRCLENBQTZDO0FBQzNDN0IsUUFBQUE7QUFEMkMsT0FBN0MsQ0FGSyxDQUFQO0FBTUQ7O0FBRUQsVUFBTThCLGNBQWMsR0FBRyxLQUFLdEIsaUJBQUwsQ0FDckIsZ0JBRHFCLEVBRXJCLEtBQUtmLGdCQUFMLENBQXNCc0MsY0FBdEIsQ0FBcUNwQyxLQUFyQyxFQUE0QztBQUMxQ0MsTUFBQUEsSUFEMEM7QUFFMUNDLE1BQUFBLEtBRjBDO0FBRzFDQyxNQUFBQSxJQUgwQztBQUkxQ0UsTUFBQUEsU0FKMEM7QUFLMUNDLE1BQUFBLGNBTDBDO0FBTTFDQyxNQUFBQTtBQU4wQyxLQUE1QyxDQUZxQixDQUF2Qjs7QUFZQSxXQUFPNEIsY0FBUDtBQUNEOztBQUVERSxFQUFBQSxRQUFRLENBQUNDLEtBQUQsRUFBUXRDLEtBQVIsRUFBZTtBQUNyQixXQUFPLEtBQUthLGlCQUFMLENBQ0wsVUFESyxFQUVMLEtBQUtmLGdCQUFMLENBQXNCdUMsUUFBdEIsQ0FBK0JDLEtBQS9CLEVBQXNDdEMsS0FBdEMsQ0FGSyxDQUFQO0FBSUQ7O0FBRUR1QyxFQUFBQSxTQUFTLENBQUNDLFFBQUQsRUFBVztBQUFFbkMsSUFBQUEsU0FBRjtBQUFhQyxJQUFBQSxjQUFiO0FBQTZCQyxJQUFBQSxJQUE3QjtBQUFtQ0UsSUFBQUE7QUFBbkMsTUFBK0MsRUFBMUQsRUFBOEQ7QUFDckUsV0FBTyxLQUFLSSxpQkFBTCxDQUNMLFdBREssRUFFTCxLQUFLZixnQkFBTCxDQUNHeUMsU0FESCxDQUNhQyxRQURiLEVBQ3VCO0FBQUVuQyxNQUFBQSxTQUFGO0FBQWFDLE1BQUFBLGNBQWI7QUFBNkJDLE1BQUFBLElBQTdCO0FBQW1DRSxNQUFBQTtBQUFuQyxLQUR2QixFQUVHcUIsT0FGSCxFQUZLLENBQVA7QUFNRDs7QUFFRFcsRUFBQUEsU0FBUyxDQUFDQyxNQUFELEVBQVNDLE9BQVQsRUFBa0I7QUFDekIsV0FBTyxLQUFLOUIsaUJBQUwsQ0FDTCxXQURLLEVBRUwsS0FBS2YsZ0JBQUwsQ0FBc0IyQyxTQUF0QixDQUFnQ0MsTUFBaEMsRUFBd0M7QUFBRUMsTUFBQUE7QUFBRixLQUF4QyxDQUZLLENBQVA7QUFJRDs7QUFFREMsRUFBQUEsVUFBVSxDQUFDRixNQUFELEVBQVNDLE9BQVQsRUFBa0I7QUFDMUIsV0FBTyxLQUFLOUIsaUJBQUwsQ0FDTCxZQURLLEVBRUwsS0FBS2YsZ0JBQUwsQ0FBc0I4QyxVQUF0QixDQUFpQ0YsTUFBakMsRUFBeUM7QUFBRUMsTUFBQUE7QUFBRixLQUF6QyxDQUZLLENBQVA7QUFJRCxHQTVMa0MsQ0E4TG5DO0FBQ0E7QUFDQTs7O0FBQ0FFLEVBQUFBLFNBQVMsQ0FBQzdDLEtBQUQsRUFBUThDLE1BQVIsRUFBZ0JILE9BQWhCLEVBQXlCO0FBQ2hDLFdBQU8sS0FBSzlCLGlCQUFMLENBQ0wsV0FESyxFQUVMLEtBQUtmLGdCQUFMLENBQXNCaUQsU0FBdEIsQ0FBZ0MvQyxLQUFoQyxFQUF1QzhDLE1BQXZDLEVBQStDO0FBQzdDRSxNQUFBQSxNQUFNLEVBQUUsSUFEcUM7QUFFN0NMLE1BQUFBO0FBRjZDLEtBQS9DLENBRkssQ0FBUDtBQU9EOztBQUVESSxFQUFBQSxTQUFTLENBQUMvQyxLQUFELEVBQVE4QyxNQUFSLEVBQWdCO0FBQ3ZCLFdBQU8sS0FBS2pDLGlCQUFMLENBQ0wsV0FESyxFQUVMLEtBQUtmLGdCQUFMLENBQXNCaUQsU0FBdEIsQ0FBZ0MvQyxLQUFoQyxFQUF1QzhDLE1BQXZDLENBRkssQ0FBUDtBQUlEOztBQUVERyxFQUFBQSxVQUFVLENBQUNqRCxLQUFELEVBQVE4QyxNQUFSLEVBQWdCSCxPQUFoQixFQUF5QjtBQUNqQyxXQUFPLEtBQUs5QixpQkFBTCxDQUNMLFlBREssRUFFTCxLQUFLZixnQkFBTCxDQUFzQm1ELFVBQXRCLENBQWlDakQsS0FBakMsRUFBd0M4QyxNQUF4QyxFQUFnRDtBQUFFSCxNQUFBQTtBQUFGLEtBQWhELENBRkssQ0FBUDtBQUlEOztBQUVETyxFQUFBQSxVQUFVLENBQUNsRCxLQUFELEVBQVEyQyxPQUFSLEVBQWlCO0FBQ3pCLFdBQU8sS0FBSzlCLGlCQUFMLENBQ0wsWUFESyxFQUVMLEtBQUtmLGdCQUFMLENBQXNCb0QsVUFBdEIsQ0FBaUNsRCxLQUFqQyxFQUF3QztBQUFFMkMsTUFBQUE7QUFBRixLQUF4QyxDQUZLLENBQVA7QUFJRDs7QUFFRFEsRUFBQUEsU0FBUyxDQUFDQyxVQUFELEVBQWFULE9BQWIsRUFBc0I7QUFDN0IsV0FBTyxLQUFLOUIsaUJBQUwsQ0FDTCxXQURLLEVBRUwsS0FBS2YsZ0JBQUwsQ0FBc0JxRCxTQUF0QixDQUFnQ0MsVUFBaEMsRUFBNEM7QUFBRUMsTUFBQUEsT0FBTyxFQUFFLEtBQVg7QUFBa0JWLE1BQUFBO0FBQWxCLEtBQTVDLENBRkssQ0FBUDtBQUlEOztBQUVEVyxFQUFBQSxvQ0FBb0MsQ0FBQ0MsWUFBRCxFQUFlO0FBQ2pELFdBQU8sSUFBSUMsT0FBSixDQUFZLENBQUNDLE9BQUQsRUFBVUMsTUFBVixLQUFxQjtBQUN0QyxXQUFLNUQsZ0JBQUwsQ0FBc0J3QixXQUF0QixDQUNFaUMsWUFERixFQUVFO0FBQUVJLFFBQUFBLE1BQU0sRUFBRSxJQUFWO0FBQWdCQyxRQUFBQSxVQUFVLEVBQUUsSUFBNUI7QUFBa0NDLFFBQUFBLE1BQU0sRUFBRTtBQUExQyxPQUZGLEVBR0U3QyxLQUFLLElBQUk7QUFDUCxZQUFJQSxLQUFKLEVBQVc7QUFDVDBDLFVBQUFBLE1BQU0sQ0FBQzFDLEtBQUQsQ0FBTjtBQUNELFNBRkQsTUFFTztBQUNMeUMsVUFBQUEsT0FBTztBQUNSO0FBQ0YsT0FUSDtBQVdELEtBWk0sQ0FBUDtBQWFEOztBQUVESyxFQUFBQSxJQUFJLEdBQUc7QUFDTCxXQUFPLEtBQUtoRSxnQkFBTCxDQUFzQmdFLElBQXRCLEVBQVA7QUFDRDs7QUFFRGpELEVBQUFBLGlCQUFpQixDQUFDa0QsSUFBRCxFQUFPQyxFQUFQLEVBQVdoRSxLQUFYLEVBQWtCO0FBQ2pDLFVBQU1pRSxNQUFNLEdBQUcxRSxPQUFPLENBQUMyRSxVQUFSLEVBQWY7O0FBQ0EsUUFBSSxDQUFDRCxNQUFMLEVBQWE7QUFDWCxhQUFPRCxFQUFQO0FBQ0Q7O0FBQ0QsV0FBTyxJQUFJUixPQUFKLENBQVksQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQ3RDbkUsTUFBQUEsT0FBTyxDQUFDNEUsZ0JBQVIsQ0FBMEIsZUFBMUIsRUFBMENDLFVBQVUsSUFBSTtBQUN0RCxZQUFJO0FBQ0ZBLFVBQUFBLFVBQVUsSUFBSUEsVUFBVSxDQUFDQyxZQUFYLENBQXdCLFdBQXhCLEVBQXFDLEtBQXJDLENBQWQ7QUFDQUQsVUFBQUEsVUFBVSxDQUFDQyxZQUFYLENBQXdCLEtBQXhCLEVBQStCO0FBQUNDLFlBQUFBLE1BQU0sRUFBRUMsT0FBTyxDQUFDQyxHQUFSLENBQVlDLFVBQXJCO0FBQWlDQyxZQUFBQSxRQUFRLEVBQUUsUUFBM0M7QUFBcURDLFlBQUFBLFNBQVMsRUFBRyxHQUFFWixJQUFJLENBQUNhLFdBQUwsRUFBbUIsSUFBRyxLQUFLOUUsZ0JBQUwsQ0FBc0IrRSxjQUFlLEVBQTlIO0FBQWlJZCxZQUFBQSxJQUFqSTtBQUF1SWUsWUFBQUEsVUFBVSxFQUFFLEtBQUtoRixnQkFBTCxDQUFzQitFLGNBQXpLO0FBQXlMRSxZQUFBQSxPQUFPLEVBQUU7QUFBbE0sV0FBL0I7QUFDQVgsVUFBQUEsVUFBVSxJQUFJQSxVQUFVLENBQUNZLGFBQVgsQ0FBeUIsWUFBekIsRUFBdUMsS0FBS2xGLGdCQUFMLENBQXNCK0UsY0FBN0QsQ0FBZDtBQUNBVCxVQUFBQSxVQUFVLElBQUlBLFVBQVUsQ0FBQ1ksYUFBWCxDQUF5QixXQUF6QixFQUFzQ2pCLElBQXRDLENBQWQ7O0FBQ0EsY0FBSS9ELEtBQUssSUFBSSxPQUFPQSxLQUFQLEtBQWlCLFFBQTlCLEVBQXdDO0FBQ3RDb0UsWUFBQUEsVUFBVSxJQUFJQSxVQUFVLENBQUNhLFdBQVgsQ0FBdUIsT0FBdkIsRUFBZ0NDLElBQUksQ0FBQ0MsU0FBTCxDQUFlbkYsS0FBZixDQUFoQyxDQUFkO0FBQ0Q7QUFDRixTQVJELENBUUUsT0FBT2dCLEtBQVAsRUFBYyxDQUNkO0FBQ0Q7O0FBQ0RnRCxRQUFBQSxFQUFFLENBQUN6QyxJQUFILENBQ0UsVUFBUzZELE1BQVQsRUFBaUI7QUFDZjNCLFVBQUFBLE9BQU8sQ0FBQzJCLE1BQUQsQ0FBUDtBQUNBaEIsVUFBQUEsVUFBVSxJQUFJQSxVQUFVLENBQUNDLFlBQVgsQ0FBd0IsTUFBeEIsRUFBZ0M7QUFBQ2dCLFlBQUFBLFFBQVEsRUFBRTtBQUFDQyxjQUFBQSxNQUFNLEVBQUU7QUFBVDtBQUFYLFdBQWhDLENBQWQ7QUFDQWxCLFVBQUFBLFVBQVUsSUFBSUEsVUFBVSxDQUFDbUIsS0FBWCxFQUFkO0FBQ0QsU0FMSCxFQU1FLFVBQVN2RSxLQUFULEVBQWdCO0FBQ2QwQyxVQUFBQSxNQUFNLENBQUMxQyxLQUFELENBQU47QUFDQW9ELFVBQUFBLFVBQVUsSUFBSUEsVUFBVSxDQUFDbUIsS0FBWCxDQUFpQnZFLEtBQWpCLENBQWQ7QUFDRCxTQVRIO0FBV0QsT0F2QkQ7QUF3QkQsS0F6Qk0sQ0FBUDtBQTBCRDs7QUExUmtDIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgQVdTWFJheSA9IHJlcXVpcmUoJ2h1bGFiLXhyYXktc2RrJyk7XG5jb25zdCBtb25nb2RiID0gcmVxdWlyZSgnbW9uZ29kYicpO1xuY29uc3QgQ29sbGVjdGlvbiA9IG1vbmdvZGIuQ29sbGVjdGlvbjtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgTW9uZ29Db2xsZWN0aW9uIHtcbiAgX21vbmdvQ29sbGVjdGlvbjogQ29sbGVjdGlvbjtcblxuICBjb25zdHJ1Y3Rvcihtb25nb0NvbGxlY3Rpb246IENvbGxlY3Rpb24pIHtcbiAgICB0aGlzLl9tb25nb0NvbGxlY3Rpb24gPSBtb25nb0NvbGxlY3Rpb247XG4gIH1cblxuICAvLyBEb2VzIGEgZmluZCB3aXRoIFwic21hcnQgaW5kZXhpbmdcIi5cbiAgLy8gQ3VycmVudGx5IHRoaXMganVzdCBtZWFucywgaWYgaXQgbmVlZHMgYSBnZW9pbmRleCBhbmQgdGhlcmUgaXNcbiAgLy8gbm9uZSwgdGhlbiBidWlsZCB0aGUgZ2VvaW5kZXguXG4gIC8vIFRoaXMgY291bGQgYmUgaW1wcm92ZWQgYSBsb3QgYnV0IGl0J3Mgbm90IGNsZWFyIGlmIHRoYXQncyBhIGdvb2RcbiAgLy8gaWRlYS4gT3IgZXZlbiBpZiB0aGlzIGJlaGF2aW9yIGlzIGEgZ29vZCBpZGVhLlxuICBmaW5kKFxuICAgIHF1ZXJ5LFxuICAgIHtcbiAgICAgIHNraXAsXG4gICAgICBsaW1pdCxcbiAgICAgIHNvcnQsXG4gICAgICBrZXlzLFxuICAgICAgbWF4VGltZU1TLFxuICAgICAgcmVhZFByZWZlcmVuY2UsXG4gICAgICBoaW50LFxuICAgICAgY2FzZUluc2Vuc2l0aXZlLFxuICAgICAgZXhwbGFpbixcbiAgICB9ID0ge31cbiAgKSB7XG4gICAgLy8gU3VwcG9ydCBmb3IgRnVsbCBUZXh0IFNlYXJjaCAtICR0ZXh0XG4gICAgaWYgKGtleXMgJiYga2V5cy4kc2NvcmUpIHtcbiAgICAgIGRlbGV0ZSBrZXlzLiRzY29yZTtcbiAgICAgIGtleXMuc2NvcmUgPSB7ICRtZXRhOiAndGV4dFNjb3JlJyB9O1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgJ2ZpbmQnLFxuICAgICAgdGhpcy5fcmF3RmluZChxdWVyeSwge1xuICAgICAgICBza2lwLFxuICAgICAgICBsaW1pdCxcbiAgICAgICAgc29ydCxcbiAgICAgICAga2V5cyxcbiAgICAgICAgbWF4VGltZU1TLFxuICAgICAgICByZWFkUHJlZmVyZW5jZSxcbiAgICAgICAgaGludCxcbiAgICAgICAgY2FzZUluc2Vuc2l0aXZlLFxuICAgICAgICBleHBsYWluLFxuICAgICAgfSksIHF1ZXJ5XG4gICAgKS5jYXRjaChlcnJvciA9PiB7XG4gICAgICAvLyBDaGVjayBmb3IgXCJubyBnZW9pbmRleFwiIGVycm9yXG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yLmNvZGUgIT0gMTcwMDcgJiZcbiAgICAgICAgIWVycm9yLm1lc3NhZ2UubWF0Y2goL3VuYWJsZSB0byBmaW5kIGluZGV4IGZvciAuZ2VvTmVhci8pXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgICAvLyBGaWd1cmUgb3V0IHdoYXQga2V5IG5lZWRzIGFuIGluZGV4XG4gICAgICBjb25zdCBrZXkgPSBlcnJvci5tZXNzYWdlLm1hdGNoKC9maWVsZD0oW0EtWmEtel8wLTldKykgLylbMV07XG4gICAgICBpZiAoIWtleSkge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cblxuICAgICAgdmFyIGluZGV4ID0ge307XG4gICAgICBpbmRleFtrZXldID0gJzJkJztcbiAgICAgIHJldHVybiAoXG4gICAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvblxuICAgICAgICAgIC5jcmVhdGVJbmRleChpbmRleClcbiAgICAgICAgICAvLyBSZXRyeSwgYnV0IGp1c3Qgb25jZS5cbiAgICAgICAgICAudGhlbigoKSA9PlxuICAgICAgICAgICAgdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcbiAgICAgICAgICAgICAgJ2ZpbmQnLFxuICAgICAgICAgICAgICB0aGlzLl9yYXdGaW5kKHF1ZXJ5LCB7XG4gICAgICAgICAgICAgICAgc2tpcCxcbiAgICAgICAgICAgICAgICBsaW1pdCxcbiAgICAgICAgICAgICAgICBzb3J0LFxuICAgICAgICAgICAgICAgIGtleXMsXG4gICAgICAgICAgICAgICAgbWF4VGltZU1TLFxuICAgICAgICAgICAgICAgIHJlYWRQcmVmZXJlbmNlLFxuICAgICAgICAgICAgICAgIGhpbnQsXG4gICAgICAgICAgICAgICAgY2FzZUluc2Vuc2l0aXZlLFxuICAgICAgICAgICAgICAgIGV4cGxhaW4sXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApXG4gICAgICAgICAgKVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb2xsYXRpb24gdG8gc3VwcG9ydCBjYXNlIGluc2Vuc2l0aXZlIHF1ZXJpZXNcbiAgICovXG4gIHN0YXRpYyBjYXNlSW5zZW5zaXRpdmVDb2xsYXRpb24oKSB7XG4gICAgcmV0dXJuIHsgbG9jYWxlOiAnZW5fVVMnLCBzdHJlbmd0aDogMiB9O1xuICB9XG5cbiAgX3Jhd0ZpbmQoXG4gICAgcXVlcnksXG4gICAge1xuICAgICAgc2tpcCxcbiAgICAgIGxpbWl0LFxuICAgICAgc29ydCxcbiAgICAgIGtleXMsXG4gICAgICBtYXhUaW1lTVMsXG4gICAgICByZWFkUHJlZmVyZW5jZSxcbiAgICAgIGhpbnQsXG4gICAgICBjYXNlSW5zZW5zaXRpdmUsXG4gICAgICBleHBsYWluLFxuICAgIH0gPSB7fVxuICApIHtcbiAgICBsZXQgZmluZE9wZXJhdGlvbiA9IHRoaXMuX21vbmdvQ29sbGVjdGlvbi5maW5kKHF1ZXJ5LCB7XG4gICAgICBza2lwLFxuICAgICAgbGltaXQsXG4gICAgICBzb3J0LFxuICAgICAgcmVhZFByZWZlcmVuY2UsXG4gICAgICBoaW50LFxuICAgIH0pO1xuXG4gICAgaWYgKGtleXMpIHtcbiAgICAgIGZpbmRPcGVyYXRpb24gPSBmaW5kT3BlcmF0aW9uLnByb2plY3Qoa2V5cyk7XG4gICAgfVxuXG4gICAgaWYgKGNhc2VJbnNlbnNpdGl2ZSkge1xuICAgICAgZmluZE9wZXJhdGlvbiA9IGZpbmRPcGVyYXRpb24uY29sbGF0aW9uKFxuICAgICAgICBNb25nb0NvbGxlY3Rpb24uY2FzZUluc2Vuc2l0aXZlQ29sbGF0aW9uKClcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKG1heFRpbWVNUykge1xuICAgICAgZmluZE9wZXJhdGlvbiA9IGZpbmRPcGVyYXRpb24ubWF4VGltZU1TKG1heFRpbWVNUyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGV4cGxhaW4gPyBmaW5kT3BlcmF0aW9uLmV4cGxhaW4oZXhwbGFpbikgOiBmaW5kT3BlcmF0aW9uLnRvQXJyYXkoKTtcbiAgfVxuXG4gIGNvdW50KHF1ZXJ5LCB7IHNraXAsIGxpbWl0LCBzb3J0LCBtYXhUaW1lTVMsIHJlYWRQcmVmZXJlbmNlLCBoaW50IH0gPSB7fSkge1xuICAgIC8vIElmIHF1ZXJ5IGlzIGVtcHR5LCB0aGVuIHVzZSBlc3RpbWF0ZWREb2N1bWVudENvdW50IGluc3RlYWQuXG4gICAgLy8gVGhpcyBpcyBkdWUgdG8gY291bnREb2N1bWVudHMgcGVyZm9ybWluZyBhIHNjYW4sXG4gICAgLy8gd2hpY2ggZ3JlYXRseSBpbmNyZWFzZXMgZXhlY3V0aW9uIHRpbWUgd2hlbiBiZWluZyBydW4gb24gbGFyZ2UgY29sbGVjdGlvbnMuXG4gICAgLy8gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9BdXRvbWF0dGljL21vbmdvb3NlL2lzc3Vlcy82NzEzIGZvciBtb3JlIGluZm8gcmVnYXJkaW5nIHRoaXMgcHJvYmxlbS5cbiAgICBpZiAodHlwZW9mIHF1ZXJ5ICE9PSAnb2JqZWN0JyB8fCAhT2JqZWN0LmtleXMocXVlcnkpLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVXaXRoVHJhY2UoXG4gICAgICAgICdlc3RpbWF0ZWREb2N1bWVudENvdW50JyxcbiAgICAgICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLmVzdGltYXRlZERvY3VtZW50Q291bnQoe1xuICAgICAgICAgIG1heFRpbWVNUyxcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgY291bnRPcGVyYXRpb24gPSB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgJ2NvdW50RG9jdW1lbnRzJyxcbiAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5jb3VudERvY3VtZW50cyhxdWVyeSwge1xuICAgICAgICBza2lwLFxuICAgICAgICBsaW1pdCxcbiAgICAgICAgc29ydCxcbiAgICAgICAgbWF4VGltZU1TLFxuICAgICAgICByZWFkUHJlZmVyZW5jZSxcbiAgICAgICAgaGludCxcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHJldHVybiBjb3VudE9wZXJhdGlvbjtcbiAgfVxuXG4gIGRpc3RpbmN0KGZpZWxkLCBxdWVyeSkge1xuICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgJ2Rpc3RpbmN0JyxcbiAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5kaXN0aW5jdChmaWVsZCwgcXVlcnkpXG4gICAgKTtcbiAgfVxuXG4gIGFnZ3JlZ2F0ZShwaXBlbGluZSwgeyBtYXhUaW1lTVMsIHJlYWRQcmVmZXJlbmNlLCBoaW50LCBleHBsYWluIH0gPSB7fSkge1xuICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgJ2FnZ3JlZ2F0ZScsXG4gICAgICB0aGlzLl9tb25nb0NvbGxlY3Rpb25cbiAgICAgICAgLmFnZ3JlZ2F0ZShwaXBlbGluZSwgeyBtYXhUaW1lTVMsIHJlYWRQcmVmZXJlbmNlLCBoaW50LCBleHBsYWluIH0pXG4gICAgICAgIC50b0FycmF5KClcbiAgICApO1xuICB9XG5cbiAgaW5zZXJ0T25lKG9iamVjdCwgc2Vzc2lvbikge1xuICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgJ2luc2VydE9uZScsXG4gICAgICB0aGlzLl9tb25nb0NvbGxlY3Rpb24uaW5zZXJ0T25lKG9iamVjdCwgeyBzZXNzaW9uIH0pXG4gICAgKTtcbiAgfVxuXG4gIGluc2VydE1hbnkob2JqZWN0LCBzZXNzaW9uKSB7XG4gICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVXaXRoVHJhY2UoXG4gICAgICAnaW5zZXJ0TWFueScsXG4gICAgICB0aGlzLl9tb25nb0NvbGxlY3Rpb24uaW5zZXJ0TWFueShvYmplY3QsIHsgc2Vzc2lvbiB9KVxuICAgICk7XG4gIH1cblxuICAvLyBBdG9taWNhbGx5IHVwZGF0ZXMgZGF0YSBpbiB0aGUgZGF0YWJhc2UgZm9yIGEgc2luZ2xlIChmaXJzdCkgb2JqZWN0IHRoYXQgbWF0Y2hlZCB0aGUgcXVlcnlcbiAgLy8gSWYgdGhlcmUgaXMgbm90aGluZyB0aGF0IG1hdGNoZXMgdGhlIHF1ZXJ5IC0gZG9lcyBpbnNlcnRcbiAgLy8gUG9zdGdyZXMgTm90ZTogYElOU0VSVCAuLi4gT04gQ09ORkxJQ1QgVVBEQVRFYCB0aGF0IGlzIGF2YWlsYWJsZSBzaW5jZSA5LjUuXG4gIHVwc2VydE9uZShxdWVyeSwgdXBkYXRlLCBzZXNzaW9uKSB7XG4gICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVXaXRoVHJhY2UoXG4gICAgICAndXBzZXJ0T25lJyxcbiAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbi51cGRhdGVPbmUocXVlcnksIHVwZGF0ZSwge1xuICAgICAgICB1cHNlcnQ6IHRydWUsXG4gICAgICAgIHNlc3Npb24sXG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICB1cGRhdGVPbmUocXVlcnksIHVwZGF0ZSkge1xuICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgJ3VwZGF0ZU9uZScsXG4gICAgICB0aGlzLl9tb25nb0NvbGxlY3Rpb24udXBkYXRlT25lKHF1ZXJ5LCB1cGRhdGUpXG4gICAgKTtcbiAgfVxuXG4gIHVwZGF0ZU1hbnkocXVlcnksIHVwZGF0ZSwgc2Vzc2lvbikge1xuICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgJ3VwZGF0ZU1hbnknLFxuICAgICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLnVwZGF0ZU1hbnkocXVlcnksIHVwZGF0ZSwgeyBzZXNzaW9uIH0pXG4gICAgKTtcbiAgfVxuXG4gIGRlbGV0ZU1hbnkocXVlcnksIHNlc3Npb24pIHtcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcbiAgICAgICdkZWxldGVNYW55JyxcbiAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5kZWxldGVNYW55KHF1ZXJ5LCB7IHNlc3Npb24gfSlcbiAgICApO1xuICB9XG5cbiAgYnVsa1dyaXRlKG9wZXJhdGlvbnMsIHNlc3Npb24pIHtcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcbiAgICAgICdidWxrd3JpdGUnLFxuICAgICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLmJ1bGtXcml0ZShvcGVyYXRpb25zLCB7IG9yZGVyZWQ6IGZhbHNlLCBzZXNzaW9uIH0pXG4gICAgKTtcbiAgfVxuXG4gIF9lbnN1cmVTcGFyc2VVbmlxdWVJbmRleEluQmFja2dyb3VuZChpbmRleFJlcXVlc3QpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLmNyZWF0ZUluZGV4KFxuICAgICAgICBpbmRleFJlcXVlc3QsXG4gICAgICAgIHsgdW5pcXVlOiB0cnVlLCBiYWNrZ3JvdW5kOiB0cnVlLCBzcGFyc2U6IHRydWUgfSxcbiAgICAgICAgZXJyb3IgPT4ge1xuICAgICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIGRyb3AoKSB7XG4gICAgcmV0dXJuIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5kcm9wKCk7XG4gIH1cblxuICBfZXhlY3V0ZVdpdGhUcmFjZSh0eXBlLCBmbiwgcXVlcnkpIHtcbiAgICBjb25zdCBwYXJlbnQgPSBBV1NYUmF5LmdldFNlZ21lbnQoKTtcbiAgICBpZiAoIXBhcmVudCkge1xuICAgICAgcmV0dXJuIGZuO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgQVdTWFJheS5jYXB0dXJlQXN5bmNGdW5jKGBNb25nb0RCIEF0bGFzYCwgc3Vic2VnbWVudCA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgc3Vic2VnbWVudCAmJiBzdWJzZWdtZW50LmFkZEF0dHJpYnV0ZSgnbmFtZXNwYWNlJywgJ2F3cycpO1xuICAgICAgICAgIHN1YnNlZ21lbnQuYWRkQXR0cmlidXRlKCdhd3MnLCB7cmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OLCBkYXRhYmFzZTogJ21hcHN0cicsIG9wZXJhdGlvbjogYCR7dHlwZS50b1VwcGVyQ2FzZSgpfSAke3RoaXMuX21vbmdvQ29sbGVjdGlvbi5jb2xsZWN0aW9uTmFtZX1gLCB0eXBlLCBjb2xsZWN0aW9uOiB0aGlzLl9tb25nb0NvbGxlY3Rpb24uY29sbGVjdGlvbk5hbWUsIHJldHJpZXM6IDB9KTtcbiAgICAgICAgICBzdWJzZWdtZW50ICYmIHN1YnNlZ21lbnQuYWRkQW5ub3RhdGlvbignQ29sbGVjdGlvbicsIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5jb2xsZWN0aW9uTmFtZSk7XG4gICAgICAgICAgc3Vic2VnbWVudCAmJiBzdWJzZWdtZW50LmFkZEFubm90YXRpb24oJ09wZXJhdGlvbicsIHR5cGUpO1xuICAgICAgICAgIGlmIChxdWVyeSAmJiB0eXBlb2YgcXVlcnkgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICAgIHN1YnNlZ21lbnQgJiYgc3Vic2VnbWVudC5hZGRNZXRhZGF0YSgnUXVlcnknLCBKU09OLnN0cmluZ2lmeShxdWVyeSkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAvL1xuICAgICAgICB9XG4gICAgICAgIGZuLnRoZW4oXG4gICAgICAgICAgZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICAgICAgICByZXNvbHZlKHJlc3VsdCk7XG4gICAgICAgICAgICBzdWJzZWdtZW50ICYmIHN1YnNlZ21lbnQuYWRkQXR0cmlidXRlKCdodHRwJywge3Jlc3BvbnNlOiB7c3RhdHVzOiAyMDB9fSk7XG4gICAgICAgICAgICBzdWJzZWdtZW50ICYmIHN1YnNlZ21lbnQuY2xvc2UoKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIGZ1bmN0aW9uKGVycm9yKSB7XG4gICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgc3Vic2VnbWVudCAmJiBzdWJzZWdtZW50LmNsb3NlKGVycm9yKTtcbiAgICAgICAgICB9XG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuIl19