"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

const AWSXRay = require('aws-xray-sdk');

const mongodb = require('mongodb');

const Collection = mongodb.Collection;

class MongoCollection {
  constructor(mongoCollection) {
    this._mongoCollection = mongoCollection;
  } // Does a find with "smart indexing".
  // Currently this just means, if it needs a geoindex and there is
  // none, then build the geoindex.
  // This could be improved a lot but it's not clear if that's a good
  // idea. Or even if this behavior is a good idea.


  find(query, {
    skip,
    limit,
    sort,
    keys,
    maxTimeMS,
    readPreference
  } = {}) {
    // Support for Full Text Search - $text
    if (keys && keys.$score) {
      delete keys.$score;
      keys.score = {
        $meta: 'textScore'
      };
    }

    return this._executeWithTrace('find', this._rawFind(query, {
      skip,
      limit,
      sort,
      keys,
      maxTimeMS,
      readPreference
    })).catch(error => {
      // Check for "no geoindex" error
      if (error.code != 17007 && !error.message.match(/unable to find index for .geoNear/)) {
        throw error;
      } // Figure out what key needs an index


      const key = error.message.match(/field=([A-Za-z_0-9]+) /)[1];

      if (!key) {
        throw error;
      }

      var index = {};
      index[key] = '2d';
      return this._mongoCollection.createIndex(index) // Retry, but just once.
      .then(() => this._executeWithTrace('find', this._rawFind(query, {
        skip,
        limit,
        sort,
        keys,
        maxTimeMS,
        readPreference
      })));
    });
  }

  _rawFind(query, {
    skip,
    limit,
    sort,
    keys,
    maxTimeMS,
    readPreference
  } = {}) {
    let findOperation = this._mongoCollection.find(query, {
      skip,
      limit,
      sort,
      readPreference
    });

    if (keys) {
      findOperation = findOperation.project(keys);
    }

    if (maxTimeMS) {
      findOperation = findOperation.maxTimeMS(maxTimeMS);
    }

    return findOperation.toArray();
  }

  count(query, {
    skip,
    limit,
    sort,
    maxTimeMS,
    readPreference
  } = {}) {
    // If query is empty, then use estimatedDocumentCount instead.
    // This is due to countDocuments performing a scan,
    // which greatly increases execution time when being run on large collections.
    // See https://github.com/Automattic/mongoose/issues/6713 for more info regarding this problem.
    if (typeof query !== 'object' || !Object.keys(query).length) {
      return this._executeWithTrace('estimatedDocumentCount', this._mongoCollection.estimatedDocumentCount({
        maxTimeMS
      }));
    }

    const countOperation = this._executeWithTrace('countDocuments', this._mongoCollection.countDocuments(query, {
      skip,
      limit,
      sort,
      maxTimeMS,
      readPreference
    }));

    return countOperation;
  }

  distinct(field, query) {
    return this._executeWithTrace('distinct', this._mongoCollection.distinct(field, query));
  }

  aggregate(pipeline, {
    maxTimeMS,
    readPreference
  } = {}) {
    return this._executeWithTrace('aggregate', this._mongoCollection.aggregate(pipeline, {
      maxTimeMS,
      readPreference
    }).toArray());
  }

  insertOne(object, session) {
    return this._executeWithTrace('insertOne', this._mongoCollection.insertOne(object, {
      session
    }));
  }

  insertMany(object, session) {
    return this._executeWithTrace('insertMany', this._mongoCollection.insertMany(object, {
      session
    }));
  } // Atomically updates data in the database for a single (first) object that matched the query
  // If there is nothing that matches the query - does insert
  // Postgres Note: `INSERT ... ON CONFLICT UPDATE` that is available since 9.5.


  upsertOne(query, update, session) {
    return this._executeWithTrace('upsertOne', this._mongoCollection.updateOne(query, update, {
      upsert: true,
      session
    }));
  }

  updateOne(query, update) {
    return this._executeWithTrace('updateOne', this._mongoCollection.updateOne(query, update));
  }

  updateMany(query, update, session) {
    return this._executeWithTrace('updateMany', this._mongoCollection.updateMany(query, update, {
      session
    }));
  }

  deleteMany(query, session) {
    return this._executeWithTrace('deleteMany', this._mongoCollection.deleteMany(query, {
      session
    }));
  }

  _ensureSparseUniqueIndexInBackground(indexRequest) {
    return new Promise((resolve, reject) => {
      this._mongoCollection.createIndex(indexRequest, {
        unique: true,
        background: true,
        sparse: true
      }, error => {
        if (error) {
          reject(error);
        } else {
          resolve();
        }
      });
    });
  }

  drop() {
    return this._mongoCollection.drop();
  }

  _executeWithTrace(type, fn) {
    const parent = AWSXRay.getSegment();

    if (!parent) {
      return fn;
    }

    return new Promise((resolve, reject) => {
      AWSXRay.captureAsyncFunc('MongoDB', subsegment => {
        subsegment && subsegment.addAnnotation('collection', this._mongoCollection.collectionName);
        subsegment && subsegment.addAnnotation('query', type);
        fn.then(function (result) {
          resolve(result);
          subsegment && subsegment.close();
        }, function (error) {
          reject(error);
          subsegment && subsegment.close(error);
        });
      });
    });
  }

}

exports.default = MongoCollection;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9BZGFwdGVycy9TdG9yYWdlL01vbmdvL01vbmdvQ29sbGVjdGlvbi5qcyJdLCJuYW1lcyI6WyJBV1NYUmF5IiwicmVxdWlyZSIsIm1vbmdvZGIiLCJDb2xsZWN0aW9uIiwiTW9uZ29Db2xsZWN0aW9uIiwiY29uc3RydWN0b3IiLCJtb25nb0NvbGxlY3Rpb24iLCJfbW9uZ29Db2xsZWN0aW9uIiwiZmluZCIsInF1ZXJ5Iiwic2tpcCIsImxpbWl0Iiwic29ydCIsImtleXMiLCJtYXhUaW1lTVMiLCJyZWFkUHJlZmVyZW5jZSIsIiRzY29yZSIsInNjb3JlIiwiJG1ldGEiLCJfZXhlY3V0ZVdpdGhUcmFjZSIsIl9yYXdGaW5kIiwiY2F0Y2giLCJlcnJvciIsImNvZGUiLCJtZXNzYWdlIiwibWF0Y2giLCJrZXkiLCJpbmRleCIsImNyZWF0ZUluZGV4IiwidGhlbiIsImZpbmRPcGVyYXRpb24iLCJwcm9qZWN0IiwidG9BcnJheSIsImNvdW50IiwiT2JqZWN0IiwibGVuZ3RoIiwiZXN0aW1hdGVkRG9jdW1lbnRDb3VudCIsImNvdW50T3BlcmF0aW9uIiwiY291bnREb2N1bWVudHMiLCJkaXN0aW5jdCIsImZpZWxkIiwiYWdncmVnYXRlIiwicGlwZWxpbmUiLCJpbnNlcnRPbmUiLCJvYmplY3QiLCJzZXNzaW9uIiwiaW5zZXJ0TWFueSIsInVwc2VydE9uZSIsInVwZGF0ZSIsInVwZGF0ZU9uZSIsInVwc2VydCIsInVwZGF0ZU1hbnkiLCJkZWxldGVNYW55IiwiX2Vuc3VyZVNwYXJzZVVuaXF1ZUluZGV4SW5CYWNrZ3JvdW5kIiwiaW5kZXhSZXF1ZXN0IiwiUHJvbWlzZSIsInJlc29sdmUiLCJyZWplY3QiLCJ1bmlxdWUiLCJiYWNrZ3JvdW5kIiwic3BhcnNlIiwiZHJvcCIsInR5cGUiLCJmbiIsInBhcmVudCIsImdldFNlZ21lbnQiLCJjYXB0dXJlQXN5bmNGdW5jIiwic3Vic2VnbWVudCIsImFkZEFubm90YXRpb24iLCJjb2xsZWN0aW9u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QUFMLENBQXNCc0QsSUFBdEIsRUFBUDtBQUNEOztBQUVEMUMsRUFBQUEsaUJBQWlCLENBQUMyQyxJQUFELEVBQU9DLEVBQVAsRUFBVztBQUMxQixVQUFNQyxNQUFNLEdBQUdoRSxPQUFPLENBQUNpRSxVQUFSLEVBQWY7O0FBQ0EsUUFBSSxDQUFDRCxNQUFMLEVBQWE7QUFDWCxhQUFPRCxFQUFQO0FBQ0Q7O0FBQ0QsV0FBTyxJQUFJUixPQUFKLENBQVksQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBQ3RDekQsTUFBQUEsT0FBTyxDQUFDa0UsZ0JBQVIsQ0FBeUIsU0FBekIsRUFBb0NDLFVBQVUsSUFBSTtBQUNoREEsUUFBQUEsVUFBVSxJQUNSQSxVQUFVLENBQUNDLGFBQVgsQ0FDRSxZQURGLEVBRUUsS0FBSzdELGdCQUFMLENBQXNCOEQsY0FGeEIsQ0FERjtBQUtBRixRQUFBQSxVQUFVLElBQUlBLFVBQVUsQ0FBQ0MsYUFBWCxDQUF5QixPQUF6QixFQUFrQ04sSUFBbEMsQ0FBZDtBQUNBQyxRQUFBQSxFQUFFLENBQUNsQyxJQUFILENBQ0UsVUFBU3lDLE1BQVQsRUFBaUI7QUFDZmQsVUFBQUEsT0FBTyxDQUFDYyxNQUFELENBQVA7QUFDQUgsVUFBQUEsVUFBVSxJQUFJQSxVQUFVLENBQUNJLEtBQVgsRUFBZDtBQUNELFNBSkgsRUFLRSxVQUFTakQsS0FBVCxFQUFnQjtBQUNkbUMsVUFBQUEsTUFBTSxDQUFDbkMsS0FBRCxDQUFOO0FBQ0E2QyxVQUFBQSxVQUFVLElBQUlBLFVBQVUsQ0FBQ0ksS0FBWCxDQUFpQmpELEtBQWpCLENBQWQ7QUFDRCxTQVJIO0FBVUQsT0FqQkQ7QUFrQkQsS0FuQk0sQ0FBUDtBQW9CRDs7QUE3TmtDIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgQVdTWFJheSA9IHJlcXVpcmUoJ2F3cy14cmF5LXNkaycpO1xuY29uc3QgbW9uZ29kYiA9IHJlcXVpcmUoJ21vbmdvZGInKTtcbmNvbnN0IENvbGxlY3Rpb24gPSBtb25nb2RiLkNvbGxlY3Rpb247XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE1vbmdvQ29sbGVjdGlvbiB7XG4gIF9tb25nb0NvbGxlY3Rpb246IENvbGxlY3Rpb247XG5cbiAgY29uc3RydWN0b3IobW9uZ29Db2xsZWN0aW9uOiBDb2xsZWN0aW9uKSB7XG4gICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uID0gbW9uZ29Db2xsZWN0aW9uO1xuICB9XG5cbiAgLy8gRG9lcyBhIGZpbmQgd2l0aCBcInNtYXJ0IGluZGV4aW5nXCIuXG4gIC8vIEN1cnJlbnRseSB0aGlzIGp1c3QgbWVhbnMsIGlmIGl0IG5lZWRzIGEgZ2VvaW5kZXggYW5kIHRoZXJlIGlzXG4gIC8vIG5vbmUsIHRoZW4gYnVpbGQgdGhlIGdlb2luZGV4LlxuICAvLyBUaGlzIGNvdWxkIGJlIGltcHJvdmVkIGEgbG90IGJ1dCBpdCdzIG5vdCBjbGVhciBpZiB0aGF0J3MgYSBnb29kXG4gIC8vIGlkZWEuIE9yIGV2ZW4gaWYgdGhpcyBiZWhhdmlvciBpcyBhIGdvb2QgaWRlYS5cbiAgZmluZChxdWVyeSwgeyBza2lwLCBsaW1pdCwgc29ydCwga2V5cywgbWF4VGltZU1TLCByZWFkUHJlZmVyZW5jZSB9ID0ge30pIHtcbiAgICAvLyBTdXBwb3J0IGZvciBGdWxsIFRleHQgU2VhcmNoIC0gJHRleHRcbiAgICBpZiAoa2V5cyAmJiBrZXlzLiRzY29yZSkge1xuICAgICAgZGVsZXRlIGtleXMuJHNjb3JlO1xuICAgICAga2V5cy5zY29yZSA9IHsgJG1ldGE6ICd0ZXh0U2NvcmUnIH07XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgJ2ZpbmQnLFxuICAgICAgdGhpcy5fcmF3RmluZChxdWVyeSwge1xuICAgICAgICBza2lwLFxuICAgICAgICBsaW1pdCxcbiAgICAgICAgc29ydCxcbiAgICAgICAga2V5cyxcbiAgICAgICAgbWF4VGltZU1TLFxuICAgICAgICByZWFkUHJlZmVyZW5jZSxcbiAgICAgIH0pXG4gICAgKS5jYXRjaChlcnJvciA9PiB7XG4gICAgICAvLyBDaGVjayBmb3IgXCJubyBnZW9pbmRleFwiIGVycm9yXG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yLmNvZGUgIT0gMTcwMDcgJiZcbiAgICAgICAgIWVycm9yLm1lc3NhZ2UubWF0Y2goL3VuYWJsZSB0byBmaW5kIGluZGV4IGZvciAuZ2VvTmVhci8pXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgICAvLyBGaWd1cmUgb3V0IHdoYXQga2V5IG5lZWRzIGFuIGluZGV4XG4gICAgICBjb25zdCBrZXkgPSBlcnJvci5tZXNzYWdlLm1hdGNoKC9maWVsZD0oW0EtWmEtel8wLTldKykgLylbMV07XG4gICAgICBpZiAoIWtleSkge1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cblxuICAgICAgdmFyIGluZGV4ID0ge307XG4gICAgICBpbmRleFtrZXldID0gJzJkJztcbiAgICAgIHJldHVybiAoXG4gICAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvblxuICAgICAgICAgIC5jcmVhdGVJbmRleChpbmRleClcbiAgICAgICAgICAvLyBSZXRyeSwgYnV0IGp1c3Qgb25jZS5cbiAgICAgICAgICAudGhlbigoKSA9PlxuICAgICAgICAgICAgdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcbiAgICAgICAgICAgICAgJ2ZpbmQnLFxuICAgICAgICAgICAgICB0aGlzLl9yYXdGaW5kKHF1ZXJ5LCB7XG4gICAgICAgICAgICAgICAgc2tpcCxcbiAgICAgICAgICAgICAgICBsaW1pdCxcbiAgICAgICAgICAgICAgICBzb3J0LFxuICAgICAgICAgICAgICAgIGtleXMsXG4gICAgICAgICAgICAgICAgbWF4VGltZU1TLFxuICAgICAgICAgICAgICAgIHJlYWRQcmVmZXJlbmNlLFxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKVxuICAgICAgICAgIClcbiAgICAgICk7XG4gICAgfSk7XG4gIH1cblxuICBfcmF3RmluZChxdWVyeSwgeyBza2lwLCBsaW1pdCwgc29ydCwga2V5cywgbWF4VGltZU1TLCByZWFkUHJlZmVyZW5jZSB9ID0ge30pIHtcbiAgICBsZXQgZmluZE9wZXJhdGlvbiA9IHRoaXMuX21vbmdvQ29sbGVjdGlvbi5maW5kKHF1ZXJ5LCB7XG4gICAgICBza2lwLFxuICAgICAgbGltaXQsXG4gICAgICBzb3J0LFxuICAgICAgcmVhZFByZWZlcmVuY2UsXG4gICAgfSk7XG5cbiAgICBpZiAoa2V5cykge1xuICAgICAgZmluZE9wZXJhdGlvbiA9IGZpbmRPcGVyYXRpb24ucHJvamVjdChrZXlzKTtcbiAgICB9XG5cbiAgICBpZiAobWF4VGltZU1TKSB7XG4gICAgICBmaW5kT3BlcmF0aW9uID0gZmluZE9wZXJhdGlvbi5tYXhUaW1lTVMobWF4VGltZU1TKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZmluZE9wZXJhdGlvbi50b0FycmF5KCk7XG4gIH1cblxuICBjb3VudChxdWVyeSwgeyBza2lwLCBsaW1pdCwgc29ydCwgbWF4VGltZU1TLCByZWFkUHJlZmVyZW5jZSB9ID0ge30pIHtcbiAgICAvLyBJZiBxdWVyeSBpcyBlbXB0eSwgdGhlbiB1c2UgZXN0aW1hdGVkRG9jdW1lbnRDb3VudCBpbnN0ZWFkLlxuICAgIC8vIFRoaXMgaXMgZHVlIHRvIGNvdW50RG9jdW1lbnRzIHBlcmZvcm1pbmcgYSBzY2FuLFxuICAgIC8vIHdoaWNoIGdyZWF0bHkgaW5jcmVhc2VzIGV4ZWN1dGlvbiB0aW1lIHdoZW4gYmVpbmcgcnVuIG9uIGxhcmdlIGNvbGxlY3Rpb25zLlxuICAgIC8vIFNlZSBodHRwczovL2dpdGh1Yi5jb20vQXV0b21hdHRpYy9tb25nb29zZS9pc3N1ZXMvNjcxMyBmb3IgbW9yZSBpbmZvIHJlZ2FyZGluZyB0aGlzIHByb2JsZW0uXG4gICAgaWYgKHR5cGVvZiBxdWVyeSAhPT0gJ29iamVjdCcgfHwgIU9iamVjdC5rZXlzKHF1ZXJ5KS5sZW5ndGgpIHtcbiAgICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgICAnZXN0aW1hdGVkRG9jdW1lbnRDb3VudCcsXG4gICAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5lc3RpbWF0ZWREb2N1bWVudENvdW50KHtcbiAgICAgICAgICBtYXhUaW1lTVMsXG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IGNvdW50T3BlcmF0aW9uID0gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcbiAgICAgICdjb3VudERvY3VtZW50cycsXG4gICAgICB0aGlzLl9tb25nb0NvbGxlY3Rpb24uY291bnREb2N1bWVudHMocXVlcnksIHtcbiAgICAgICAgc2tpcCxcbiAgICAgICAgbGltaXQsXG4gICAgICAgIHNvcnQsXG4gICAgICAgIG1heFRpbWVNUyxcbiAgICAgICAgcmVhZFByZWZlcmVuY2UsXG4gICAgICB9KVxuICAgICk7XG5cbiAgICByZXR1cm4gY291bnRPcGVyYXRpb247XG4gIH1cblxuICBkaXN0aW5jdChmaWVsZCwgcXVlcnkpIHtcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcbiAgICAgICdkaXN0aW5jdCcsXG4gICAgICB0aGlzLl9tb25nb0NvbGxlY3Rpb24uZGlzdGluY3QoZmllbGQsIHF1ZXJ5KVxuICAgICk7XG4gIH1cblxuICBhZ2dyZWdhdGUocGlwZWxpbmUsIHsgbWF4VGltZU1TLCByZWFkUHJlZmVyZW5jZSB9ID0ge30pIHtcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcbiAgICAgICdhZ2dyZWdhdGUnLFxuICAgICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uXG4gICAgICAgIC5hZ2dyZWdhdGUocGlwZWxpbmUsIHsgbWF4VGltZU1TLCByZWFkUHJlZmVyZW5jZSB9KVxuICAgICAgICAudG9BcnJheSgpXG4gICAgKTtcbiAgfVxuXG4gIGluc2VydE9uZShvYmplY3QsIHNlc3Npb24pIHtcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcbiAgICAgICdpbnNlcnRPbmUnLFxuICAgICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLmluc2VydE9uZShvYmplY3QsIHsgc2Vzc2lvbiB9KVxuICAgICk7XG4gIH1cblxuICBpbnNlcnRNYW55KG9iamVjdCwgc2Vzc2lvbikge1xuICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgJ2luc2VydE1hbnknLFxuICAgICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLmluc2VydE1hbnkob2JqZWN0LCB7IHNlc3Npb24gfSlcbiAgICApO1xuICB9XG5cbiAgLy8gQXRvbWljYWxseSB1cGRhdGVzIGRhdGEgaW4gdGhlIGRhdGFiYXNlIGZvciBhIHNpbmdsZSAoZmlyc3QpIG9iamVjdCB0aGF0IG1hdGNoZWQgdGhlIHF1ZXJ5XG4gIC8vIElmIHRoZXJlIGlzIG5vdGhpbmcgdGhhdCBtYXRjaGVzIHRoZSBxdWVyeSAtIGRvZXMgaW5zZXJ0XG4gIC8vIFBvc3RncmVzIE5vdGU6IGBJTlNFUlQgLi4uIE9OIENPTkZMSUNUIFVQREFURWAgdGhhdCBpcyBhdmFpbGFibGUgc2luY2UgOS41LlxuICB1cHNlcnRPbmUocXVlcnksIHVwZGF0ZSwgc2Vzc2lvbikge1xuICAgIHJldHVybiB0aGlzLl9leGVjdXRlV2l0aFRyYWNlKFxuICAgICAgJ3Vwc2VydE9uZScsXG4gICAgICB0aGlzLl9tb25nb0NvbGxlY3Rpb24udXBkYXRlT25lKHF1ZXJ5LCB1cGRhdGUsIHtcbiAgICAgICAgdXBzZXJ0OiB0cnVlLFxuICAgICAgICBzZXNzaW9uLFxuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgdXBkYXRlT25lKHF1ZXJ5LCB1cGRhdGUpIHtcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcbiAgICAgICd1cGRhdGVPbmUnLFxuICAgICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLnVwZGF0ZU9uZShxdWVyeSwgdXBkYXRlKVxuICAgICk7XG4gIH1cblxuICB1cGRhdGVNYW55KHF1ZXJ5LCB1cGRhdGUsIHNlc3Npb24pIHtcbiAgICByZXR1cm4gdGhpcy5fZXhlY3V0ZVdpdGhUcmFjZShcbiAgICAgICd1cGRhdGVNYW55JyxcbiAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbi51cGRhdGVNYW55KHF1ZXJ5LCB1cGRhdGUsIHsgc2Vzc2lvbiB9KVxuICAgICk7XG4gIH1cblxuICBkZWxldGVNYW55KHF1ZXJ5LCBzZXNzaW9uKSB7XG4gICAgcmV0dXJuIHRoaXMuX2V4ZWN1dGVXaXRoVHJhY2UoXG4gICAgICAnZGVsZXRlTWFueScsXG4gICAgICB0aGlzLl9tb25nb0NvbGxlY3Rpb24uZGVsZXRlTWFueShxdWVyeSwgeyBzZXNzaW9uIH0pXG4gICAgKTtcbiAgfVxuXG4gIF9lbnN1cmVTcGFyc2VVbmlxdWVJbmRleEluQmFja2dyb3VuZChpbmRleFJlcXVlc3QpIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5fbW9uZ29Db2xsZWN0aW9uLmNyZWF0ZUluZGV4KFxuICAgICAgICBpbmRleFJlcXVlc3QsXG4gICAgICAgIHsgdW5pcXVlOiB0cnVlLCBiYWNrZ3JvdW5kOiB0cnVlLCBzcGFyc2U6IHRydWUgfSxcbiAgICAgICAgZXJyb3IgPT4ge1xuICAgICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxuXG4gIGRyb3AoKSB7XG4gICAgcmV0dXJuIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5kcm9wKCk7XG4gIH1cblxuICBfZXhlY3V0ZVdpdGhUcmFjZSh0eXBlLCBmbikge1xuICAgIGNvbnN0IHBhcmVudCA9IEFXU1hSYXkuZ2V0U2VnbWVudCgpO1xuICAgIGlmICghcGFyZW50KSB7XG4gICAgICByZXR1cm4gZm47XG4gICAgfVxuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBBV1NYUmF5LmNhcHR1cmVBc3luY0Z1bmMoJ01vbmdvREInLCBzdWJzZWdtZW50ID0+IHtcbiAgICAgICAgc3Vic2VnbWVudCAmJlxuICAgICAgICAgIHN1YnNlZ21lbnQuYWRkQW5ub3RhdGlvbihcbiAgICAgICAgICAgICdjb2xsZWN0aW9uJyxcbiAgICAgICAgICAgIHRoaXMuX21vbmdvQ29sbGVjdGlvbi5jb2xsZWN0aW9uTmFtZVxuICAgICAgICAgICk7XG4gICAgICAgIHN1YnNlZ21lbnQgJiYgc3Vic2VnbWVudC5hZGRBbm5vdGF0aW9uKCdxdWVyeScsIHR5cGUpO1xuICAgICAgICBmbi50aGVuKFxuICAgICAgICAgIGZ1bmN0aW9uKHJlc3VsdCkge1xuICAgICAgICAgICAgcmVzb2x2ZShyZXN1bHQpO1xuICAgICAgICAgICAgc3Vic2VnbWVudCAmJiBzdWJzZWdtZW50LmNsb3NlKCk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBmdW5jdGlvbihlcnJvcikge1xuICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcbiAgICAgICAgICAgIHN1YnNlZ21lbnQgJiYgc3Vic2VnbWVudC5jbG9zZShlcnJvcik7XG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cbn1cbiJdfQ==