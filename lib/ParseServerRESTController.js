"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ParseServerRESTController = ParseServerRESTController;
exports.default = void 0;

const AWSXRay = require('hulab-xray-sdk');

const Config = require('./Config');

const Auth = require('./Auth');

const RESTController = require('parse/lib/node/RESTController');

const URL = require('url');

const Parse = require('parse/node');

function getSessionToken(options) {
  if (options && typeof options.sessionToken === 'string') {
    return Promise.resolve(options.sessionToken);
  }

  return Promise.resolve(null);
}

function getAuth(options = {}, config) {
  const installationId = options.installationId || 'cloud';

  if (options.useMasterKey) {
    return Promise.resolve(new Auth.Auth({
      config,
      isMaster: true,
      installationId
    }));
  }

  return getSessionToken(options).then(sessionToken => {
    if (sessionToken) {
      options.sessionToken = sessionToken;
      return Auth.getAuthForSessionToken({
        config,
        sessionToken: sessionToken,
        installationId
      });
    } else {
      return Promise.resolve(new Auth.Auth({
        config,
        installationId
      }));
    }
  });
}

function ParseServerRESTController(applicationId, router) {
  function handleRequest(method, path, data = {}, options = {}, config) {
    // Store the arguments, for later use if internal fails
    const args = arguments;

    if (!config) {
      config = Config.get(applicationId);
    }

    const serverURL = URL.parse(config.serverURL);

    if (path.indexOf(serverURL.path) === 0) {
      path = path.slice(serverURL.path.length, path.length);
    }

    if (path[0] !== '/') {
      path = '/' + path;
    }

    if (path === '/batch') {
      let initialPromise = Promise.resolve();

      if (data.transaction === true) {
        initialPromise = config.database.createTransactionalSession();
      }

      return initialPromise.then(() => {
        const promises = data.requests.map(request => {
          return handleRequest(request.method, request.path, request.body, options, config).then(response => {
            return {
              success: response
            };
          }, error => {
            return {
              error: {
                code: error.code,
                error: error.message
              }
            };
          });
        });
        return Promise.all(promises).then(result => {
          if (data.transaction === true) {
            if (result.find(resultItem => typeof resultItem.error === 'object')) {
              return config.database.abortTransactionalSession().then(() => {
                return Promise.reject(result);
              });
            } else {
              return config.database.commitTransactionalSession().then(() => {
                return result;
              });
            }
          } else {
            return result;
          }
        });
      });
    }

    let query;

    if (method === 'GET') {
      query = data;
    }

    return new Promise((resolve, reject) => {
      tracePromise('getAuth', getAuth(options, config)).then(auth => {
        const request = {
          body: data,
          config,
          auth,
          info: {
            applicationId: applicationId,
            sessionToken: options.sessionToken,
            context: options.context || {} // Add context

          },
          query
        };
        return Promise.resolve().then(() => {
          return router.tryRouteRequest(method, path, request);
        }).then(response => {
          resolve(response.response, response.status, response);
        }, err => {
          if (err instanceof Parse.Error && err.code == Parse.Error.INVALID_JSON && err.message == `cannot route ${method} ${path}`) {
            RESTController.request.apply(null, args).then(resolve, reject);
          } else {
            reject(err);
          }
        });
      }, reject);
    });
  }

  return {
    request: handleRequest,
    ajax: RESTController.ajax
  };
}

function tracePromise(operation, promise = Promise.resolve()) {
  // Temporary removing trace here
  return promise; // const parent = AWSXRay.getSegment();
  // if (!parent) {
  //   return promise;
  // }
  // return new Promise((resolve, reject) => {
  //   AWSXRay.captureAsyncFunc(
  //     `Parse-Server_RESTController_${operation}`,
  //     subsegment => {
  //       subsegment &&
  //         subsegment.addAnnotation('Controller', 'ParseServerRESTController');
  //       subsegment && subsegment.addAnnotation('Operation', operation);
  //       (promise instanceof Promise ? promise : Promise.resolve(promise)).then(
  //         function(result) {
  //           resolve(result);
  //           subsegment && subsegment.close();
  //         },
  //         function(error) {
  //           reject(error);
  //           subsegment && subsegment.close(error);
  //         }
  //       );
  //     }
  //   );
  // });
}

var _default = ParseServerRESTController;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9QYXJzZVNlcnZlclJFU1RDb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbIkFXU1hSYXkiLCJyZXF1aXJlIiwiQ29uZmlnIiwiQXV0aCIsIlJFU1RDb250cm9sbGVyIiwiVVJMIiwiUGFyc2UiLCJnZXRTZXNzaW9uVG9rZW4iLCJvcHRpb25zIiwic2Vzc2lvblRva2VuIiwiUHJvbWlzZSIsInJlc29sdmUiLCJnZXRBdXRoIiwiY29uZmlnIiwiaW5zdGFsbGF0aW9uSWQiLCJ1c2VNYXN0ZXJLZXkiLCJpc01hc3RlciIsInRoZW4iLCJnZXRBdXRoRm9yU2Vzc2lvblRva2VuIiwiUGFyc2VTZXJ2ZXJSRVNUQ29udHJvbGxlciIsImFwcGxpY2F0aW9uSWQiLCJyb3V0ZXIiLCJoYW5kbGVSZXF1ZXN0IiwibWV0aG9kIiwicGF0aCIsImRhdGEiLCJhcmdzIiwiYXJndW1lbnRzIiwiZ2V0Iiwic2VydmVyVVJMIiwicGFyc2UiLCJpbmRleE9mIiwic2xpY2UiLCJsZW5ndGgiLCJpbml0aWFsUHJvbWlzZSIsInRyYW5zYWN0aW9uIiwiZGF0YWJhc2UiLCJjcmVhdGVUcmFuc2FjdGlvbmFsU2Vzc2lvbiIsInByb21pc2VzIiwicmVxdWVzdHMiLCJtYXAiLCJyZXF1ZXN0IiwiYm9keSIsInJlc3BvbnNlIiwic3VjY2VzcyIsImVycm9yIiwiY29kZSIsIm1lc3NhZ2UiLCJhbGwiLCJyZXN1bHQiLCJmaW5kIiwicmVzdWx0SXRlbSIsImFib3J0VHJhbnNhY3Rpb25hbFNlc3Npb24iLCJyZWplY3QiLCJjb21taXRUcmFuc2FjdGlvbmFsU2Vzc2lvbiIsInF1ZXJ5IiwidHJhY2VQcm9taXNlIiwiYXV0aCIsImluZm8iLCJjb250ZXh0IiwidHJ5Um91dGVSZXF1ZXN0Iiwic3RhdHVzIiwiZXJyIiwiRXJyb3IiLCJJTlZBTElEX0pTT04iLCJhcHBseSIsImFqYXgiLCJvcGVyYXRpb24iLCJwcm9taXNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLE1BQU1BLE9BQU8s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InNvdXJjZXNDb250ZW50IjpbImNvbnN0IEFXU1hSYXkgPSByZXF1aXJlKCdodWxhYi14cmF5LXNkaycpO1xuY29uc3QgQ29uZmlnID0gcmVxdWlyZSgnLi9Db25maWcnKTtcbmNvbnN0IEF1dGggPSByZXF1aXJlKCcuL0F1dGgnKTtcbmNvbnN0IFJFU1RDb250cm9sbGVyID0gcmVxdWlyZSgncGFyc2UvbGliL25vZGUvUkVTVENvbnRyb2xsZXInKTtcbmNvbnN0IFVSTCA9IHJlcXVpcmUoJ3VybCcpO1xuY29uc3QgUGFyc2UgPSByZXF1aXJlKCdwYXJzZS9ub2RlJyk7XG5cbmZ1bmN0aW9uIGdldFNlc3Npb25Ub2tlbihvcHRpb25zKSB7XG4gIGlmIChvcHRpb25zICYmIHR5cGVvZiBvcHRpb25zLnNlc3Npb25Ub2tlbiA9PT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG9wdGlvbnMuc2Vzc2lvblRva2VuKTtcbiAgfVxuICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG51bGwpO1xufVxuXG5mdW5jdGlvbiBnZXRBdXRoKG9wdGlvbnMgPSB7fSwgY29uZmlnKSB7XG4gIGNvbnN0IGluc3RhbGxhdGlvbklkID0gb3B0aW9ucy5pbnN0YWxsYXRpb25JZCB8fCAnY2xvdWQnO1xuICBpZiAob3B0aW9ucy51c2VNYXN0ZXJLZXkpIHtcbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFxuICAgICAgbmV3IEF1dGguQXV0aCh7IGNvbmZpZywgaXNNYXN0ZXI6IHRydWUsIGluc3RhbGxhdGlvbklkIH0pXG4gICAgKTtcbiAgfVxuICByZXR1cm4gZ2V0U2Vzc2lvblRva2VuKG9wdGlvbnMpLnRoZW4oc2Vzc2lvblRva2VuID0+IHtcbiAgICBpZiAoc2Vzc2lvblRva2VuKSB7XG4gICAgICBvcHRpb25zLnNlc3Npb25Ub2tlbiA9IHNlc3Npb25Ub2tlbjtcbiAgICAgIHJldHVybiBBdXRoLmdldEF1dGhGb3JTZXNzaW9uVG9rZW4oe1xuICAgICAgICBjb25maWcsXG4gICAgICAgIHNlc3Npb25Ub2tlbjogc2Vzc2lvblRva2VuLFxuICAgICAgICBpbnN0YWxsYXRpb25JZCxcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG5ldyBBdXRoLkF1dGgoeyBjb25maWcsIGluc3RhbGxhdGlvbklkIH0pKTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBQYXJzZVNlcnZlclJFU1RDb250cm9sbGVyKGFwcGxpY2F0aW9uSWQsIHJvdXRlcikge1xuICBmdW5jdGlvbiBoYW5kbGVSZXF1ZXN0KG1ldGhvZCwgcGF0aCwgZGF0YSA9IHt9LCBvcHRpb25zID0ge30sIGNvbmZpZykge1xuICAgIC8vIFN0b3JlIHRoZSBhcmd1bWVudHMsIGZvciBsYXRlciB1c2UgaWYgaW50ZXJuYWwgZmFpbHNcbiAgICBjb25zdCBhcmdzID0gYXJndW1lbnRzO1xuXG4gICAgaWYgKCFjb25maWcpIHtcbiAgICAgIGNvbmZpZyA9IENvbmZpZy5nZXQoYXBwbGljYXRpb25JZCk7XG4gICAgfVxuICAgIGNvbnN0IHNlcnZlclVSTCA9IFVSTC5wYXJzZShjb25maWcuc2VydmVyVVJMKTtcbiAgICBpZiAocGF0aC5pbmRleE9mKHNlcnZlclVSTC5wYXRoKSA9PT0gMCkge1xuICAgICAgcGF0aCA9IHBhdGguc2xpY2Uoc2VydmVyVVJMLnBhdGgubGVuZ3RoLCBwYXRoLmxlbmd0aCk7XG4gICAgfVxuXG4gICAgaWYgKHBhdGhbMF0gIT09ICcvJykge1xuICAgICAgcGF0aCA9ICcvJyArIHBhdGg7XG4gICAgfVxuXG4gICAgaWYgKHBhdGggPT09ICcvYmF0Y2gnKSB7XG4gICAgICBsZXQgaW5pdGlhbFByb21pc2UgPSBQcm9taXNlLnJlc29sdmUoKTtcbiAgICAgIGlmIChkYXRhLnRyYW5zYWN0aW9uID09PSB0cnVlKSB7XG4gICAgICAgIGluaXRpYWxQcm9taXNlID0gY29uZmlnLmRhdGFiYXNlLmNyZWF0ZVRyYW5zYWN0aW9uYWxTZXNzaW9uKCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gaW5pdGlhbFByb21pc2UudGhlbigoKSA9PiB7XG4gICAgICAgIGNvbnN0IHByb21pc2VzID0gZGF0YS5yZXF1ZXN0cy5tYXAocmVxdWVzdCA9PiB7XG4gICAgICAgICAgcmV0dXJuIGhhbmRsZVJlcXVlc3QoXG4gICAgICAgICAgICByZXF1ZXN0Lm1ldGhvZCxcbiAgICAgICAgICAgIHJlcXVlc3QucGF0aCxcbiAgICAgICAgICAgIHJlcXVlc3QuYm9keSxcbiAgICAgICAgICAgIG9wdGlvbnMsXG4gICAgICAgICAgICBjb25maWdcbiAgICAgICAgICApLnRoZW4oXG4gICAgICAgICAgICByZXNwb25zZSA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHJlc3BvbnNlIH07XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZXJyb3IgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgIGVycm9yOiB7IGNvZGU6IGVycm9yLmNvZGUsIGVycm9yOiBlcnJvci5tZXNzYWdlIH0sXG4gICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcykudGhlbihyZXN1bHQgPT4ge1xuICAgICAgICAgIGlmIChkYXRhLnRyYW5zYWN0aW9uID09PSB0cnVlKSB7XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgIHJlc3VsdC5maW5kKHJlc3VsdEl0ZW0gPT4gdHlwZW9mIHJlc3VsdEl0ZW0uZXJyb3IgPT09ICdvYmplY3QnKVxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgIHJldHVybiBjb25maWcuZGF0YWJhc2UuYWJvcnRUcmFuc2FjdGlvbmFsU2Vzc2lvbigpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdChyZXN1bHQpO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybiBjb25maWcuZGF0YWJhc2UuY29tbWl0VHJhbnNhY3Rpb25hbFNlc3Npb24oKS50aGVuKCgpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgbGV0IHF1ZXJ5O1xuICAgIGlmIChtZXRob2QgPT09ICdHRVQnKSB7XG4gICAgICBxdWVyeSA9IGRhdGE7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRyYWNlUHJvbWlzZSgnZ2V0QXV0aCcsIGdldEF1dGgob3B0aW9ucywgY29uZmlnKSkudGhlbihhdXRoID0+IHtcbiAgICAgICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgICAgICBib2R5OiBkYXRhLFxuICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICBhdXRoLFxuICAgICAgICAgIGluZm86IHtcbiAgICAgICAgICAgIGFwcGxpY2F0aW9uSWQ6IGFwcGxpY2F0aW9uSWQsXG4gICAgICAgICAgICBzZXNzaW9uVG9rZW46IG9wdGlvbnMuc2Vzc2lvblRva2VuLFxuICAgICAgICAgICAgY29udGV4dDogb3B0aW9ucy5jb250ZXh0IHx8IHt9LCAvLyBBZGQgY29udGV4dFxuICAgICAgICAgIH0sXG4gICAgICAgICAgcXVlcnksXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKVxuICAgICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICAgIHJldHVybiByb3V0ZXIudHJ5Um91dGVSZXF1ZXN0KG1ldGhvZCwgcGF0aCwgcmVxdWVzdCk7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAudGhlbihcbiAgICAgICAgICAgIHJlc3BvbnNlID0+IHtcbiAgICAgICAgICAgICAgcmVzb2x2ZShyZXNwb25zZS5yZXNwb25zZSwgcmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZSk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZXJyID0+IHtcbiAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIGVyciBpbnN0YW5jZW9mIFBhcnNlLkVycm9yICYmXG4gICAgICAgICAgICAgICAgZXJyLmNvZGUgPT0gUGFyc2UuRXJyb3IuSU5WQUxJRF9KU09OICYmXG4gICAgICAgICAgICAgICAgZXJyLm1lc3NhZ2UgPT0gYGNhbm5vdCByb3V0ZSAke21ldGhvZH0gJHtwYXRofWBcbiAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgUkVTVENvbnRyb2xsZXIucmVxdWVzdC5hcHBseShudWxsLCBhcmdzKS50aGVuKHJlc29sdmUsIHJlamVjdCk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICApO1xuICAgICAgfSwgcmVqZWN0KTtcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiB7XG4gICAgcmVxdWVzdDogaGFuZGxlUmVxdWVzdCxcbiAgICBhamF4OiBSRVNUQ29udHJvbGxlci5hamF4LFxuICB9O1xufVxuXG5mdW5jdGlvbiB0cmFjZVByb21pc2Uob3BlcmF0aW9uLCBwcm9taXNlID0gUHJvbWlzZS5yZXNvbHZlKCkpIHtcbiAgLy8gVGVtcG9yYXJ5IHJlbW92aW5nIHRyYWNlIGhlcmVcbiAgcmV0dXJuIHByb21pc2U7XG4gIC8vIGNvbnN0IHBhcmVudCA9IEFXU1hSYXkuZ2V0U2VnbWVudCgpO1xuICAvLyBpZiAoIXBhcmVudCkge1xuICAvLyAgIHJldHVybiBwcm9taXNlO1xuICAvLyB9XG4gIC8vIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gIC8vICAgQVdTWFJheS5jYXB0dXJlQXN5bmNGdW5jKFxuICAvLyAgICAgYFBhcnNlLVNlcnZlcl9SRVNUQ29udHJvbGxlcl8ke29wZXJhdGlvbn1gLFxuICAvLyAgICAgc3Vic2VnbWVudCA9PiB7XG4gIC8vICAgICAgIHN1YnNlZ21lbnQgJiZcbiAgLy8gICAgICAgICBzdWJzZWdtZW50LmFkZEFubm90YXRpb24oJ0NvbnRyb2xsZXInLCAnUGFyc2VTZXJ2ZXJSRVNUQ29udHJvbGxlcicpO1xuICAvLyAgICAgICBzdWJzZWdtZW50ICYmIHN1YnNlZ21lbnQuYWRkQW5ub3RhdGlvbignT3BlcmF0aW9uJywgb3BlcmF0aW9uKTtcbiAgLy8gICAgICAgKHByb21pc2UgaW5zdGFuY2VvZiBQcm9taXNlID8gcHJvbWlzZSA6IFByb21pc2UucmVzb2x2ZShwcm9taXNlKSkudGhlbihcbiAgLy8gICAgICAgICBmdW5jdGlvbihyZXN1bHQpIHtcbiAgLy8gICAgICAgICAgIHJlc29sdmUocmVzdWx0KTtcbiAgLy8gICAgICAgICAgIHN1YnNlZ21lbnQgJiYgc3Vic2VnbWVudC5jbG9zZSgpO1xuICAvLyAgICAgICAgIH0sXG4gIC8vICAgICAgICAgZnVuY3Rpb24oZXJyb3IpIHtcbiAgLy8gICAgICAgICAgIHJlamVjdChlcnJvcik7XG4gIC8vICAgICAgICAgICBzdWJzZWdtZW50ICYmIHN1YnNlZ21lbnQuY2xvc2UoZXJyb3IpO1xuICAvLyAgICAgICAgIH1cbiAgLy8gICAgICAgKTtcbiAgLy8gICAgIH1cbiAgLy8gICApO1xuICAvLyB9KTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgUGFyc2VTZXJ2ZXJSRVNUQ29udHJvbGxlcjtcbmV4cG9ydCB7IFBhcnNlU2VydmVyUkVTVENvbnRyb2xsZXIgfTtcbiJdfQ==