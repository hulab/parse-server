"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.load = void 0;

var _graphql = require("graphql");

var _graphqlListFields = _interopRequireDefault(require("graphql-list-fields"));

var _pluralize = _interopRequireDefault(require("pluralize"));

var defaultGraphQLTypes = _interopRequireWildcard(require("./defaultGraphQLTypes"));

var objectsQueries = _interopRequireWildcard(require("../helpers/objectsQueries"));

var _ParseGraphQLController = require("../../Controllers/ParseGraphQLController");

var _className = require("../transformers/className");

var _parseGraphQLUtils = require("../parseGraphQLUtils");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const getParseClassQueryConfig = function (parseClassConfig) {
  return parseClassConfig && parseClassConfig.query || {};
};

const getQuery = async (className, _source, args, context, queryInfo) => {
  const {
    id,
    options
  } = args;
  const {
    readPreference,
    includeReadPreference
  } = options || {};
  const {
    config,
    auth,
    info
  } = context;
  const selectedFields = (0, _graphqlListFields.default)(queryInfo);
  const {
    keys,
    include
  } = (0, _parseGraphQLUtils.extractKeysAndInclude)(selectedFields);
  return await objectsQueries.getObject(className, id, keys, include, readPreference, includeReadPreference, config, auth, info);
};

const load = function (parseGraphQLSchema, parseClass, parseClassConfig) {
  const className = parseClass.className;
  const graphQLClassName = (0, _className.transformClassNameToGraphQL)(className);
  const {
    get: isGetEnabled = true,
    find: isFindEnabled = true
  } = getParseClassQueryConfig(parseClassConfig);
  const {
    classGraphQLOutputType,
    classGraphQLFindArgs,
    classGraphQLFindResultType
  } = parseGraphQLSchema.parseClassTypes[className];

  if (isGetEnabled) {
    const getGraphQLQueryName = graphQLClassName.charAt(0).toLowerCase() + graphQLClassName.slice(1);
    parseGraphQLSchema.addGraphQLQuery(getGraphQLQueryName, {
      description: `The ${getGraphQLQueryName} query can be used to get an object of the ${graphQLClassName} class by its id.`,
      args: {
        id: defaultGraphQLTypes.OBJECT_ID_ATT,
        options: defaultGraphQLTypes.READ_OPTIONS_ATT
      },
      type: new _graphql.GraphQLNonNull(classGraphQLOutputType || defaultGraphQLTypes.OBJECT),

      async resolve(_source, args, context, queryInfo) {
        try {
          return await getQuery(className, _source, args, context, queryInfo);
        } catch (e) {
          parseGraphQLSchema.handleError(e);
        }
      }

    });
  }

  if (isFindEnabled) {
    const findGraphQLQueryName = (0, _pluralize.default)(graphQLClassName.charAt(0).toLowerCase() + graphQLClassName.slice(1));
    parseGraphQLSchema.addGraphQLQuery(findGraphQLQueryName, {
      description: `The ${findGraphQLQueryName} query can be used to find objects of the ${graphQLClassName} class.`,
      args: classGraphQLFindArgs,
      type: new _graphql.GraphQLNonNull(classGraphQLFindResultType || defaultGraphQLTypes.FIND_RESULT),

      async resolve(_source, args, context, queryInfo) {
        try {
          const {
            where,
            order,
            skip,
            limit,
            options
          } = args;
          const {
            readPreference,
            includeReadPreference,
            subqueryReadPreference
          } = options || {};
          const {
            config,
            auth,
            info
          } = context;
          const selectedFields = (0, _graphqlListFields.default)(queryInfo);
          const {
            keys,
            include
          } = (0, _parseGraphQLUtils.extractKeysAndInclude)(selectedFields.filter(field => field.includes('.')).map(field => field.slice(field.indexOf('.') + 1)));
          const parseOrder = order && order.join(',');
          return await objectsQueries.findObjects(className, where, parseOrder, skip, limit, keys, include, false, readPreference, includeReadPreference, subqueryReadPreference, config, auth, info, selectedFields.map(field => field.split('.', 1)[0]), parseClass.fields);
        } catch (e) {
          parseGraphQLSchema.handleError(e);
        }
      }

    });
  }
};

exports.load = load;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9HcmFwaFFML2xvYWRlcnMvcGFyc2VDbGFzc1F1ZXJpZXMuanMiXSwibmFtZXMiOlsiZ2V0UGFyc2VDbGFzc1F1ZXJ5Q29uZmlnIiwicGFyc2VDbGFzc0NvbmZpZyIsInF1ZXJ5IiwiZ2V0UXVlcnkiLCJjbGFzc05hbWUiLCJfc291cmNlIiwiYXJncyIsImNvbnRleHQiLCJxdWVyeUluZm8iLCJpZCIsIm9wdGlvbnMiLCJyZWFkUHJlZmVyZW5jZSIsImluY2x1ZGVSZWFkUHJlZmVyZW5jZSIsImNvbmZpZyIsImF1dGgiLCJpbmZvIiwic2VsZWN0ZWRGaWVsZHMiLCJrZXlzIiwiaW5jbHVkZSIsIm9iamVjdHNRdWVyaWVzIiwiZ2V0T2JqZWN0IiwibG9hZCIsInBhcnNlR3JhcGhRTFNjaGVtYSIsInBhcnNlQ2xhc3MiLCJncmFwaFFMQ2xhc3NOYW1lIiwiZ2V0IiwiaXNHZXRFbmFibGVkIiwiZmluZCIsImlzRmluZEVuYWJsZWQiLCJjbGFzc0dyYXBoUUxPdXRwdXRUeXBlIiwiY2xhc3NHcmFwaFFMRmluZEFyZ3MiLCJjbGFzc0dyYXBoUUxGaW5kUmVzdWx0VHlwZSIsInBhcnNlQ2xhc3NUeXBlcyIsImdldEdyYXBoUUxRdWVyeU5hbWUiLCJjaGFyQXQiLCJ0b0xvd2VyQ2FzZSIsInNsaWNlIiwiYWRkR3JhcGhRTFF1ZXJ5IiwiZGVzY3JpcHRpb24iLCJkZWZhdWx0R3JhcGhRTFR5cGVzIiwiT0JKRUNUX0lEX0FUVCIsIlJFQURfT1BUSU9OU19BVFQiLCJ0eXBlIiwiR3JhcGhRTE5vbk51bGwiLCJPQkpFQ1QiLCJyZXNvbHZlIiwiZSIsImhhbmRsZUVycm9yIiwiZmluZEdyYXBoUUxRdWVyeU5hbWUiLCJGSU5EX1JFU1VMVCIsIndoZXJlIiwib3JkZXIiLCJza2lwIiwibGltaXQiLCJzdWJxdWVyeVJlYWRQcmVmZXJlbmNlIiwiZmlsdGVyIiwiZmllbGQiLCJpbmNsdWRlcyIsIm1hcCIsImluZGV4T2YiLCJwYXJzZU9yZGVyIiwiam9p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OENBQ3hCRixjQUFjLENBQ1h1QyxNQURILENBQ1VDLEtBQUssSUFBSUEsS0FBSyxDQUFDQyxRQUFOLENBQWUsR0FBZixDQURuQixFQUVHQyxHQUZILENBRU9GLEtBQUssSUFBSUEsS0FBSyxDQUFDcEIsS0FBTixDQUFZb0IsS0FBSyxDQUFDRyxPQUFOLENBQWMsR0FBZCxJQUFxQixDQUFqQyxDQUZoQixDQUR3QixDQUExQjtBQUtBLGdCQUFNQyxVQUFVLEdBQUdULEtBQUssSUFBSUEsS0FBSyxDQUFDVSxJQUFOLENBQVcsR0FBWCxDQUE1QjtBQUVBLGlCQUFPLE1BQU0xQyxjQUFjLENBQUMyQyxXQUFmLENBQ1gxRCxTQURXLEVBRVg4QyxLQUZXLEVBR1hVLFVBSFcsRUFJWFIsSUFKVyxFQUtYQyxLQUxXLEVBTVhwQyxJQU5XLEVBT1hDLE9BUFcsRUFRWCxLQVJXLEVBU1hQLGNBVFcsRUFVWEMscUJBVlcsRUFXWDBDLHNCQVhXLEVBWVh6QyxNQVpXLEVBYVhDLElBYlcsRUFjWEMsSUFkVyxFQWVYQyxjQUFjLENBQUMwQyxHQUFmLENBQW1CRixLQUFLLElBQUlBLEtBQUssQ0FBQ08sS0FBTixDQUFZLEdBQVosRUFBaUIsQ0FBakIsRUFBb0IsQ0FBcEIsQ0FBNUIsQ0FmVyxFQWdCWHhDLFVBQVUsQ0FBQ3lDLE1BaEJBLENBQWI7QUFrQkQsU0FuQ0QsQ0FtQ0UsT0FBT2xCLENBQVAsRUFBVTtBQUNWeEIsVUFBQUEsa0JBQWtCLENBQUN5QixXQUFuQixDQUErQkQsQ0FBL0I7QUFDRDtBQUNGOztBQTdDc0QsS0FBekQ7QUErQ0Q7QUFDRixDQTVGRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEdyYXBoUUxOb25OdWxsIH0gZnJvbSAnZ3JhcGhxbCc7XG5pbXBvcnQgZ2V0RmllbGROYW1lcyBmcm9tICdncmFwaHFsLWxpc3QtZmllbGRzJztcbmltcG9ydCBwbHVyYWxpemUgZnJvbSAncGx1cmFsaXplJztcbmltcG9ydCAqIGFzIGRlZmF1bHRHcmFwaFFMVHlwZXMgZnJvbSAnLi9kZWZhdWx0R3JhcGhRTFR5cGVzJztcbmltcG9ydCAqIGFzIG9iamVjdHNRdWVyaWVzIGZyb20gJy4uL2hlbHBlcnMvb2JqZWN0c1F1ZXJpZXMnO1xuaW1wb3J0IHsgUGFyc2VHcmFwaFFMQ2xhc3NDb25maWcgfSBmcm9tICcuLi8uLi9Db250cm9sbGVycy9QYXJzZUdyYXBoUUxDb250cm9sbGVyJztcbmltcG9ydCB7IHRyYW5zZm9ybUNsYXNzTmFtZVRvR3JhcGhRTCB9IGZyb20gJy4uL3RyYW5zZm9ybWVycy9jbGFzc05hbWUnO1xuaW1wb3J0IHsgZXh0cmFjdEtleXNBbmRJbmNsdWRlIH0gZnJvbSAnLi4vcGFyc2VHcmFwaFFMVXRpbHMnO1xuXG5jb25zdCBnZXRQYXJzZUNsYXNzUXVlcnlDb25maWcgPSBmdW5jdGlvbihcbiAgcGFyc2VDbGFzc0NvbmZpZzogP1BhcnNlR3JhcGhRTENsYXNzQ29uZmlnXG4pIHtcbiAgcmV0dXJuIChwYXJzZUNsYXNzQ29uZmlnICYmIHBhcnNlQ2xhc3NDb25maWcucXVlcnkpIHx8IHt9O1xufTtcblxuY29uc3QgZ2V0UXVlcnkgPSBhc3luYyAoY2xhc3NOYW1lLCBfc291cmNlLCBhcmdzLCBjb250ZXh0LCBxdWVyeUluZm8pID0+IHtcbiAgY29uc3QgeyBpZCwgb3B0aW9ucyB9ID0gYXJncztcbiAgY29uc3QgeyByZWFkUHJlZmVyZW5jZSwgaW5jbHVkZVJlYWRQcmVmZXJlbmNlIH0gPSBvcHRpb25zIHx8IHt9O1xuICBjb25zdCB7IGNvbmZpZywgYXV0aCwgaW5mbyB9ID0gY29udGV4dDtcbiAgY29uc3Qgc2VsZWN0ZWRGaWVsZHMgPSBnZXRGaWVsZE5hbWVzKHF1ZXJ5SW5mbyk7XG5cbiAgY29uc3QgeyBrZXlzLCBpbmNsdWRlIH0gPSBleHRyYWN0S2V5c0FuZEluY2x1ZGUoc2VsZWN0ZWRGaWVsZHMpO1xuXG4gIHJldHVybiBhd2FpdCBvYmplY3RzUXVlcmllcy5nZXRPYmplY3QoXG4gICAgY2xhc3NOYW1lLFxuICAgIGlkLFxuICAgIGtleXMsXG4gICAgaW5jbHVkZSxcbiAgICByZWFkUHJlZmVyZW5jZSxcbiAgICBpbmNsdWRlUmVhZFByZWZlcmVuY2UsXG4gICAgY29uZmlnLFxuICAgIGF1dGgsXG4gICAgaW5mb1xuICApO1xufTtcblxuY29uc3QgbG9hZCA9IGZ1bmN0aW9uKFxuICBwYXJzZUdyYXBoUUxTY2hlbWEsXG4gIHBhcnNlQ2xhc3MsXG4gIHBhcnNlQ2xhc3NDb25maWc6ID9QYXJzZUdyYXBoUUxDbGFzc0NvbmZpZ1xuKSB7XG4gIGNvbnN0IGNsYXNzTmFtZSA9IHBhcnNlQ2xhc3MuY2xhc3NOYW1lO1xuICBjb25zdCBncmFwaFFMQ2xhc3NOYW1lID0gdHJhbnNmb3JtQ2xhc3NOYW1lVG9HcmFwaFFMKGNsYXNzTmFtZSk7XG4gIGNvbnN0IHtcbiAgICBnZXQ6IGlzR2V0RW5hYmxlZCA9IHRydWUsXG4gICAgZmluZDogaXNGaW5kRW5hYmxlZCA9IHRydWUsXG4gIH0gPSBnZXRQYXJzZUNsYXNzUXVlcnlDb25maWcocGFyc2VDbGFzc0NvbmZpZyk7XG5cbiAgY29uc3Qge1xuICAgIGNsYXNzR3JhcGhRTE91dHB1dFR5cGUsXG4gICAgY2xhc3NHcmFwaFFMRmluZEFyZ3MsXG4gICAgY2xhc3NHcmFwaFFMRmluZFJlc3VsdFR5cGUsXG4gIH0gPSBwYXJzZUdyYXBoUUxTY2hlbWEucGFyc2VDbGFzc1R5cGVzW2NsYXNzTmFtZV07XG5cbiAgaWYgKGlzR2V0RW5hYmxlZCkge1xuICAgIGNvbnN0IGdldEdyYXBoUUxRdWVyeU5hbWUgPVxuICAgICAgZ3JhcGhRTENsYXNzTmFtZS5jaGFyQXQoMCkudG9Mb3dlckNhc2UoKSArIGdyYXBoUUxDbGFzc05hbWUuc2xpY2UoMSk7XG4gICAgcGFyc2VHcmFwaFFMU2NoZW1hLmFkZEdyYXBoUUxRdWVyeShnZXRHcmFwaFFMUXVlcnlOYW1lLCB7XG4gICAgICBkZXNjcmlwdGlvbjogYFRoZSAke2dldEdyYXBoUUxRdWVyeU5hbWV9IHF1ZXJ5IGNhbiBiZSB1c2VkIHRvIGdldCBhbiBvYmplY3Qgb2YgdGhlICR7Z3JhcGhRTENsYXNzTmFtZX0gY2xhc3MgYnkgaXRzIGlkLmAsXG4gICAgICBhcmdzOiB7XG4gICAgICAgIGlkOiBkZWZhdWx0R3JhcGhRTFR5cGVzLk9CSkVDVF9JRF9BVFQsXG4gICAgICAgIG9wdGlvbnM6IGRlZmF1bHRHcmFwaFFMVHlwZXMuUkVBRF9PUFRJT05TX0FUVCxcbiAgICAgIH0sXG4gICAgICB0eXBlOiBuZXcgR3JhcGhRTE5vbk51bGwoXG4gICAgICAgIGNsYXNzR3JhcGhRTE91dHB1dFR5cGUgfHwgZGVmYXVsdEdyYXBoUUxUeXBlcy5PQkpFQ1RcbiAgICAgICksXG4gICAgICBhc3luYyByZXNvbHZlKF9zb3VyY2UsIGFyZ3MsIGNvbnRleHQsIHF1ZXJ5SW5mbykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHJldHVybiBhd2FpdCBnZXRRdWVyeShjbGFzc05hbWUsIF9zb3VyY2UsIGFyZ3MsIGNvbnRleHQsIHF1ZXJ5SW5mbyk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBwYXJzZUdyYXBoUUxTY2hlbWEuaGFuZGxlRXJyb3IoZSk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBpZiAoaXNGaW5kRW5hYmxlZCkge1xuICAgIGNvbnN0IGZpbmRHcmFwaFFMUXVlcnlOYW1lID0gcGx1cmFsaXplKFxuICAgICAgZ3JhcGhRTENsYXNzTmFtZS5jaGFyQXQoMCkudG9Mb3dlckNhc2UoKSArIGdyYXBoUUxDbGFzc05hbWUuc2xpY2UoMSlcbiAgICApO1xuICAgIHBhcnNlR3JhcGhRTFNjaGVtYS5hZGRHcmFwaFFMUXVlcnkoZmluZEdyYXBoUUxRdWVyeU5hbWUsIHtcbiAgICAgIGRlc2NyaXB0aW9uOiBgVGhlICR7ZmluZEdyYXBoUUxRdWVyeU5hbWV9IHF1ZXJ5IGNhbiBiZSB1c2VkIHRvIGZpbmQgb2JqZWN0cyBvZiB0aGUgJHtncmFwaFFMQ2xhc3NOYW1lfSBjbGFzcy5gLFxuICAgICAgYXJnczogY2xhc3NHcmFwaFFMRmluZEFyZ3MsXG4gICAgICB0eXBlOiBuZXcgR3JhcGhRTE5vbk51bGwoXG4gICAgICAgIGNsYXNzR3JhcGhRTEZpbmRSZXN1bHRUeXBlIHx8IGRlZmF1bHRHcmFwaFFMVHlwZXMuRklORF9SRVNVTFRcbiAgICAgICksXG4gICAgICBhc3luYyByZXNvbHZlKF9zb3VyY2UsIGFyZ3MsIGNvbnRleHQsIHF1ZXJ5SW5mbykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHsgd2hlcmUsIG9yZGVyLCBza2lwLCBsaW1pdCwgb3B0aW9ucyB9ID0gYXJncztcbiAgICAgICAgICBjb25zdCB7XG4gICAgICAgICAgICByZWFkUHJlZmVyZW5jZSxcbiAgICAgICAgICAgIGluY2x1ZGVSZWFkUHJlZmVyZW5jZSxcbiAgICAgICAgICAgIHN1YnF1ZXJ5UmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgfSA9IG9wdGlvbnMgfHwge307XG4gICAgICAgICAgY29uc3QgeyBjb25maWcsIGF1dGgsIGluZm8gfSA9IGNvbnRleHQ7XG4gICAgICAgICAgY29uc3Qgc2VsZWN0ZWRGaWVsZHMgPSBnZXRGaWVsZE5hbWVzKHF1ZXJ5SW5mbyk7XG5cbiAgICAgICAgICBjb25zdCB7IGtleXMsIGluY2x1ZGUgfSA9IGV4dHJhY3RLZXlzQW5kSW5jbHVkZShcbiAgICAgICAgICAgIHNlbGVjdGVkRmllbGRzXG4gICAgICAgICAgICAgIC5maWx0ZXIoZmllbGQgPT4gZmllbGQuaW5jbHVkZXMoJy4nKSlcbiAgICAgICAgICAgICAgLm1hcChmaWVsZCA9PiBmaWVsZC5zbGljZShmaWVsZC5pbmRleE9mKCcuJykgKyAxKSlcbiAgICAgICAgICApO1xuICAgICAgICAgIGNvbnN0IHBhcnNlT3JkZXIgPSBvcmRlciAmJiBvcmRlci5qb2luKCcsJyk7XG5cbiAgICAgICAgICByZXR1cm4gYXdhaXQgb2JqZWN0c1F1ZXJpZXMuZmluZE9iamVjdHMoXG4gICAgICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgICAgICB3aGVyZSxcbiAgICAgICAgICAgIHBhcnNlT3JkZXIsXG4gICAgICAgICAgICBza2lwLFxuICAgICAgICAgICAgbGltaXQsXG4gICAgICAgICAgICBrZXlzLFxuICAgICAgICAgICAgaW5jbHVkZSxcbiAgICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgICAgcmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgICBpbmNsdWRlUmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgICBzdWJxdWVyeVJlYWRQcmVmZXJlbmNlLFxuICAgICAgICAgICAgY29uZmlnLFxuICAgICAgICAgICAgYXV0aCxcbiAgICAgICAgICAgIGluZm8sXG4gICAgICAgICAgICBzZWxlY3RlZEZpZWxkcy5tYXAoZmllbGQgPT4gZmllbGQuc3BsaXQoJy4nLCAxKVswXSksXG4gICAgICAgICAgICBwYXJzZUNsYXNzLmZpZWxkc1xuICAgICAgICAgICk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBwYXJzZUdyYXBoUUxTY2hlbWEuaGFuZGxlRXJyb3IoZSk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cbn07XG5cbmV4cG9ydCB7IGxvYWQgfTtcbiJdfQ==