"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.load = void 0;

var _graphql = require("graphql");

var _graphqlListFields = _interopRequireDefault(require("graphql-list-fields"));

var defaultGraphQLTypes = _interopRequireWildcard(require("./defaultGraphQLTypes"));

var objectsQueries = _interopRequireWildcard(require("./objectsQueries"));

var parseClassTypes = _interopRequireWildcard(require("./parseClassTypes"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const load = (parseGraphQLSchema, parseClass) => {
  const className = parseClass.className;
  const {
    classGraphQLOutputType,
    classGraphQLFindArgs,
    classGraphQLFindResultType
  } = parseGraphQLSchema.parseClassTypes[className];
  const getGraphQLQueryName = `get${className}`;
  parseGraphQLSchema.graphQLObjectsQueries[getGraphQLQueryName] = {
    description: `The ${getGraphQLQueryName} query can be used to get an object of the ${className} class by its id.`,
    args: {
      objectId: defaultGraphQLTypes.OBJECT_ID_ATT,
      readPreference: defaultGraphQLTypes.READ_PREFERENCE_ATT,
      includeReadPreference: defaultGraphQLTypes.INCLUDE_READ_PREFERENCE_ATT
    },
    type: new _graphql.GraphQLNonNull(classGraphQLOutputType),

    async resolve(_source, args, context, queryInfo) {
      try {
        const {
          objectId,
          readPreference,
          includeReadPreference
        } = args;
        const {
          config,
          auth,
          info
        } = context;
        const selectedFields = (0, _graphqlListFields.default)(queryInfo);
        const {
          keys,
          include
        } = parseClassTypes.extractKeysAndInclude(selectedFields);
        return await objectsQueries.getObject(className, objectId, keys, include, readPreference, includeReadPreference, config, auth, info);
      } catch (e) {
        parseGraphQLSchema.handleError(e);
      }
    }

  };
  const findGraphQLQueryName = `find${className}`;
  parseGraphQLSchema.graphQLObjectsQueries[findGraphQLQueryName] = {
    description: `The ${findGraphQLQueryName} query can be used to find objects of the ${className} class.`,
    args: classGraphQLFindArgs,
    type: new _graphql.GraphQLNonNull(classGraphQLFindResultType),

    async resolve(_source, args, context, queryInfo) {
      try {
        const {
          where,
          order,
          skip,
          limit,
          readPreference,
          includeReadPreference,
          subqueryReadPreference
        } = args;
        const {
          config,
          auth,
          info
        } = context;
        const selectedFields = (0, _graphqlListFields.default)(queryInfo);
        const {
          keys,
          include
        } = parseClassTypes.extractKeysAndInclude(selectedFields.filter(field => field.includes('.')).map(field => field.slice(field.indexOf('.') + 1)));
        const parseOrder = order && order.join(',');
        return await objectsQueries.findObjects(className, where, parseOrder, skip, limit, keys, include, false, readPreference, includeReadPreference, subqueryReadPreference, config, auth, info, selectedFields.map(field => field.split('.', 1)[0]));
      } catch (e) {
        parseGraphQLSchema.handleError(e);
      }
    }

  };
};

exports.load = load;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9HcmFwaFFML2xvYWRlcnMvcGFyc2VDbGFzc1F1ZXJpZXMuanMiXSwibmFtZXMiOlsibG9hZCIsInBhcnNlR3JhcGhRTFNjaGVtYSIsInBhcnNlQ2xhc3MiLCJjbGFzc05hbWUiLCJjbGFzc0dyYXBoUUxPdXRwdXRUeXBlIiwiY2xhc3NHcmFwaFFMRmluZEFyZ3MiLCJjbGFzc0dyYXBoUUxGaW5kUmVzdWx0VHlwZSIsInBhcnNlQ2xhc3NUeXBlcyIsImdldEdyYXBoUUxRdWVyeU5hbWUiLCJncmFwaFFMT2JqZWN0c1F1ZXJpZXMiLCJkZXNjcmlwdGlvbiIsImFyZ3MiLCJvYmplY3RJZCIsImRlZmF1bHRHcmFwaFFMVHlwZXMiLCJPQkpFQ1RfSURfQVRUIiwicmVhZFByZWZlcmVuY2UiLCJSRUFEX1BSRUZFUkVOQ0VfQVRUIiwiaW5jbHVkZVJlYWRQcmVmZXJlbmNlIiwiSU5DTFVERV9SRUFEX1BSRUZFUkVOQ0VfQVRUIiwidHlwZSIsIkdyYXBoUUxOb25OdWxsIiwicmVzb2x2ZSIsIl9zb3VyY2UiLCJjb250ZXh0IiwicXVlcnlJbmZvIiwiY29uZmlnIiwiYXV0aCIsImluZm8iLCJzZWxlY3RlZEZpZWxkcyIsImtleXMiLCJpbmNsdWRlIiwiZXh0cmFjdEtleXNBbmRJbmNsdWRlIiwib2JqZWN0c1F1ZXJpZXMiLCJnZXRPYmplY3QiLCJlIiwiaGFuZGxlRXJyb3IiLCJmaW5kR3JhcGhRTFF1ZXJ5TmFtZSIsIndoZXJlIiwib3JkZXIiLCJza2lwIiwibGltaXQiLCJzdWJxdWVyeVJlYWRQcmVmZXJlbmNlIiwiZmlsdGVyIiwiZmllbGQiLCJpbmNsdWRlcyIsIm1hcCIsInNsaWNlIiwiaW5kZXhPZiIsInBhcnNlT3JkZXIiLCJqb2luIiwiZmluZE9iamVjdHMiLCJzcGxpdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOzs7Ozs7QUFFQSxNQUFNQSxJQUFJLEdBQUcsQ0FBQ0Msa0JBQUQsRUFB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QUNYYyxNQURILENBQ1VDLEtBQUssSUFBSUEsS0FBSyxDQUFDQyxRQUFOLENBQWUsR0FBZixDQURuQixFQUVHQyxHQUZILENBRU9GLEtBQUssSUFBSUEsS0FBSyxDQUFDRyxLQUFOLENBQVlILEtBQUssQ0FBQ0ksT0FBTixDQUFjLEdBQWQsSUFBcUIsQ0FBakMsQ0FGaEIsQ0FEd0IsQ0FBMUI7QUFLQSxjQUFNQyxVQUFVLEdBQUdWLEtBQUssSUFBSUEsS0FBSyxDQUFDVyxJQUFOLENBQVcsR0FBWCxDQUE1QjtBQUVBLGVBQU8sTUFBTWpCLGNBQWMsQ0FBQ2tCLFdBQWYsQ0FDWC9DLFNBRFcsRUFFWGtDLEtBRlcsRUFHWFcsVUFIVyxFQUlYVCxJQUpXLEVBS1hDLEtBTFcsRUFNWFgsSUFOVyxFQU9YQyxPQVBXLEVBUVgsS0FSVyxFQVNYZixjQVRXLEVBVVhFLHFCQVZXLEVBV1h3QixzQkFYVyxFQVlYaEIsTUFaVyxFQWFYQyxJQWJXLEVBY1hDLElBZFcsRUFlWEMsY0FBYyxDQUFDaUIsR0FBZixDQUFtQkYsS0FBSyxJQUFJQSxLQUFLLENBQUNRLEtBQU4sQ0FBWSxHQUFaLEVBQWlCLENBQWpCLEVBQW9CLENBQXBCLENBQTVCLENBZlcsQ0FBYjtBQWlCRCxPQXJDRCxDQXFDRSxPQUFPakIsQ0FBUCxFQUFVO0FBQ1ZqQyxRQUFBQSxrQkFBa0IsQ0FBQ2tDLFdBQW5CLENBQStCRCxDQUEvQjtBQUNEO0FBQ0Y7O0FBN0M4RCxHQUFqRTtBQStDRCxDQTdGRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEdyYXBoUUxOb25OdWxsIH0gZnJvbSAnZ3JhcGhxbCc7XG5pbXBvcnQgZ2V0RmllbGROYW1lcyBmcm9tICdncmFwaHFsLWxpc3QtZmllbGRzJztcbmltcG9ydCAqIGFzIGRlZmF1bHRHcmFwaFFMVHlwZXMgZnJvbSAnLi9kZWZhdWx0R3JhcGhRTFR5cGVzJztcbmltcG9ydCAqIGFzIG9iamVjdHNRdWVyaWVzIGZyb20gJy4vb2JqZWN0c1F1ZXJpZXMnO1xuaW1wb3J0ICogYXMgcGFyc2VDbGFzc1R5cGVzIGZyb20gJy4vcGFyc2VDbGFzc1R5cGVzJztcblxuY29uc3QgbG9hZCA9IChwYXJzZUdyYXBoUUxTY2hlbWEsIHBhcnNlQ2xhc3MpID0+IHtcbiAgY29uc3QgY2xhc3NOYW1lID0gcGFyc2VDbGFzcy5jbGFzc05hbWU7XG5cbiAgY29uc3Qge1xuICAgIGNsYXNzR3JhcGhRTE91dHB1dFR5cGUsXG4gICAgY2xhc3NHcmFwaFFMRmluZEFyZ3MsXG4gICAgY2xhc3NHcmFwaFFMRmluZFJlc3VsdFR5cGUsXG4gIH0gPSBwYXJzZUdyYXBoUUxTY2hlbWEucGFyc2VDbGFzc1R5cGVzW2NsYXNzTmFtZV07XG5cbiAgY29uc3QgZ2V0R3JhcGhRTFF1ZXJ5TmFtZSA9IGBnZXQke2NsYXNzTmFtZX1gO1xuICBwYXJzZUdyYXBoUUxTY2hlbWEuZ3JhcGhRTE9iamVjdHNRdWVyaWVzW2dldEdyYXBoUUxRdWVyeU5hbWVdID0ge1xuICAgIGRlc2NyaXB0aW9uOiBgVGhlICR7Z2V0R3JhcGhRTFF1ZXJ5TmFtZX0gcXVlcnkgY2FuIGJlIHVzZWQgdG8gZ2V0IGFuIG9iamVjdCBvZiB0aGUgJHtjbGFzc05hbWV9IGNsYXNzIGJ5IGl0cyBpZC5gLFxuICAgIGFyZ3M6IHtcbiAgICAgIG9iamVjdElkOiBkZWZhdWx0R3JhcGhRTFR5cGVzLk9CSkVDVF9JRF9BVFQsXG4gICAgICByZWFkUHJlZmVyZW5jZTogZGVmYXVsdEdyYXBoUUxUeXBlcy5SRUFEX1BSRUZFUkVOQ0VfQVRULFxuICAgICAgaW5jbHVkZVJlYWRQcmVmZXJlbmNlOiBkZWZhdWx0R3JhcGhRTFR5cGVzLklOQ0xVREVfUkVBRF9QUkVGRVJFTkNFX0FUVCxcbiAgICB9LFxuICAgIHR5cGU6IG5ldyBHcmFwaFFMTm9uTnVsbChjbGFzc0dyYXBoUUxPdXRwdXRUeXBlKSxcbiAgICBhc3luYyByZXNvbHZlKF9zb3VyY2UsIGFyZ3MsIGNvbnRleHQsIHF1ZXJ5SW5mbykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgeyBvYmplY3RJZCwgcmVhZFByZWZlcmVuY2UsIGluY2x1ZGVSZWFkUHJlZmVyZW5jZSB9ID0gYXJncztcbiAgICAgICAgY29uc3QgeyBjb25maWcsIGF1dGgsIGluZm8gfSA9IGNvbnRleHQ7XG4gICAgICAgIGNvbnN0IHNlbGVjdGVkRmllbGRzID0gZ2V0RmllbGROYW1lcyhxdWVyeUluZm8pO1xuXG4gICAgICAgIGNvbnN0IHsga2V5cywgaW5jbHVkZSB9ID0gcGFyc2VDbGFzc1R5cGVzLmV4dHJhY3RLZXlzQW5kSW5jbHVkZShcbiAgICAgICAgICBzZWxlY3RlZEZpZWxkc1xuICAgICAgICApO1xuXG4gICAgICAgIHJldHVybiBhd2FpdCBvYmplY3RzUXVlcmllcy5nZXRPYmplY3QoXG4gICAgICAgICAgY2xhc3NOYW1lLFxuICAgICAgICAgIG9iamVjdElkLFxuICAgICAgICAgIGtleXMsXG4gICAgICAgICAgaW5jbHVkZSxcbiAgICAgICAgICByZWFkUHJlZmVyZW5jZSxcbiAgICAgICAgICBpbmNsdWRlUmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgY29uZmlnLFxuICAgICAgICAgIGF1dGgsXG4gICAgICAgICAgaW5mb1xuICAgICAgICApO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBwYXJzZUdyYXBoUUxTY2hlbWEuaGFuZGxlRXJyb3IoZSk7XG4gICAgICB9XG4gICAgfSxcbiAgfTtcblxuICBjb25zdCBmaW5kR3JhcGhRTFF1ZXJ5TmFtZSA9IGBmaW5kJHtjbGFzc05hbWV9YDtcbiAgcGFyc2VHcmFwaFFMU2NoZW1hLmdyYXBoUUxPYmplY3RzUXVlcmllc1tmaW5kR3JhcGhRTFF1ZXJ5TmFtZV0gPSB7XG4gICAgZGVzY3JpcHRpb246IGBUaGUgJHtmaW5kR3JhcGhRTFF1ZXJ5TmFtZX0gcXVlcnkgY2FuIGJlIHVzZWQgdG8gZmluZCBvYmplY3RzIG9mIHRoZSAke2NsYXNzTmFtZX0gY2xhc3MuYCxcbiAgICBhcmdzOiBjbGFzc0dyYXBoUUxGaW5kQXJncyxcbiAgICB0eXBlOiBuZXcgR3JhcGhRTE5vbk51bGwoY2xhc3NHcmFwaFFMRmluZFJlc3VsdFR5cGUpLFxuICAgIGFzeW5jIHJlc29sdmUoX3NvdXJjZSwgYXJncywgY29udGV4dCwgcXVlcnlJbmZvKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB7XG4gICAgICAgICAgd2hlcmUsXG4gICAgICAgICAgb3JkZXIsXG4gICAgICAgICAgc2tpcCxcbiAgICAgICAgICBsaW1pdCxcbiAgICAgICAgICByZWFkUHJlZmVyZW5jZSxcbiAgICAgICAgICBpbmNsdWRlUmVhZFByZWZlcmVuY2UsXG4gICAgICAgICAgc3VicXVlcnlSZWFkUHJlZmVyZW5jZSxcbiAgICAgICAgfSA9IGFyZ3M7XG4gICAgICAgIGNvbnN0IHsgY29uZmlnLCBhdXRoLCBpbmZvIH0gPSBjb250ZXh0O1xuICAgICAgICBjb25zdCBzZWxlY3RlZEZpZWxkcyA9IGdldEZpZWxkTmFtZXMocXVlcnlJbmZvKTtcblxuICAgICAgICBjb25zdCB7IGtleXMsIGluY2x1ZGUgfSA9IHBhcnNlQ2xhc3NUeXBlcy5leHRyYWN0S2V5c0FuZEluY2x1ZGUoXG4gICAgICAgICAgc2VsZWN0ZWRGaWVsZHNcbiAgICAgICAgICAgIC5maWx0ZXIoZmllbGQgPT4gZmllbGQuaW5jbHVkZXMoJy4nKSlcbiAgICAgICAgICAgIC5tYXAoZmllbGQgPT4gZmllbGQuc2xpY2UoZmllbGQuaW5kZXhPZignLicpICsgMSkpXG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IHBhcnNlT3JkZXIgPSBvcmRlciAmJiBvcmRlci5qb2luKCcsJyk7XG5cbiAgICAgICAgcmV0dXJuIGF3YWl0IG9iamVjdHNRdWVyaWVzLmZpbmRPYmplY3RzKFxuICAgICAgICAgIGNsYXNzTmFtZSxcbiAgICAgICAgICB3aGVyZSxcbiAgICAgICAgICBwYXJzZU9yZGVyLFxuICAgICAgICAgIHNraXAsXG4gICAgICAgICAgbGltaXQsXG4gICAgICAgICAga2V5cyxcbiAgICAgICAgICBpbmNsdWRlLFxuICAgICAgICAgIGZhbHNlLFxuICAgICAgICAgIHJlYWRQcmVmZXJlbmNlLFxuICAgICAgICAgIGluY2x1ZGVSZWFkUHJlZmVyZW5jZSxcbiAgICAgICAgICBzdWJxdWVyeVJlYWRQcmVmZXJlbmNlLFxuICAgICAgICAgIGNvbmZpZyxcbiAgICAgICAgICBhdXRoLFxuICAgICAgICAgIGluZm8sXG4gICAgICAgICAgc2VsZWN0ZWRGaWVsZHMubWFwKGZpZWxkID0+IGZpZWxkLnNwbGl0KCcuJywgMSlbMF0pXG4gICAgICAgICk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIHBhcnNlR3JhcGhRTFNjaGVtYS5oYW5kbGVFcnJvcihlKTtcbiAgICAgIH1cbiAgICB9LFxuICB9O1xufTtcblxuZXhwb3J0IHsgbG9hZCB9O1xuIl19